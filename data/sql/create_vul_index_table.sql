CREATE TABLE session_id_e44_s_33_a24
(
  gid serial NOT NULL,
  e_value double precision,
  s_value double precision,
  a_value double precision,
  vul_index_raw  double precision,
  vul_index_custom  double precision,
  geom geometry(MultiPolygon),
  CONSTRAINT session_id_e44_s_33_a24_pkey PRIMARY KEY (gid)
)
WITH (
  OIDS=FALSE
);



INSERT INTO session_id_e44_s_33_a24 (gid, e_value,  s_value, a_value, vul_index_raw, vul_index_custom, geom) 
Select  e.gid, e.value,s.value, a.value, 
	((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23)) as vul_index_raw, 
0, e.geom
FROM exposure e
LEFT OUTER JOIN sensitivity s ON (e.gid = s.gid)
LEFT OUTER JOIN adaptive_capacity a ON (e.gid = a.gid)

GROUP BY e.gid,s.value, a.value
ORDER BY e.gid;


UPDATE session_id_e44_s33_a24 
SET vul_index_custom= 
	(SELECT 
		(case when 
			(
					vul_index_raw - 
				(
					select min(vul_index_raw) from session_id_e44_s33_a24
				) 
			) <> 0 
		then 
		( 
			( 
				( 
					vul_index_raw - 
					(select min(vul_index_raw) from session_id_e44_s33_a24  where vul_index_raw >= 0) 
				)/
				( 
					(select max(vul_index_raw) from session_id_e44_s33_a24  where vul_index_raw >= 0) - 
					(select min(vul_index_raw) from session_id_e44_s33_a24  where vul_index_raw >= 0) 
				) 
			)* 100 
		) 
		when vul_index_raw < 0
		then
			-9999
		else
		  0
		end 
		)
	);


















SELECT vul_index_raw, (case when 
	(vul_index_raw - (select min(vul_index_raw) from session_id_e44_s_33_a23) ) <> 0 
	then ( ( ( vul_index_raw - (select min(vul_index_raw) from session_id_e44_s_33_a23  where vul_index_raw >= 0) )/( (select max(vul_index_raw) from session_id_e44_s_33_a23  where vul_index_raw >= 0) - (select min(vul_index_raw) from session_id_e44_s_33_a23  where vul_index_raw >= 0) ) )* 100 ) 
	else
	  0
	end )  AS vi_custom FROM session_id_e44_s_33_a23 GROUP BY session_id_e44_s_33_a23.vul_index_raw


select vul_index_raw, (vul_index_raw - (select min(vul_index_raw) from session_id_e44_s_33_a23 where vul_index_raw >= 0) )as diff from session_id_e44_s_33_a23 group by gid


	
Select  e.gid, e.value,s.value, a.value, 
	((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23)) as vul_index_raw, 
	(case when 
	     (((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23)) - min(((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23))) ) <> 0 
	     then ( (((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23)) - min(((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23))) )/( max(((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23))) - min(((e.value*0.44)+ (s.value*0.33)+ (a.value*0.23))) ) * 100 ) 
	else
	  0
	end) AS vul_index_custom 	
FROM exposure e
LEFT OUTER JOIN sensitivity s ON (e.gid = s.gid)
LEFT OUTER JOIN adaptive_capacity a ON (e.gid = a.gid)
where e.gid < 12 and e.gid > 8
GROUP BY e.gid,s.value, a.value
ORDER BY e.gid