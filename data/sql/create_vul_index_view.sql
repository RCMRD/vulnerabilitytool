DROP VIEW session_id_e33_s44_a23_c;
DROP VIEW session_id_e33_s44_a23_b;
DROP VIEW session_id_e33_s44_a23;

CREATE OR REPLACE VIEW session_id_e33_s44_a23 AS
  SELECT e.gid, e.exposure AS exposure, s.sensitivity AS sensitivity,
                a.lackadpcap AS lack_of_adaptive_capacity,
                e.exposure * 0.44 + s.sensitivity * 0.33 + a.lackadpcap * 0.23 AS vul_index_raw,
    e.geom
  FROM malawi_national_exposure e
    LEFT JOIN malawi_national_sensitivity s ON e.gid = s.gid
    LEFT JOIN malawi_national_lackadapcap a ON e.gid = a.gid
  GROUP BY e.gid, s.sensitivity, a.lackadpcap;


CREATE OR REPLACE VIEW session_id_e33_s44_a23_b AS
Select *, 
(SELECT 
		(case when 
			(
					vul_index_raw - 
				(
					select min(vul_index_raw) from session_id_e33_s44_a23
				) 
			) <> 0 
		then 
		( 
			( 
				( 
					vul_index_raw - 
					(select min(vul_index_raw) from session_id_e33_s44_a23  where vul_index_raw >= 0) 
				)/
				( 
					(select max(vul_index_raw) from session_id_e33_s44_a23  where vul_index_raw >= 0) - 
					(select min(vul_index_raw) from session_id_e33_s44_a23  where vul_index_raw >= 0) 
				) 
			)* 100 
		) 
		when vul_index_raw < 0
		then
			-9999
		else
		  0
		end 
		)
	) AS vul_index_custom
	
from session_id_e33_s44_a23
group by session_id_e33_s44_a23.gid, session_id_e33_s44_a23.vul_index_raw,  session_id_e33_s44_a23.exposure, session_id_e33_s44_a23.sensitivity, session_id_e33_s44_a23.lack_of_adaptive_capacity, session_id_e33_s44_a23.geom
order by session_id_e33_s44_a23.gid;

CREATE OR REPLACE VIEW session_id_e33_s44_a23_c AS
Select gid, vul_index_custom,
  (CASE 
	WHEN vul_index_custom >= 0
       then (
		case 
			when ntile(5) over (order by vul_index_custom)= 1 then 'Very Low' 
			when ntile(5) over (order by vul_index_custom)= 2 then 'Low' 
			when ntile(5) over (order by vul_index_custom)= 3 then 'Medium' 
			when ntile(5) over (order by vul_index_custom)= 4 then 'High' 
			when ntile(5) over (order by vul_index_custom)= 5 then 'Very High' 

		End) 
	 WHEN vul_index_custom < 0 THEN '-9999'	
        end) as category,  geom
from session_id_e33_s44_a23_b
order by gid;




CREATE OR REPLACE VIEW session_id_e33_s44_a23 AS
  SELECT e.gid, e.value AS exposure, s.value AS sensitivity,
                a.value AS lack_of_adaptive_capacity,
                e.value * 0.44 + s.value * 0.33 + a.value * 0.23 AS vul_index_raw,
    e.geom
  FROM exposure e
    LEFT JOIN sensitivity s ON e.gid = s.gid
    LEFT JOIN adaptive_capacity a ON e.gid = a.gid
  GROUP BY e.gid, s.value, a.value;


CREATE OR REPLACE VIEW session_id_e33_s44_a23_b AS
Select *, 
(SELECT 
		(case when 
			(
					vul_index_raw - 
				(
					select min(vul_index_raw) from session_id_e33_s44_a23
				) 
			) <> 0 
		then 
		( 
			( 
				( 
					vul_index_raw - 
					(select min(vul_index_raw) from session_id_e33_s44_a23  where vul_index_raw >= 0) 
				)/
				( 
					(select max(vul_index_raw) from session_id_e33_s44_a23  where vul_index_raw >= 0) - 
					(select min(vul_index_raw) from session_id_e33_s44_a23  where vul_index_raw >= 0) 
				) 
			)* 100 
		) 
		when vul_index_raw < 0
		then
			-9999
		else
		  0
		end 
		)
	) AS vul_index_custom
	
from session_id_e33_s44_a23
group by session_id_e33_s44_a23.gid, session_id_e33_s44_a23.vul_index_raw,  session_id_e33_s44_a23.exposure, session_id_e33_s44_a23.sensitivity, session_id_e33_s44_a23.lack_of_adaptive_capacity, session_id_e33_s44_a23.geom
order by session_id_e33_s44_a23.gid;

CREATE OR REPLACE VIEW session_id_e33_s44_a23_c AS
Select *, 
(select 
  (CASE 
    WHEN vul_index_custom < 0 THEN '-9999'
    WHEN vul_index_custom < 20 THEN 'Very Low'
    WHEN vul_index_custom < 40 THEN 'Low'
    WHEN vul_index_custom < 60 THEN 'Medum'
    WHEN vul_index_custom < 80 THEN 'High'
   WHEN vul_index_custom <= 100 THEN 'Very High'
  END)
  ) as category

from session_id_e33_s44_a23_b
group by session_id_e33_s44_a23_b.gid, session_id_e33_s44_a23_b.vul_index_custom, session_id_e33_s44_a23_b.vul_index_raw,  session_id_e33_s44_a23_b.exposure, session_id_e33_s44_a23_b.sensitivity, session_id_e33_s44_a23_b.lack_of_adaptive_capacity, session_id_e33_s44_a23_b.geom
order by session_id_e33_s44_a23_b.gid;





select gid, vul_index_custom, geom, 
       (case when vul_index_custom >= 0
       then ntile(5) over (order by vul_index_custom) 
        end) as category
from session_id_e33_s44_a23_b order by gid; 




select cume, max(overall_vu) AS max_var from 
   (
	   select overall_vu, ntile(5) over (order by overall_vu) as cume
	   from vulnerability_index
   ) as tmp
group by cume
order by cume;