<?php
require_once("SessionStarter.php");
include "../geoserver/GeoserverWrapper.php";
require_once('DBConnection.class.php');
require_once ('../../Config.php');

/**
 * CreateView class creates view in the databased based on user input
 */
class CreateVIView {
    protected $db;
/*
 * defineViewNames creates view names to be used by this script. It depends on user session and the weights.
 */
    public function defineViewNames($exposure, $sensitivity, $adaptive_capacity, $class_type, $adminLevel){
        $session_id= session_id();
        $exposureStr = str_replace('0.', '', $exposure);
        $sensitivityStr = str_replace('0.', '', $sensitivity);
        $adaptiveCapacityStr = str_replace('0.', '', $adaptive_capacity);
        return 'v'.$session_id.'_'.$adminLevel.'_'.strtolower($class_type[0]).'_e'.$exposureStr.'_s'.$sensitivityStr.'_a'.$adaptiveCapacityStr;
    }
    public function createView($exposure, $sensitivity, $adaptive_capacity, $class_type, $adminLevel){
        $db = dbConn::getConnection();
        $finalView = $this->defineViewNames($exposure, $sensitivity, $adaptive_capacity, $class_type, $adminLevel);
        $rawView2 = $finalView.'_1';
        $rawView =  $rawView2.'2';
        $range_param = "";
        if ($class_type=="Equalinterval") {
            $range_param = "(SELECT (CASE
                            WHEN vul_index_custom < 0 THEN '-9999'
                            WHEN vul_index_custom < 20 THEN 'Very Low'
                            WHEN vul_index_custom < 40 THEN 'Low'
                            WHEN vul_index_custom < 60 THEN 'Medium'
                            WHEN vul_index_custom < 80 THEN 'High'
                            WHEN vul_index_custom <= 100 THEN 'Very High'
                             END)
                             )";
        }
        else if ($class_type=="Quantile"){
            $range_param = " (CASE
                WHEN vul_index_custom >= 0
                   THEN (
                        CASE
                            when ntile(5) over (order by vul_index_custom)= 1 then 'Very Low'
                            when ntile(5) over (order by vul_index_custom)= 2 then 'Low'
                            when ntile(5) over (order by vul_index_custom)= 3 then 'Medium'
                            when ntile(5) over (order by vul_index_custom)= 4 then 'High'
                            when ntile(5) over (order by vul_index_custom)= 5 then 'Very High'
                        END)
                WHEN vul_index_custom < 0 THEN '-9999'
            END)";
        }

        $createQuery ='CREATE OR REPLACE VIEW '. $rawView.' AS
              SELECT e.gid, e.exposure AS exposure, s.sensitivity AS sensitivity,
                a.lackadapcap AS lack_of_adaptive_capacity,
                e.exposure * '.$exposure.' + s.sensitivity *'.$sensitivity.'  + a.lackadapcap * '.$adaptive_capacity.' AS vul_index_raw,
                 e.geom
              FROM malawi_'.$adminLevel.'_exposure e
                LEFT JOIN malawi_'.$adminLevel.'_sensitivity s ON e.gid = s.gid
                LEFT JOIN malawi_'.$adminLevel.'_lackadapcap a ON e.gid = a.gid
              GROUP BY e.gid, s.sensitivity, a.lackadapcap;';
        $createQuery .='CREATE OR REPLACE VIEW '.$rawView2.' AS
             SELECT '.$rawView.'.gid, '.$rawView.'.exposure,
                '.$rawView.'.sensitivity,
                '.$rawView.'.lack_of_adaptive_capacity,
                '.$rawView.'.vul_index_raw, '.$rawView.'.geom,
                ( SELECT
                            CASE
                                WHEN ('.$rawView.'.vul_index_raw - (( SELECT min('.$rawView.'.vul_index_raw) AS min
                                   FROM '.$rawView.'))) <> 0 THEN ('.$rawView.'.vul_index_raw - (( SELECT min('.$rawView.'.vul_index_raw) AS min
                                   FROM '.$rawView.'
                                  WHERE '.$rawView.'.vul_index_raw >= 0))) / ((( SELECT max('.$rawView.'.vul_index_raw) AS max
                                   FROM '.$rawView.'
                                  WHERE '.$rawView.'.vul_index_raw >= 0)) - (( SELECT min('.$rawView.'.vul_index_raw) AS min
                                   FROM '.$rawView.'
                                  WHERE '.$rawView.'.vul_index_raw >= 0))) * 100
                                WHEN '.$rawView.'.vul_index_raw < 0 THEN (-9999)
                                ELSE 0
                            END AS "case") AS vul_index_custom
               FROM '.$rawView.'
              GROUP BY '.$rawView.'.gid, '.$rawView.'.vul_index_raw, '.$rawView.'.exposure, '.$rawView.'.sensitivity, '.$rawView.'.lack_of_adaptive_capacity, '.$rawView.'.geom
              ORDER BY '.$rawView.'.gid;';
        $createQuery .= "CREATE OR REPLACE VIEW ". $finalView." AS
                            SELECT ".$rawView2." .gid, vul_index_custom, ".
                                    $range_param."

                               as category, geom

                            from  ".$rawView2."
                            order by gid;";
       // echo $createQuery;
        $db->exec($createQuery);
        //pg_close($db_connection);
    }
}

/**
 * Class Publish GeoserverLayer publishes a postgis store and  layer using
 * user's session id and components value as name.
 */
class PublishGeoserverLayer {
    public $layerName;
    function publishLayer($exposure, $sensitivity, $adaptiveCapacity, $class_type, $adminLevel) {

        $config = new Config();

        $createView = new  CreateVIView();

        $store_name =  $createView->defineViewNames($exposure, $sensitivity, $adaptiveCapacity, $class_type, $adminLevel);

        $geoserver = new GeoserverWrapper($config->geoserverUrl, $config->geoserverUsername, $config->geoserverPassword);
        $geoserver->createPostGISDataStore($store_name, 'malawi_vulnerabilitytool', $config->pgsqlDb,
            $config->pgsqlUser, $config->pgsqlPassword, $config->extPgsqlHost, $config->pgsqlPort, $config->geoserverUrl);
        $geoserver->createLayer( $store_name, 'malawi_vulnerabilitytool', $store_name, 'User generated Vulnerability Index Layer');
        $geoserver->addStyleToLayer($store_name,'malawi_vulnerabilitytool',  'default_vulnerabilitytool');

        $this->layerName=$store_name;
        echo $this->layerName;
    }
}




?>