Ext.define('VulnerabilityToolAddPhoto.view.photo.AddPhoto', {
    extend: 'Ext.window.Window',
    alias : 'widget.addPhoto',
    title : 'Upload Photo',
    layout: 'fit',
    autoShow: true,

    initComponent: function() {
        this.items = [
            {
                xtype: 'form',
                id:'add_photo_form_id',
                items: [
                    {
                        xtype: 'textfield',
                        name : 'name',
                        allowBlank: false,
                        fieldLabel: 'Location'
                    },
                    {
                        xtype: 'textfield',
                        name : 'description',
                        allowBlank: false,
                        fieldLabel: 'Description'
                    },
                    {
                        xtype: 'numberfield',
                        name: 'longitude',
                        fieldLabel: 'Longitude',
                        allowBlank: false,
                        decimalPrecision: 6,
                        maxValue: 50,
                        minValue: -20
                    },
                    {
                        xtype: 'numberfield',
                        name: 'latitude',
                        fieldLabel: 'Latitude',
                        allowBlank: false,
                        decimalPrecision: 6,
                        maxValue: 50,
                        minValue: -20
                    },
                    {
                        xtype: 'datefield',
                        name: 'date',
                        allowBlank: false,
                        fieldLabel: 'Collection Date',
                        dateFormat:'Y-m-d',
                        format:'Y-m-d'

                    },

                    Ext.widget('form', {
                        id: 'upload_form_id',
                        html: '<div class="panelCont">Only images of png, jpg, and jpeg are allowed. Maximum file size allowed is 150 kbs. ' +
                        'Reduce image width and height to 800x600 pixels resolution. Optimize the images using image ' +
                        'editing software to reduce size.</div>',
                        items: [
                            {
                            xtype: 'filefield',
                            name: 'file',
                            fieldLabel: 'File',

                            regex: /(.)+((\.png)|(\.jpg)|(\.jpeg)(\w)?)$/i,
                            regexText: 'Only PNG, JPG and JPEG image formats are accepted',
                            anchor: '100%',

                            buttonText: 'Browse Image...'
                        },
                            {
                                buttons: [{
                                    text: 'Upload',
                                    //action: 'save',
                                    handler: function () {
                                        var form = this.up('form').getForm();
                                        if (form.isValid()) {
                                            form.submit({
                                                url: 'data/Upload.php',
                                                waitMsg: 'Uploading your file...',
                                                success: function (f, a) {
                                                    var result = a.result;
                                                    var message = result.data.msg;
                                                    var fileName = result.data.name;
                                                    Ext.Msg.alert('Success', message);
                                                    Ext.getCmp("photo_id").setValue(fileName);
                                                },
                                                failure: function (f, a) {
                                                    Ext.Msg.alert('Failure', a.result.msg);
                                                }
                                            });
                                        }
                                    }
                                }]
                            }

                        ]
                    }),
                    {
                        xtype: 'hiddenfield',
                        id:'photo_id',
                        allowBlank: false,
                        name: 'photo'
                    }

                ]
            }
        ];


        this.buttons = [

            {
                xtype: 'button',
                id:'add_logout_id',
                text: 'Logout',
                handler: function() {

                    Ext.Ajax.request({
                        method: 'POST',
                        url: 'data/logout.php',
                        success: function (result) {
                            var logout = result.responseText;

                            //console.log(result.responseText);
                            if (logout == 'logout') {
                                window.location = "../index.html";
                            }
                        }
                    });

                }
            },
            '->',

            {
                text: 'Save',
                handler: function (){

                    var form = Ext.getCmp("add_photo_form_id").getForm();
                    if (form.isValid()) {
                        form.submit({
                            url: 'data/createPhoto.php',
                            waitMsg: 'Please wait...',
                            success: function (f, a) {
                                form.reset();
                                console.log(form.getForm().getValues());
                            },
                            failure: function (f, a) {
                                console.log(form.getForm().getValues());
                                Ext.Msg.alert('Failure', "Something went wrong.");
                            }
                        });
                    }
                }
            },
            {
                text: 'Cancel',
                scope: this,
                handler: this.close
            }
        ];
        this.callParent(arguments);
    }
});
