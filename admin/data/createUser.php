<?php

/* 
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
require_once("include/SessionStarter.php");
require_once 'lib/response.php';
require_once 'lib/request.php';


class User
{
    var $userID;
    var $username;
    var $password;
    var $group;
}
require_once('../../data/include/DBConnection.class.php');
$db = dbConn::getConnection();

$request = new Request(array());

if(isset($request->params))
{

    $array_r=$request->params;
    $user= new User();
    //$user->userID=($array_r->userID);
    $user->username=($array_r->username);
    $user->password=($array_r->password);
    $user->group=($array_r->group);

    //Check username if it is already taken
    $checkUsername =  $db->query("SELECT username FROM users WHERE username = ' $user->username'");
    if (count($checkUsername->fetch(PDO::FETCH_ASSOC)) > 0){
        $res = new Response();
        $res->success = "duplicate";
        $res->message = "Duplicate User Exists in the database. Try a different Username.";
        $res->data = array();
        print_r($res->to_json());
    }
    else {
        //update
        $query="INSERT INTO users (username, password, user_group) VALUES ('$user->username','$user->password','$user->group')";
        $result = $db->query($query);
        //object response
        $res = new Response();
        $res->success = true;
        $res->message = "Created Record";


        //Need to Send USER to EXTjs to be correctly viewd in grid
        $result =  $db->query("SELECT * FROM users where user_id =".$db->lastInsertId('users_user_id_seq'));
        $query_array=array();
        $i=0;
        //Iterate all Select
        while($row =  $result->fetch(PDO::FETCH_ASSOC))
        {
            //Create New User instance
            $user = new User();
            //Fetch User Info
            $user->userID=$row['user_id'];
            $user->username=$row['username'];
            $user->password=$row['password'];
            $user->group=$row['user_group'];

            //Add User to ARRAY
            $query_array[$i]=$user;
            $i++;
        }
        $res->data = $query_array;
        //print Json
        print_r($res->to_json());
    }
}
else
{
    //echo "false";
    $res = new Response();
    $res->success = false;
    $res->message = "Error Create record";
    $res->data = array();
    print_r($res->to_json());
}
?>
