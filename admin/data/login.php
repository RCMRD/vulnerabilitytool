<?php
require_once("include/SessionStarter.php");

$_SESSION['site_folder'] = dirname(dirname(dirname(__FILE__) ) );

require_once ($_SESSION['site_folder'] .'/data/include/DBConnection.class.php');

if($_POST && isset($_POST['username']) && isset($_POST['password'])){
    $db = dbConn::getConnection();
    $stmt = $db->prepare("SELECT * FROM users WHERE username = ? AND password = ?");
    $rows = $stmt->execute(array($_POST['username'], $_POST['password']));
    $results = $stmt->fetchAll( PDO::FETCH_ASSOC );

    if ( count($results) > 0) {
        if ($results[0]['user_group'] == 'Admin') {
            if(!isset($_SESSION)){session_start();}
            $_SESSION['group'] = $results[0]['user_group'];
            $_SESSION['user'] = $results[0]['username'];
            $response = array('success' => true,
                'data' => array('group' => 'Admin')
            );
            echo json_encode($response);

            // header("Location: ../administer.php");
        } elseif ($results[0]['user_group'] == 'User') {
            if(!isset($_SESSION)){session_start();}
            $_SESSION['group'] = $results[0]['user_group'];
            $_SESSION['user'] = $results[0]['username'];
            $response = array('success' => true,
                'data' => array('group' => 'User')
            );
            echo json_encode($response);

            //header("Location: ../addPhoto.php");
        } else {
            $response = array('success' => false,
                'data' => array('group' => 'Guest')
            );
            echo json_encode($response);
        }
    }
}
else {
    $response = array('success' => false,
        'data' => array('group' => 'Guest')
    );
    echo json_encode($response);
}

//
//if($_SERVER['REQUEST_METHOD']=='POST'){
//    $uname = $_POST['username'];
//    $pw = $_POST['password'];
//    $uname=htmlspecialchars($uname);
//    $pw=htmlspecialchars($pw);
//    $db_found=(mysqli_select_db($con, $db_name));
//    if($db_found){
//        $uname=quote_smart($con, $uname);
//        $pw=quote_smart($con, $pw);
//
//        $query= "SELECT * FROM users WHERE username = $uname AND password = $pw";
//        $result=mysqli_query($con, $q);
//        $num_rows=mysqli_num_rows($result);
//        if ($result) {
//            if($num_rows > 0) {
//                header("Location: add-data.php");
//
//                session_start();
//                echo '<META http-equiv="refresh" content="0;URL=add-data.php">';
//
//
//                $_SESSION['users']=$uname;
//                /*  $_SESSION['firstname']=$fname;
//                  $_SESSION['lastname']=$lname;
//                  $_SESSION['depart']=$dep;
//                  $_SESSION['position']=$pos;
//                  $_SESSION['username']=$uname;*/
//                $_SESSION['password']=$pw;
//                /* $_SESSION['email']=$email;
//                 */
//            }
//            else {
//                $errorMessage = 'The username or password is incorrect.';
//
//            }
//        }
//        else {
//            $errorMessage = "The request failed due to database connection error.";
//        }
//
//    }
//    else {
//        mysqli_close($con);
//        $errorMessage="Error Finding the database.";
//    }
//}


?>