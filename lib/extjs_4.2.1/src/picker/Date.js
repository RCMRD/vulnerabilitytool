Ext.define("Ext.picker.Date",{extend:"Ext.Component",requires:["Ext.XTemplate","Ext.button.Button","Ext.button.Split","Ext.util.ClickRepeater","Ext.util.KeyNav","Ext.EventObject","Ext.fx.Manager","Ext.picker.Month"],alias:"widget.datepicker",alternateClassName:"Ext.DatePicker",childEls:["innerEl","eventEl","prevEl","nextEl","middleBtnEl","footerEl"],border:!0,renderTpl:['<div id="{id}-innerEl" role="grid">','<div role="presentation" class="{baseCls}-header">','<a id="{id}-prevEl" class="{baseCls}-prev {baseCls}-arrow" href="#" role="button" title="{prevText}" hidefocus="on" ><\/a>','<div class="{baseCls}-month" id="{id}-middleBtnEl">{%this.renderMonthBtn(values, out)%}<\/div>','<a id="{id}-nextEl" class="{baseCls}-next {baseCls}-arrow" href="#" role="button" title="{nextText}" hidefocus="on" ><\/a>',"<\/div>",'<table id="{id}-eventEl" class="{baseCls}-inner" cellspacing="0" role="grid">','<thead role="presentation"><tr role="row">','<tpl for="dayNames">','<th role="columnheader" class="{parent.baseCls}-column-header" title="{.}">','<div class="{parent.baseCls}-column-header-inner">{.:this.firstInitial}<\/div>',"<\/th>","<\/tpl>","<\/tr><\/thead>",'<tbody role="presentation"><tr role="row">','<tpl for="days">',"{#:this.isEndOfWeek}",'<td role="gridcell" id="{[Ext.id()]}">','<a role="presentation" hidefocus="on" class="{parent.baseCls}-date" href="#"><\/a>',"<\/td>","<\/tpl>","<\/tr><\/tbody>","<\/table>",'<tpl if="showToday">','<div id="{id}-footerEl" role="presentation" class="{baseCls}-footer">{%this.renderTodayBtn(values, out)%}<\/div>',"<\/tpl>","<\/div>",{firstInitial:function(n){return Ext.picker.Date.prototype.getDayInitial(n)},isEndOfWeek:function(n){n--;var t=n%7==0&&n!==0;return t?'<\/tr><tr role="row">':""},renderTodayBtn:function(n,t){Ext.DomHelper.generateMarkup(n.$comp.todayBtn.getRenderTree(),t)},renderMonthBtn:function(n,t){Ext.DomHelper.generateMarkup(n.$comp.monthBtn.getRenderTree(),t)}}],todayText:"Today",ariaTitle:"Date Picker: {0}",ariaTitleDateFormat:"F d, Y",todayTip:"{0} (Spacebar)",minText:"This date is before the minimum date",maxText:"This date is after the maximum date",disabledDaysText:"Disabled",disabledDatesText:"Disabled",nextText:"Next Month (Control+Right)",prevText:"Previous Month (Control+Left)",monthYearText:"Choose a month (Control+Up/Down to move years)",monthYearFormat:"F Y",startDay:0,showToday:!0,disableAnim:!1,baseCls:Ext.baseCSSPrefix+"datepicker",longDayFormat:"F d, Y",focusOnShow:!1,focusOnSelect:!0,initHour:12,numDays:42,initComponent:function(){var n=this,t=Ext.Date.clearTime;n.selectedCls=n.baseCls+"-selected";n.disabledCellCls=n.baseCls+"-disabled";n.prevCls=n.baseCls+"-prevday";n.activeCls=n.baseCls+"-active";n.cellCls=n.baseCls+"-cell";n.nextCls=n.baseCls+"-prevday";n.todayCls=n.baseCls+"-today";n.format||(n.format=Ext.Date.defaultFormat);n.dayNames||(n.dayNames=Ext.Date.dayNames);n.dayNames=n.dayNames.slice(n.startDay).concat(n.dayNames.slice(0,n.startDay));n.callParent();n.value=n.value?t(n.value,!0):t(new Date);n.addEvents("select");n.initDisabledDays()},beforeRender:function(){var n=this,i=new Array(n.numDays),t=Ext.Date.format(new Date,n.format);n.up("menu")&&n.addCls(Ext.baseCSSPrefix+"menu");n.monthBtn=new Ext.button.Split({ownerCt:n,ownerLayout:n.getComponentLayout(),text:"",tooltip:n.monthYearText,listeners:{click:n.showMonthPicker,arrowclick:n.showMonthPicker,scope:n}});n.showToday&&(n.todayBtn=new Ext.button.Button({ownerCt:n,ownerLayout:n.getComponentLayout(),text:Ext.String.format(n.todayText,t),tooltip:Ext.String.format(n.todayTip,t),tooltipType:"title",handler:n.selectToday,scope:n}));n.callParent();Ext.applyIf(n,{renderData:{}});Ext.apply(n.renderData,{dayNames:n.dayNames,showToday:n.showToday,prevText:n.prevText,nextText:n.nextText,days:i});n.protoEl.unselectable()},finishRenderChildren:function(){var n=this;n.callParent();n.monthBtn.finishRender();n.showToday&&n.todayBtn.finishRender()},onRender:function(){var n=this;n.callParent(arguments);n.cells=n.eventEl.select("tbody td");n.textNodes=n.eventEl.query("tbody td a");n.mon(n.eventEl,{scope:n,mousewheel:n.handleMouseWheel,click:{fn:n.handleDateClick,delegate:"a."+n.baseCls+"-date"}})},initEvents:function(){var n=this,t=Ext.Date,i=t.DAY;n.callParent();n.prevRepeater=new Ext.util.ClickRepeater(n.prevEl,{handler:n.showPrevMonth,scope:n,preventDefault:!0,stopDefault:!0});n.nextRepeater=new Ext.util.ClickRepeater(n.nextEl,{handler:n.showNextMonth,scope:n,preventDefault:!0,stopDefault:!0});n.keyNav=new Ext.util.KeyNav(n.eventEl,Ext.apply({scope:n,left:function(r){r.ctrlKey?n.showPrevMonth():n.update(t.add(n.activeDate,i,-1))},right:function(r){r.ctrlKey?n.showNextMonth():n.update(t.add(n.activeDate,i,1))},up:function(r){r.ctrlKey?n.showNextYear():n.update(t.add(n.activeDate,i,-7))},down:function(r){r.ctrlKey?n.showPrevYear():n.update(t.add(n.activeDate,i,7))},pageUp:function(t){t.altKey?n.showPrevYear():n.showPrevMonth()},pageDown:function(t){t.altKey?n.showNextYear():n.showNextMonth()},tab:function(t){return n.doCancelFieldFocus=!0,n.handleTabClick(t),delete n.doCancelFieldFocus,!0},enter:function(n){return n.stopPropagation(),!0},home:function(){n.update(t.getFirstDateOfMonth(n.activeDate))},end:function(){n.update(t.getLastDateOfMonth(n.activeDate))}},n.keyNavConfig));n.showToday&&(n.todayKeyListener=n.eventEl.addKeyListener(Ext.EventObject.SPACE,n.selectToday,n));n.update(n.value)},handleTabClick:function(){var n=this,t=n.getSelectedDate(n.activeDate),i=n.handler;n.disabled||!t.dateValue||Ext.fly(t.parentNode).hasCls(n.disabledCellCls)||(n.doCancelFocus=n.focusOnSelect===!1,n.setValue(new Date(t.dateValue)),delete n.doCancelFocus,n.fireEvent("select",n,n.value),i&&i.call(n.scope||n,n,n.value),n.onSelect())},getSelectedDate:function(n){var r=this,e=n.getTime(),u=r.cells,o=r.selectedCls,f=u.elements,t,s=f.length,i;for(u.removeCls(o),t=0;t<s;t++)if(i=Ext.fly(f[t]),i.dom.firstChild.dateValue==e)return i.dom.firstChild;return null},initDisabledDays:function(){var t=this,i=t.disabledDates,u="(?:",f,n,e,r;if(!t.disabledDatesRE&&i){for(f=i.length-1,e=i.length,n=0;n<e;n++)r=i[n],u+=Ext.isDate(r)?"^"+Ext.String.escapeRegex(Ext.Date.dateFormat(r,t.format))+"$":r,n!=f&&(u+="|");t.disabledDatesRE=new RegExp(u+")")}},setDisabledDates:function(n){var t=this;return Ext.isArray(n)?(t.disabledDates=n,t.disabledDatesRE=null):t.disabledDatesRE=n,t.initDisabledDays(),t.update(t.value,!0),t},setDisabledDays:function(n){return this.disabledDays=n,this.update(this.value,!0)},setMinDate:function(n){return this.minDate=n,this.update(this.value,!0)},setMaxDate:function(n){return this.maxDate=n,this.update(this.value,!0)},setValue:function(n){return this.value=Ext.Date.clearTime(n,!0),this.update(this.value)},getValue:function(){return this.value},getDayInitial:function(n){return n.substr(0,1)},focus:function(){this.update(this.activeDate)},onEnable:function(){this.callParent();this.setDisabledStatus(!1);this.update(this.activeDate)},onDisable:function(){this.callParent();this.setDisabledStatus(!0)},setDisabledStatus:function(n){var t=this;t.keyNav.setDisabled(n);t.prevRepeater.setDisabled(n);t.nextRepeater.setDisabled(n);t.showToday&&(t.todayKeyListener.setDisabled(n),t.todayBtn.setDisabled(n))},getActive:function(){return this.activeDate||this.value},runAnimation:function(n){var t=this.monthPicker,i={duration:200,callback:function(){n?t.hide():t.show()}};n?t.el.slideOut("t",i):t.el.slideIn("t",i)},hideMonthPicker:function(n){var t=this,i=t.monthPicker;return i&&(t.shouldAnimate(n)?t.runAnimation(!0):i.hide()),t},showMonthPicker:function(n){var t=this,i;return t.rendered&&!t.disabled&&(i=t.createMonthPicker(),i.setValue(t.getActive()),i.setSize(t.getSize()),i.setPosition(-1,-1),t.shouldAnimate(n)?t.runAnimation(!1):i.show()),t},shouldAnimate:function(n){return Ext.isDefined(n)?n:!this.disableAnim},createMonthPicker:function(){var n=this,t=n.monthPicker;if(!t){n.monthPicker=t=new Ext.picker.Month({renderTo:n.el,floating:!0,shadow:!1,small:n.showToday===!1,listeners:{scope:n,cancelclick:n.onCancelClick,okclick:n.onOkClick,yeardblclick:n.onOkClick,monthdblclick:n.onOkClick}});n.disableAnim||t.el.setStyle("display","none");n.on("beforehide",Ext.Function.bind(n.hideMonthPicker,n,[!1]))}return t},onOkClick:function(n,t){var i=this,r=t[0],f=t[1],u=new Date(f,r,i.getActive().getDate());u.getMonth()!==r&&(u=Ext.Date.getLastDateOfMonth(new Date(f,r,1)));i.setValue(u);i.hideMonthPicker()},onCancelClick:function(){this.selectedUpdate(this.activeDate);this.hideMonthPicker()},showPrevMonth:function(){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.MONTH,-1))},showNextMonth:function(){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.MONTH,1))},showPrevYear:function(){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.YEAR,-1))},showNextYear:function(){return this.setValue(Ext.Date.add(this.activeDate,Ext.Date.YEAR,1))},handleMouseWheel:function(n){if(n.stopEvent(),!this.disabled){var t=n.getWheelDelta();t>0?this.showPrevMonth():t<0&&this.showNextMonth()}},handleDateClick:function(n,t){var i=this,r=i.handler;n.stopEvent();i.disabled||!t.dateValue||Ext.fly(t.parentNode).hasCls(i.disabledCellCls)||(i.doCancelFocus=i.focusOnSelect===!1,i.setValue(new Date(t.dateValue)),delete i.doCancelFocus,i.fireEvent("select",i,i.value),r&&r.call(i.scope||i,i,i.value),i.onSelect())},onSelect:function(){this.hideOnSelect&&this.hide()},selectToday:function(){var n=this,t=n.todayBtn,i=n.handler;return t&&!t.disabled&&(n.setValue(Ext.Date.clearTime(new Date)),n.fireEvent("select",n,n.value),i&&i.call(n.scope||n,n,n.value),n.onSelect()),n},selectedUpdate:function(n){var t=this,o=n.getTime(),u=t.cells,f=t.selectedCls,e=u.elements,r,s=e.length,i;for(u.removeCls(f),r=0;r<s;r++)if(i=Ext.fly(e[r]),i.dom.firstChild.dateValue==o){t.fireEvent("highlightitem",t,i);i.addCls(f);t.isVisible()&&!t.doCancelFocus&&Ext.fly(i.dom.firstChild).focus(50);break}},fullUpdate:function(n){var t=this,tt=t.cells.elements,it=t.textNodes,s=t.disabledCellCls,i=Ext.Date,r=0,rt=0,ut=t.isVisible(),ft=+i.clearTime(n,!0),et=+i.clearTime(new Date),k=t.minDate?i.clearTime(t.minDate,!0):Number.NEGATIVE_INFINITY,d=t.maxDate?i.clearTime(t.maxDate,!0):Number.POSITIVE_INFINITY,h=t.disabledDatesRE,ot=t.disabledDatesText,c=t.disabledDays?t.disabledDays.join(""):!1,st=t.disabledDaysText,l=t.format,g=i.getDaysInMonth(n),ht=i.getFirstDateOfMonth(n),f=ht.getDay()-t.startDay,y=i.add(n,i.MONTH,-1),ct=t.longDayFormat,p,u,w,o,nt,a,v,b,e;for(f<0&&(f+=7),g+=f,p=i.getDaysInMonth(y)-f,u=new Date(y.getFullYear(),y.getMonth(),p,t.initHour),t.showToday&&(o=i.clearTime(new Date),w=o<k||o>d||h&&l&&h.test(i.dateFormat(o,l))||c&&c.indexOf(o.getDay())!=-1,t.disabled||(t.todayBtn.setDisabled(w),t.todayKeyListener.setDisabled(w))),nt=function(n,r){e=+i.clearTime(u,!0);n.title=i.format(u,ct);n.firstChild.dateValue=e;e==et&&(r+=" "+t.todayCls,n.title=t.todayText,t.todayElSpan=Ext.DomHelper.append(n.firstChild,{tag:"span",cls:Ext.baseCSSPrefix+"hide-clip",html:t.todayText},!0));e==ft&&(r+=" "+t.selectedCls,t.fireEvent("highlightitem",t,n),ut&&t.floating&&Ext.fly(n.firstChild).focus(50));e<k?(r+=" "+s,n.title=t.minText):e>d?(r+=" "+s,n.title=t.maxText):c&&c.indexOf(u.getDay())!==-1?(n.title=st,r+=" "+s):h&&l&&(b=i.dateFormat(u,l),h.test(b)&&(n.title=ot.replace("%0",b),r+=" "+s));n.className=r+" "+t.cellCls};r<t.numDays;++r)r<f?(a=++p,v=t.prevCls):r>=g?(a=++rt,v=t.nextCls):(a=r-f+1,v=t.activeCls),it[r].innerHTML=a,u.setDate(u.getDate()+1),nt(tt[r],v);t.monthBtn.setText(Ext.Date.format(n,t.monthYearFormat))},update:function(n,t){var i=this,r=i.activeDate;return i.rendered&&(i.activeDate=n,!t&&r&&i.el&&r.getMonth()==n.getMonth()&&r.getFullYear()==n.getFullYear()?i.selectedUpdate(n,r):i.fullUpdate(n,r)),i},beforeDestroy:function(){var n=this;n.rendered&&(Ext.destroy(n.todayKeyListener,n.keyNav,n.monthPicker,n.monthBtn,n.nextRepeater,n.prevRepeater,n.todayBtn),delete n.textNodes,delete n.cells.elements);n.callParent()},onShow:function(){this.callParent(arguments);this.focusOnShow&&this.focus()}})