Ext.define("Ext.FocusManager",{singleton:!0,alternateClassName:["Ext.FocusMgr"],mixins:{observable:"Ext.util.Observable"},requires:["Ext.AbstractComponent","Ext.Component","Ext.ComponentManager","Ext.ComponentQuery","Ext.util.HashMap","Ext.util.KeyNav"],enabled:!1,focusElementCls:Ext.baseCSSPrefix+"focus-element",focusFrameCls:Ext.baseCSSPrefix+"focus-frame",whitelist:["textfield"],constructor:function(n){var t=this,i=Ext.ComponentQuery;t.mixins.observable.constructor.call(t,n);t.addEvents("beforecomponentfocus","componentfocus","disable","enable");t.focusTask=new Ext.util.DelayedTask(t.handleComponentFocus,t);Ext.override(Ext.AbstractComponent,{onFocus:function(){this.callParent(arguments);t.enabled&&this.hasFocus&&(Array.prototype.unshift.call(arguments,this),t.onComponentFocus.apply(t,arguments))},onBlur:function(){this.callParent(arguments);t.enabled&&!this.hasFocus&&(Array.prototype.unshift.call(arguments,this),t.onComponentBlur.apply(t,arguments))},onDestroy:function(){this.callParent(arguments);t.enabled&&(Array.prototype.unshift.call(arguments,this),t.onComponentDestroy.apply(t,arguments))}});Ext.override(Ext.Component,{afterHide:function(){this.callParent(arguments);t.enabled&&(Array.prototype.unshift.call(arguments,this),t.onComponentHide.apply(t,arguments))}});t.keyNav=new Ext.util.KeyNav(Ext.getDoc(),{disabled:!0,scope:t,backspace:t.focusLast,enter:t.navigateIn,esc:t.navigateOut,tab:t.navigateSiblings,space:t.navigateIn,del:t.focusLast,left:t.navigateSiblings,right:t.navigateSiblings,down:t.navigateSiblings,up:t.navigateSiblings});t.focusData={};t.subscribers=new Ext.util.HashMap;t.focusChain={};Ext.apply(i.pseudos,{nextFocus:function(n,t,i){i=i||1;t=parseInt(t,10);for(var u=n.length,r=t,f;;){if((r+=i)>=u?r=0:r<0&&(r=u-1),r===t)return[];if((f=n[r]).isFocusable())return[f]}return[]},prevFocus:function(n,t){return this.nextFocus(n,t,-1)},root:function(n){for(var u=n.length,r=[],t=0,i;t<u;t++)i=n[t],i.ownerCt||r.push(i);return r}})},addXTypeToWhitelist:function(n){var t=this;if(Ext.isArray(n)){Ext.Array.forEach(n,t.addXTypeToWhitelist,t);return}Ext.Array.contains(t.whitelist,n)||t.whitelist.push(n)},clearComponent:function(n){clearTimeout(this.cmpFocusDelay);n.isDestroyed||n.blur()},disable:function(){var n=this;n.enabled&&(delete n.options,n.enabled=!1,n.removeDOM(),n.keyNav.disable(),n.fireEvent("disable",n))},enable:function(n){var t=this;(n===!0&&(n={focusFrame:!0}),t.options=n=n||{},t.enabled)||(t.enabled=!0,t.initDOM(n),t.keyNav.enable(),t.focusEl.focus(),delete t.focusedCmp,t.fireEvent("enable",t))},focusLast:function(){var n=this;if(n.isWhitelisted(n.focusedCmp))return!0;n.previousFocusedCmp&&n.previousFocusedCmp.focus()},getRootComponents:function(){var n=Ext.ComponentQuery,i=n.query(":focusable:root:not([floating])"),t=n.query(":focusable:root[floating]");return t.sort(function(n,t){return n.el.getZIndex()>t.el.getZIndex()}),t.concat(i)},initDOM:function(n){var t=this,i=t.focusFrameCls,u=Ext.ComponentQuery.query("{getFocusEl()}:not([focusListenerAdded])"),r=0,f=u.length;if(!Ext.isReady)return Ext.onReady(t.initDOM,t);for(;r<f;r++)u[r].addFocusListener();t.focusEl||(t.focusEl=Ext.getBody(),t.focusEl.dom.tabIndex=-1);!t.focusFrame&&n.focusFrame&&(t.focusFrame=Ext.getBody().createChild({cls:i,children:[{cls:i+"-top"},{cls:i+"-bottom"},{cls:i+"-left"},{cls:i+"-right"}],style:"top: -100px; left: -100px;"}),t.focusFrame.setVisibilityMode(Ext.Element.DISPLAY),t.focusFrame.hide().setLocalXY(0,0))},isWhitelisted:function(n){return n&&Ext.Array.some(this.whitelist,function(t){return n.isXType(t)})},navigateIn:function(n){var i=this,t=i.focusedCmp,r,u;if(i.isWhitelisted(t))return!0;if(t){if(u=t.hasFocus?Ext.ComponentQuery.query(">:focusable",t)[0]:t,u)u.focus();else if(Ext.isFunction(t.onClick)){n.button=0;t.onClick(n);t.isVisible(!0)?t.focus():i.navigateOut()}}else r=i.getRootComponents()[0],r&&(r.getFocusEl()===i.focusEl&&i.focusEl.blur(),r.focus())},navigateOut:function(){var n=this,t;return n.focusedCmp&&(t=n.focusedCmp.up(":focusable"))?t.focus():n.focusEl.focus(),!0},navigateSiblings:function(n,t,i){var s=this,h=t||s,u=n.getKey(),f=Ext.EventObject,l=n.shiftKey||u==f.LEFT||u==f.UP,a=u==f.LEFT||u==f.RIGHT||u==f.UP||u==f.DOWN,v=l?"prev":"next",c,e,r,o;return(r=h.focusedCmp&&h.focusedCmp.comp||h.focusedCmp,!r&&!i)?!0:a&&s.isWhitelisted(r)?!0:(!r||r.is(":root")?o=s.getRootComponents():(i=i||r.up(),i&&(o=i.getRefItems())),o&&(c=r?Ext.Array.indexOf(o,r):-1,e=Ext.ComponentQuery.query(":"+v+"Focus("+c+")",o)[0],e&&r!==e)?(e.focus(),e):void 0)},onComponentBlur:function(n){var t=this;t.focusedCmp===n&&(t.previousFocusedCmp=n,delete t.focusedCmp);t.focusFrame&&t.focusFrame.hide()},onComponentFocus:function(n){var t=this,r=t.focusChain,i;if(!n.isFocusable()){if(t.clearComponent(n),r[n.id])return;i=n.up();i&&(r[n.id]=!0,i.focus());return}t.focusChain={};t.focusTask.delay(10,null,null,[n,n.getFocusEl()])},handleComponentFocus:function(n,t){var i=this,u,r,f,e,o,s,h,c,l,a,v;if(i.fireEvent("beforecomponentfocus",i,n,i.previousFocusedCmp)===!1){i.clearComponent(n);return}i.focusedCmp=n;i.shouldShowFocusFrame(n)&&(u="."+i.focusFrameCls+"-",r=i.focusFrame,f=(t.dom?t:t.el).getBox(),e=f.top,o=f.left,s=f.width,h=f.height,c=r.child(u+"top"),l=r.child(u+"bottom"),a=r.child(u+"left"),v=r.child(u+"right"),c.setWidth(s).setLocalXY(o,e),l.setWidth(s).setLocalXY(o,e+h-2),a.setHeight(h-2).setLocalXY(o,e+2),v.setHeight(h-2).setLocalXY(o+s-2,e+2),r.show());i.fireEvent("componentfocus",i,n,i.previousFocusedCmp)},onComponentHide:function(n){var t=this,i=!1,u=t.focusedCmp,r;u&&(i=n.hasFocus||n.isContainer&&n.isAncestor(t.focusedCmp));t.clearComponent(n);i&&(r=n.up(":focusable"))?r.focus():t.focusEl.focus()},onComponentDestroy:function(){},removeDOM:function(){var n=this;n.enabled||n.subscribers.length||(Ext.destroy(n.focusFrame),delete n.focusEl,delete n.focusFrame)},removeXTypeFromWhitelist:function(n){var t=this;if(Ext.isArray(n)){Ext.Array.forEach(n,t.removeXTypeFromWhitelist,t);return}Ext.Array.remove(t.whitelist,n)},setupSubscriberKeys:function(n,t){var i=this,u=n.getFocusEl(),f=t.scope,r={backspace:i.focusLast,enter:i.navigateIn,esc:i.navigateOut,scope:i},e=function(t){return i.focusedCmp===n?i.navigateSiblings(t,i,n):i.navigateSiblings(t)};return Ext.iterate(t,function(t,i){r[t]=function(t){var r=e(t);return Ext.isFunction(i)&&i.call(f||n,t,r)===!0?!0:r}},i),new Ext.util.KeyNav(u,r)},shouldShowFocusFrame:function(n){var t=this,i=t.options||{};return!t.focusFrame||!n?!1:i.focusFrame?!0:t.focusData[n.id].focusFrame?!0:!1}})