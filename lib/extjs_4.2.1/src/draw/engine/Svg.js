Ext.define("Ext.draw.engine.Svg",{extend:"Ext.draw.Surface",requires:["Ext.draw.Draw","Ext.draw.Sprite","Ext.draw.Matrix","Ext.Element"],engine:"Svg",trimRe:/^\s+|\s+$/g,spacesRe:/\s+/,xlink:"http://www.w3.org/1999/xlink",translateAttrs:{radius:"r",radiusX:"rx",radiusY:"ry",path:"d",lineWidth:"stroke-width",fillOpacity:"fill-opacity",strokeOpacity:"stroke-opacity",strokeLinejoin:"stroke-linejoin"},parsers:{},minDefaults:{circle:{cx:0,cy:0,r:0,fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},ellipse:{cx:0,cy:0,rx:0,ry:0,fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},rect:{x:0,y:0,width:0,height:0,rx:0,ry:0,fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},text:{x:0,y:0,"text-anchor":"start","font-family":null,"font-size":null,"font-weight":null,"font-style":null,fill:"#000",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},path:{d:"M0,0",fill:"none",stroke:null,"stroke-width":null,opacity:null,"fill-opacity":null,"stroke-opacity":null},image:{x:0,y:0,width:0,height:0,preserveAspectRatio:"none",opacity:null}},createSvgElement:function(n,t){var r=this.domRef.createElementNS("http://www.w3.org/2000/svg",n),i;if(t)for(i in t)r.setAttribute(i,String(t[i]));return r},createSpriteElement:function(n){var t=this.createSvgElement(n.type);return t.id=n.id,t.style&&(t.style.webkitTapHighlightColor="rgba(0,0,0,0)"),n.el=Ext.get(t),this.applyZIndex(n),n.matrix=new Ext.draw.Matrix,n.bbox={plain:0,transform:0},this.applyAttrs(n),this.applyTransformations(n),n.fireEvent("render",n),t},getBBoxText:function(n){var t={},i,f,e,r,o,u;if(n&&n.el){u=n.el.dom;try{return u.getBBox()}catch(s){}for(t={x:t.x,y:Infinity,width:0,height:0},o=u.getNumberOfChars(),r=0;r<o;r++)i=u.getExtentOfChar(r),t.y=Math.min(i.y,t.y),f=i.y+i.height-t.y,t.height=Math.max(t.height,f),e=i.x+i.width-t.x,t.width=Math.max(t.width,e);return t}},hide:function(){Ext.get(this.el).hide()},show:function(){Ext.get(this.el).show()},hidePrim:function(n){this.addCls(n,Ext.baseCSSPrefix+"hide-visibility")},showPrim:function(n){this.removeCls(n,Ext.baseCSSPrefix+"hide-visibility")},getDefs:function(){return this._defs||(this._defs=this.createSvgElement("defs"))},transform:function(n,t){for(var s=this,r=new Ext.draw.Matrix,e=n.transformations,o=e.length,f=0,i,u;f<o;f++)i=e[f],u=i.type,u=="translate"?r.translate(i.x,i.y):u=="rotate"?r.rotate(i.degrees,i.x,i.y):u=="scale"&&r.scale(i.x,i.y,i.centerX,i.centerY);n.matrix=r;t||n.el.set({transform:r.toSvg()})},setSize:function(n,t){var i=this,r=i.el;n=+n||i.width;t=+t||i.height;i.width=n;i.height=t;r.setSize(n,t);r.set({width:n,height:t});i.callParent([n,t])},getRegion:function(){var n=this.el.getXY(),t=this.bgRect.getXY(),i=Math.max,r=i(n[0],t[0]),u=i(n[1],t[1]);return{left:r,top:u,right:r+this.width,bottom:u+this.height}},onRemove:function(n){n.el&&(n.el.destroy(),delete n.el);this.callParent(arguments)},setViewBox:function(n,t,i,r){isFinite(n)&&isFinite(t)&&isFinite(i)&&isFinite(r)&&(this.callParent(arguments),this.el.dom.setAttribute("viewBox",[n,t,i,r].join(" ")))},render:function(n){var t=this,f,e,i,o,r,u;if(!t.el){f=t.width||0;e=t.height||0;i=t.createSvgElement("svg",{xmlns:"http://www.w3.org/2000/svg",version:1.1,width:f,height:e});o=t.getDefs();r=t.createSvgElement("rect",{width:"100%",height:"100%",fill:"#000",stroke:"none",opacity:0});Ext.isSafari3&&(u=t.createSvgElement("rect",{x:-10,y:-10,width:"110%",height:"110%",fill:"none",stroke:"#000"}));i.appendChild(o);Ext.isSafari3&&i.appendChild(u);i.appendChild(r);n.appendChild(i);t.el=Ext.get(i);t.bgRect=Ext.get(r);Ext.isSafari3&&(t.webkitRect=Ext.get(u),t.webkitRect.hide());t.el.on({scope:t,mouseup:t.onMouseUp,mousedown:t.onMouseDown,mouseover:t.onMouseOver,mouseout:t.onMouseOut,mousemove:t.onMouseMove,mouseenter:t.onMouseEnter,mouseleave:t.onMouseLeave,click:t.onClick,dblclick:t.onDblClick})}t.renderAll()},onMouseEnter:function(n){this.el.parent().getRegion().contains(n.getPoint())&&this.fireEvent("mouseenter",n)},onMouseLeave:function(n){this.el.parent().getRegion().contains(n.getPoint())||this.fireEvent("mouseleave",n)},processEvent:function(n,t){var i=t.getTarget(),u=this.surface,r;this.fireEvent(n,t);i.nodeName=="tspan"&&i.parentNode&&(i=i.parentNode);r=this.items.get(i.id);r&&r.fireEvent(n,r,t)},tuneText:function(n,t){var h=n.el.dom,i=[],u,f,r,e,o,s;if(t.hasOwnProperty("text")&&(f=n.tspans&&Ext.Array.map(n.tspans,function(n){return n.textContent}).join(""),n.tspans&&t.text==f?i=n.tspans||[]:(i=this.setText(n,t.text),n.tspans=i)),i.length){for(u=this.getBBoxText(n).height,s=n.el.dom.getAttribute("x"),r=0,e=i.length;r<e;r++)o=Ext.isFF3_0||Ext.isFF3_5?2:4,i[r].setAttribute("x",s),i[r].setAttribute("dy",r?u*1.2:u/o);n.dirty=!0}},setText:function(n,t){for(var h=this,r=n.el.dom,o=[],u,f,i,s,e;r.firstChild;)r.removeChild(r.firstChild);for(e=String(t).split("\n"),i=0,s=e.length;i<s;i++)f=e[i],f&&(u=h.createSvgElement("tspan"),u.appendChild(document.createTextNode(Ext.htmlDecode(f))),r.appendChild(u),o[i]=u);return o},renderAll:function(){this.items.each(this.renderItem,this)},renderItem:function(n){this.el&&(n.el||this.createSpriteElement(n),n.zIndexDirty&&this.applyZIndex(n),n.dirty&&(this.applyAttrs(n),n.dirtyTransform&&this.applyTransformations(n)))},redraw:function(n){n.dirty=n.zIndexDirty=!0;this.renderItem(n)},applyAttrs:function(n){var r=this,u=n.el,f=n.group,h=n.attr,c=r.parsers,l=r.gradientsMap||{},v=Ext.isSafari&&!Ext.isStrict,o,e,a,t,i,s;if(f){for(o=[].concat(f),a=o.length,e=0;e<a;e++)f=o[e],r.getGroup(f).add(n);delete n.group}t=r.scrubAttrs(n)||{};n.bbox.plain=0;n.bbox.transform=0;n.type=="circle"||n.type=="ellipse"?(t.cx=t.cx||t.x,t.cy=t.cy||t.y):n.type=="rect"?t.rx=t.ry=t.r:n.type=="path"&&t.d&&(t.d=Ext.draw.Draw.pathToString(Ext.draw.Draw.pathToAbsolute(t.d)));n.dirtyPath=!1;t["clip-rect"]&&(r.setClip(n,t),delete t["clip-rect"]);n.type=="text"&&t.font&&n.dirtyFont&&u.set({style:"font: "+t.font});n.type=="image"&&u.dom.setAttributeNS(r.xlink,"href",t.src);Ext.applyIf(t,r.minDefaults[n.type]);n.dirtyHidden&&(h.hidden?r.hidePrim(n):r.showPrim(n),n.dirtyHidden=!1);for(i in t)if(t.hasOwnProperty(i)&&t[i]!=null){if(v&&"color|stroke|fill".indexOf(i)>-1&&t[i]in l&&(t[i]=l[t[i]]),i=="hidden"&&n.type=="text")continue;i in c?u.dom.setAttribute(i,c[i](t[i],n,r)):u.dom.setAttribute(i,t[i])}n.type=="text"&&r.tuneText(n,t);n.dirtyFont=!1;s=h.style;s&&u.setStyle(s);n.dirty=!1;Ext.isSafari3&&(r.webkitRect.show(),setTimeout(function(){r.webkitRect.hide()}))},setClip:function(n,t){var f=this,r=t["clip-rect"],u,i;r&&(n.clip&&n.clip.parentNode.parentNode.removeChild(n.clip.parentNode),u=f.createSvgElement("clipPath"),i=f.createSvgElement("rect"),u.id=Ext.id(null,"ext-clip-"),i.setAttribute("x",r.x),i.setAttribute("y",r.y),i.setAttribute("width",r.width),i.setAttribute("height",r.height),u.appendChild(i),f.getDefs().appendChild(u),n.el.dom.setAttribute("clip-path","url(#"+u.id+")"),n.clip=i)},applyZIndex:function(n){var i=this,u=i.items,t=u.indexOf(n),f=n.el,r;if(i.el.dom.childNodes[t+2]!==f.dom){if(t>0)do r=u.getAt(--t).el;while(!r&&t>0);f.insertAfter(r||i.bgRect)}n.zIndexDirty=!1},createItem:function(n){var t=new Ext.draw.Sprite(n);return t.surface=this,t},addGradient:function(n){n=Ext.draw.Draw.parseGradient(n);var i=this,s=n.stops.length,u=n.vector,h=Ext.isSafari&&!Ext.isStrict,t,f,r,e,o;if(o=i.gradientsMap||{},h)o["url(#"+n.id+")"]=n.stops[0].color;else for(n.type=="linear"?(t=i.createSvgElement("linearGradient"),t.setAttribute("x1",u[0]),t.setAttribute("y1",u[1]),t.setAttribute("x2",u[2]),t.setAttribute("y2",u[3])):(t=i.createSvgElement("radialGradient"),t.setAttribute("cx",n.centerX),t.setAttribute("cy",n.centerY),t.setAttribute("r",n.radius),Ext.isNumber(n.focalX)&&Ext.isNumber(n.focalY)&&(t.setAttribute("fx",n.focalX),t.setAttribute("fy",n.focalY))),t.id=n.id,i.getDefs().appendChild(t),e=0;e<s;e++)f=n.stops[e],r=i.createSvgElement("stop"),r.setAttribute("offset",f.offset+"%"),r.setAttribute("stop-color",f.color),r.setAttribute("stop-opacity",f.opacity),t.appendChild(r);i.gradientsMap=o},hasCls:function(n,t){return t&&(" "+(n.el.dom.getAttribute("class")||"")+" ").indexOf(" "+t+" ")!=-1},addCls:function(n,t){var u=n.el,i,e,r,f=[],o=u.getAttribute("class")||"";if(Ext.isArray(t)){for(i=0,e=t.length;i<e;i++)r=t[i],typeof r=="string"&&(" "+o+" ").indexOf(" "+r+" ")==-1&&f.push(r);f.length&&u.set({"class":" "+f.join(" ")})}else typeof t!="string"||this.hasCls(n,t)||u.set({"class":o+" "+t})},removeCls:function(n,t){var f=this,o=n.el,s=o.getAttribute("class")||"",r,e,h,i,u;if(Ext.isArray(t)||(t=[t]),s){for(u=s.replace(f.trimRe," ").split(f.spacesRe),r=0,h=t.length;r<h;r++)i=t[r],typeof i=="string"&&(i=i.replace(f.trimRe,""),e=Ext.Array.indexOf(u,i),e!=-1&&Ext.Array.erase(u,e,1));o.set({"class":u.join(" ")})}},destroy:function(){var n=this;n.callParent();n.el&&n.el.remove();n._defs&&Ext.get(n._defs).destroy();n.bgRect&&Ext.get(n.bgRect).destroy();n.webkitRect&&Ext.get(n.webkitRect).destroy();delete n.el}})