Ext.define("Ext.draw.Surface",{mixins:{observable:"Ext.util.Observable"},requires:["Ext.draw.CompositeSprite"],uses:["Ext.draw.engine.Svg","Ext.draw.engine.Vml","Ext.draw.engine.SvgExporter","Ext.draw.engine.ImageExporter"],separatorRe:/[, ]+/,enginePriority:["Svg","Vml"],statics:{create:function(n,t){t=t||this.prototype.enginePriority;for(var i=0,r=t.length;i<r;i++)if(Ext.supports[t[i]])return Ext.create("Ext.draw.engine."+t[i],n);return!1},save:function(n,t){t=t||{};var i={"image/png":"Image","image/jpeg":"Image","image/svg+xml":"Svg"}[t.type]||"Svg",r=Ext.draw.engine[i+"Exporter"];return r.generate(n,t)}},availableAttrs:{blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,"dominant-baseline":"auto",fill:"none","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:"",height:0,hidden:!1,href:"http://sencha.com/",opacity:1,path:"M0,0",radius:0,rx:0,ry:0,scale:"1 1",src:"",stroke:"none","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank",text:"","text-anchor":"middle",title:"Ext Draw",width:0,x:0,y:0,zIndex:0},container:undefined,height:352,width:512,x:0,y:0,orderSpritesByZIndex:!0,constructor:function(n){var t=this;n=n||{};Ext.apply(t,n);t.domRef=Ext.getDoc().dom;t.customAttributes={};t.addEvents("mousedown","mouseup","mouseover","mouseout","mousemove","mouseenter","mouseleave","click","dblclick");t.mixins.observable.constructor.call(t);t.getId();t.initGradients();t.initItems();t.renderTo&&(t.render(t.renderTo),delete t.renderTo);t.initBackground(n.background)},initSurface:Ext.emptyFn,renderItem:Ext.emptyFn,renderItems:Ext.emptyFn,setViewBox:function(n,t,i,r){isFinite(n)&&isFinite(t)&&isFinite(i)&&isFinite(r)&&(this.viewBox={x:n,y:t,width:i,height:r},this.applyViewBox())},addCls:Ext.emptyFn,removeCls:Ext.emptyFn,setStyle:Ext.emptyFn,initGradients:function(){if(this.hasOwnProperty("gradients")){var t=this.gradients,r=this.addGradient,n,i;if(t)for(n=0,i=t.length;n<i;n++)if(r.call(this,t[n],n,i)===!1)break}},initItems:function(){var n=this.items;this.items=new Ext.draw.CompositeSprite;this.items.autoDestroy=!0;this.groups=new Ext.draw.CompositeSprite;n&&this.add(n)},initBackground:function(n){var t=this,i=t.width,r=t.height,f,u;Ext.isString(n)&&(n={fill:n});n&&(n.gradient?(u=n.gradient,f=u.id,t.addGradient(u),t.background=t.add({type:"rect",x:0,y:0,width:i,height:r,fill:"url(#"+f+")",zIndex:-1})):n.fill?t.background=t.add({type:"rect",x:0,y:0,width:i,height:r,fill:n.fill,zIndex:-1}):n.image&&(t.background=t.add({type:"image",x:0,y:0,width:i,height:r,src:n.image,zIndex:-1})),t.background.bboxExcluded=!0)},setSize:function(){this.applyViewBox()},scrubAttrs:function(n){var t,i={},u={},r=n.attr;for(t in r)this.translateAttrs.hasOwnProperty(t)?(i[this.translateAttrs[t]]=r[t],u[this.translateAttrs[t]]=!0):this.availableAttrs.hasOwnProperty(t)&&!u[t]&&(i[t]=r[t]);return i},onClick:function(n){this.processEvent("click",n)},onDblClick:function(n){this.processEvent("dblclick",n)},onMouseUp:function(n){this.processEvent("mouseup",n)},onMouseDown:function(n){this.processEvent("mousedown",n)},onMouseOver:function(n){this.processEvent("mouseover",n)},onMouseOut:function(n){this.processEvent("mouseout",n)},onMouseMove:function(n){this.fireEvent("mousemove",n)},onMouseEnter:Ext.emptyFn,onMouseLeave:Ext.emptyFn,addGradient:Ext.emptyFn,add:function(){var n=Array.prototype.slice.call(arguments),t,e=n.length>1,u,f,i,o,r;if(e||Ext.isArray(n[0])){for(u=e?n:n[0],f=[],i=0,o=u.length;i<o;i++)r=u[i],r=this.add(r),f.push(r);return f}t=this.prepareItems(n[0],!0)[0];this.insertByZIndex(t);this.onAdd(t);return t},insertByZIndex:function(n){var f=this,i=f.items.items,e=i.length,h=Math.ceil,r=n.attr.zIndex,t=e,u=t-1,o=0,s;if(f.orderSpritesByZIndex&&e&&r<i[u].attr.zIndex){while(o<=u)if(t=h((o+u)/2),s=i[t].attr.zIndex,s>r)u=t-1;else if(s<r)o=t+1;else break;while(t<e&&i[t].attr.zIndex<=r)t++}return f.items.insert(t,n),t},onAdd:function(n){var t=n.group,f=n.draggable,r,u,i;if(t){for(r=[].concat(t),u=r.length,i=0;i<u;i++)t=r[i],this.getGroup(t).add(n);delete n.group}f&&n.initDraggable()},remove:function(n,t){if(n){this.items.remove(n);for(var r=[].concat(this.groups.items),u=r.length,i=0;i<u;i++)r[i].remove(n);n.onRemove();t===!0&&n.destroy()}},removeAll:function(n){for(var i=this.items.items,r=i.length,t=r-1;t>-1;t--)this.remove(i[t],n)},onRemove:Ext.emptyFn,onDestroy:Ext.emptyFn,applyViewBox:function(){var t=this,u=t.viewBox,i=t.width||1,r=t.height||1,f,e,o,s,h,c,n;u&&(i||r)?(f=u.x,e=u.y,o=u.width,s=u.height,h=r/s,c=i/o,n=Math.min(c,h),o*n<i&&(f-=(i-o*n)/2/n),s*n<r&&(e-=(r-s*n)/2/n),t.viewBoxShift={dx:-f,dy:-e,scale:n},t.background&&t.background.setAttributes(Ext.apply({},{x:f,y:e,width:i/n,height:r/n},{hidden:!1}),!0)):t.background&&i&&r&&t.background.setAttributes(Ext.apply({x:0,y:0,width:i,height:r},{hidden:!1}),!0)},getBBox:function(n,t){var i=this["getPath"+n.type](n);return t?(n.bbox.plain=n.bbox.plain||Ext.draw.Draw.pathDimensions(i),n.bbox.plain):(n.dirtyTransform&&this.applyTransformations(n,!0),n.bbox.transform=n.bbox.transform||Ext.draw.Draw.pathDimensions(Ext.draw.Draw.mapPath(i,n.matrix)),n.bbox.transform)},transformToViewBox:function(n,t){if(this.viewBoxShift){var r=this,i=r.viewBoxShift;return[n/i.scale-i.dx,t/i.scale-i.dy]}return[n,t]},applyTransformations:function(n,t){n.type=="text"&&(n.bbox.transform=0,this.transform(n,!1));n.dirtyTransform=!1;var r=this,i=n.attr;(i.translation.x!=null||i.translation.y!=null)&&r.translate(n);(i.scaling.x!=null||i.scaling.y!=null)&&r.scale(n);i.rotation.degrees!=null&&r.rotate(n);n.bbox.transform=0;this.transform(n,t);n.transformations=[]},rotate:function(n){var t,u=n.attr.rotation.degrees,i=n.attr.rotation.x,r=n.attr.rotation.y;Ext.isNumber(i)&&Ext.isNumber(r)||(t=this.getBBox(n,!0),i=Ext.isNumber(i)?i:t.x+t.width/2,r=Ext.isNumber(r)?r:t.y+t.height/2);n.transformations.push({type:"rotate",degrees:u,x:i,y:r})},translate:function(n){var t=n.attr.translation.x||0,i=n.attr.translation.y||0;n.transformations.push({type:"translate",x:t,y:i})},scale:function(n){var t,u=n.attr.scaling.x||1,f=n.attr.scaling.y||1,i=n.attr.scaling.centerX,r=n.attr.scaling.centerY;Ext.isNumber(i)&&Ext.isNumber(r)||(t=this.getBBox(n,!0),i=Ext.isNumber(i)?i:t.x+t.width/2,r=Ext.isNumber(r)?r:t.y+t.height/2);n.transformations.push({type:"scale",x:u,y:f,centerX:i,centerY:r})},rectPath:function(n,t,i,r,u){return u?[["M",n+u,t],["l",i-u*2,0],["a",u,u,0,0,1,u,u],["l",0,r-u*2],["a",u,u,0,0,1,-u,u],["l",u*2-i,0],["a",u,u,0,0,1,-u,-u],["l",0,u*2-r],["a",u,u,0,0,1,u,-u],["z"]]:[["M",n,t],["l",i,0],["l",0,r],["l",-i,0],["z"]]},ellipsePath:function(n,t,i,r){return r==null&&(r=i),[["M",n,t],["m",0,-r],["a",i,r,0,1,1,0,2*r],["a",i,r,0,1,1,0,-2*r],["z"]]},getPathpath:function(n){return n.attr.path},getPathcircle:function(n){var t=n.attr;return this.ellipsePath(t.x,t.y,t.radius,t.radius)},getPathellipse:function(n){var t=n.attr;return this.ellipsePath(t.x,t.y,t.radiusX||t.width/2||0,t.radiusY||t.height/2||0)},getPathrect:function(n){var t=n.attr;return this.rectPath(t.x||0,t.y||0,t.width||0,t.height||0,t.r||0)},getPathimage:function(n){var t=n.attr;return this.rectPath(t.x||0,t.y||0,t.width,t.height)},getPathtext:function(n){var t=this.getBBoxText(n);return this.rectPath(t.x,t.y,t.width,t.height)},createGroup:function(n){var t=this.groups.get(n);return t||(t=new Ext.draw.CompositeSprite({surface:this}),t.id=n||Ext.id(null,"ext-surface-group-"),this.groups.add(t)),t},getGroup:function(n){var t;return typeof n=="string"?(t=this.groups.get(n),t||(t=this.createGroup(n))):t=n,t},prepareItems:function(n){n=[].concat(n);for(var t,i=0,r=n.length;i<r;i++)t=n[i],t instanceof Ext.draw.Sprite?t.surface=this:(t.surface=this,n[i]=this.createItem(t));return n},setText:Ext.emptyFn,createItem:Ext.emptyFn,getId:function(){return this.id||(this.id=Ext.id(null,"ext-surface-"))},destroy:function(){var n=this;delete n.domRef;n.background&&n.background.destroy();n.removeAll(!0);Ext.destroy(n.groups.items)}})