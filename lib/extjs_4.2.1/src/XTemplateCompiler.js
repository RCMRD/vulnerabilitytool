Ext.define("Ext.XTemplateCompiler",{extend:"Ext.XTemplateParser",useEval:Ext.isGecko,useIndex:Ext.isIE8m,useFormat:!0,propNameRe:/^[\w\d\$]*$/,compile:function(n){var t=this,i=t.generate(n);return t.useEval?t.evalTpl(i):new Function("Ext",i)(Ext)},generate:function(n){var t=this,i="var fm=Ext.util.Format,ts=Object.prototype.toString;",r;return t.maxLevel=0,t.body=["var c0=values, a0="+t.createArrayTest(0)+", p0=parent, n0=xcount, i0=xindex, k0, v;\n"],t.definitions?typeof t.definitions=="string"?t.definitions=[t.definitions,i]:t.definitions.push(i):t.definitions=[i],t.switches=[],t.parse(n),t.definitions.push((t.useEval?"$=":"return")+" function ("+t.fnArgs+") {",t.body.join(""),"}"),r=t.definitions.join("\n"),t.definitions.length=t.body.length=t.switches.length=0,delete t.definitions,delete t.body,delete t.switches,r},doText:function(n){var t=this,i=t.body;n=n.replace(t.aposRe,"\\'").replace(t.newLineRe,"\\n");t.useIndex?i.push("out[out.length]='",n,"'\n"):i.push("out.push('",n,"')\n")},doExpr:function(n){var t=this.body;t.push("if ((v="+n+") != null) out");this.useIndex?t.push("[out.length]=v+''\n"):t.push(".push(v+'')\n")},doTag:function(n){var t=this.parseTag(n);t?this.doExpr(t):this.doText("{"+n+"}")},doElse:function(){this.body.push("} else {\n")},doEval:function(n){this.body.push(n,"\n")},doIf:function(n,t){var i=this;n==="."?i.body.push("if (values) {\n"):i.propNameRe.test(n)?i.body.push("if (",i.parseTag(n),") {\n"):i.body.push("if (",i.addFn(n),i.callFn,") {\n");t.exec&&i.doExec(t.exec)},doElseIf:function(n,t){var i=this;n==="."?i.body.push("else if (values) {\n"):i.propNameRe.test(n)?i.body.push("} else if (",i.parseTag(n),") {\n"):i.body.push("} else if (",i.addFn(n),i.callFn,") {\n");t.exec&&i.doExec(t.exec)},doSwitch:function(n){var t=this;n==="."?t.body.push("switch (values) {\n"):t.propNameRe.test(n)?t.body.push("switch (",t.parseTag(n),") {\n"):t.body.push("switch (",t.addFn(n),t.callFn,") {\n");t.switches.push(0)},doCase:function(n){var t=this,r=Ext.isArray(n)?n:[n],u=t.switches.length-1,f,i;for(t.switches[u]?t.body.push("break;\n"):t.switches[u]++,i=0,u=r.length;i<u;++i)f=t.intRe.exec(r[i]),r[i]=f?f[1]:"'"+r[i].replace(t.aposRe,"\\'")+"'";t.body.push("case ",r.join(": case "),":\n")},doDefault:function(){var n=this,t=n.switches.length-1;n.switches[t]?n.body.push("break;\n"):n.switches[t]++;n.body.push("default:\n")},doEnd:function(n,t){var i=this,r=i.level-1;n=="for"||n=="foreach"?(t.exec&&i.doExec(t.exec),i.body.push("}\n"),i.body.push("parent=p",r,";values=r",r+1,";xcount=n"+r+";xindex=i",r,"+1;xkey=k",r,";\n")):(n=="if"||n=="switch")&&i.body.push("}\n")},doFor:function(n,t){var r=this,f,i=r.level,u=i-1,e;f=n==="."?"values":r.propNameRe.test(n)?r.parseTag(n):r.addFn(n)+r.callFn;r.maxLevel<i&&(r.maxLevel=i,r.body.push("var "));e=n=="."?"c"+i:"a"+u+"?c"+u+"[i"+u+"]:c"+u;r.body.push("i",i,"=0,n",i,"=0,c",i,"=",f,",a",i,"=",r.createArrayTest(i),",r",i,"=values,p",i,",k",i,";\n","p",i,"=parent=",e,"\n","if (c",i,"){if(a",i,"){n",i,"=c",i,".length;}else if (c",i,".isMixedCollection){c",i,"=c",i,".items;n",i,"=c",i,".length;}else if(c",i,".isStore){c",i,"=c",i,".data.items;n",i,"=c",i,".length;}else{c",i,"=[c",i,"];n",i,"=1;}}\n","for (xcount=n",i,";i",i,"<n"+i+";++i",i,"){\n","values=c",i,"[i",i,"]");t.propName&&r.body.push(".",t.propName);r.body.push("\n","xindex=i",i,"+1\n");t.between&&r.body.push('if(xindex>1){ out.push("',t.between,'"); } \n')},doForEach:function(n,t){var r=this,f,i=r.level,u=i-1,e;f=n==="."?"values":r.propNameRe.test(n)?r.parseTag(n):r.addFn(n)+r.callFn;r.maxLevel<i&&(r.maxLevel=i,r.body.push("var "));e=n=="."?"c"+i:"a"+u+"?c"+u+"[i"+u+"]:c"+u;r.body.push("i",i,"=-1,n",i,"=0,c",i,"=",f,",a",i,"=",r.createArrayTest(i),",r",i,"=values,p",i,",k",i,";\n","p",i,"=parent=",e,"\n","for(k",i," in c",i,"){\n","xindex=++i",i,"+1;\n","xkey=k",i,";\n","values=c",i,"[k",i,"];");t.propName&&r.body.push(".",t.propName);t.between&&r.body.push('if(xindex>1){ out.push("',t.between,'"); } \n')},createArrayTest:"isArray"in Array?function(n){return"Array.isArray(c"+n+")"}:function(n){return"ts.call(c"+n+')==="[object Array]"'},doExec:function(n){var t=this,i="f"+t.definitions.length;t.definitions.push("function "+i+"("+t.fnArgs+") {"," try { with(values) {","  "+n," }} catch(e) {",'Ext.log("XTemplate Error: " + e.message);',"}","}");t.body.push(i+t.callFn+"\n")},addFn:function(n){var t=this,i="f"+t.definitions.length;return n==="."?t.definitions.push("function "+i+"("+t.fnArgs+") {"," return values","}"):n===".."?t.definitions.push("function "+i+"("+t.fnArgs+") {"," return parent","}"):t.definitions.push("function "+i+"("+t.fnArgs+") {"," try { with(values) {","  return("+n+")"," }} catch(e) {",'Ext.log("XTemplate Error: " + e.message);',"}","}"),i},parseTag:function(n){var u=this,f=u.tagRe.exec(n),t,i,e,o,r;if(!f)return null;if(t=f[1],i=f[2],e=f[3],o=f[4],t=="."?(u.validTypes||(u.definitions.push("var validTypes={string:1,number:1,boolean:1};"),u.validTypes=!0),r='validTypes[typeof values] || ts.call(values) === "[object Date]" ? values : ""'):r=t=="#"?"xindex":t=="$"?"xkey":t.substr(0,7)=="parent."?t:isNaN(t)&&t.indexOf("-")==-1&&t.indexOf(".")!=-1?"values."+t:"values['"+t+"']",o&&(r="("+r+o+")"),i&&u.useFormat)e=e?","+e:"",i.substr(0,5)!="this."?i="fm."+i+"(":i+="(";else return r;return i+r+e+")"},evalTpl:function(n){return eval(n),n},newLineRe:/\r\n|\r|\n/g,aposRe:/[']/g,intRe:/^\s*(\d+)\s*$/,tagRe:/^([\w-\.\#\$]+)(?:\:([\w\.]*)(?:\((.*?)?\))?)?(\s?[\+\-\*\/]\s?[\d\.\+\-\*\/\(\)]+)?$/},function(){var n=this.prototype;n.fnArgs="out,values,parent,xindex,xcount,xkey";n.callFn=".call(this,"+n.fnArgs+")"})