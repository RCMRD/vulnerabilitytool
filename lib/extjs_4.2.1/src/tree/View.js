Ext.define("Ext.tree.View",{extend:"Ext.view.Table",alias:"widget.treeview",requires:["Ext.data.NodeStore"],isTreeView:!0,loadingCls:Ext.baseCSSPrefix+"grid-tree-loading",expandedCls:Ext.baseCSSPrefix+"grid-tree-node-expanded",leafCls:Ext.baseCSSPrefix+"grid-tree-node-leaf",expanderSelector:"."+Ext.baseCSSPrefix+"tree-expander",checkboxSelector:"."+Ext.baseCSSPrefix+"tree-checkbox",expanderIconOverCls:Ext.baseCSSPrefix+"tree-expander-over",nodeAnimWrapCls:Ext.baseCSSPrefix+"tree-animator-wrap",blockRefresh:!0,loadMask:!1,rootVisible:!0,deferInitialRefresh:!1,expandDuration:250,collapseDuration:250,toggleOnDblClick:!0,stripeRows:!1,uiFields:["expanded","loaded","checked","expandable","leaf","icon","iconCls","loading","qtip","qtitle"],treeRowTpl:["{%","this.processRowValues(values);","this.nextTpl.applyOut(values, out, parent);",'delete values.rowAttr["data-qtip"];','delete values.rowAttr["data-qtitle"];',"%}",{priority:10,processRowValues:function(n){var t=n.record,i=n.view,r=t.get("qtip"),u=t.get("qttle");n.rowAttr={};r&&(n.rowAttr["data-qtip"]=r);u&&(n.rowAttr["data-qtitle"]=u);t.isExpanded()&&n.rowClasses.push(i.expandedCls);t.isLeaf()&&n.rowClasses.push(i.leafCls);t.isLoading()&&n.rowClasses.push(i.loadingCls)}}],initComponent:function(){var n=this,i=n.panel.getStore(),t=n.store;n.initialConfig.animate===undefined&&(n.animate=Ext.enableFx);t&&t!==i||(n.store=t=new Ext.data.NodeStore({treeStore:i,recursive:!0,rootVisible:n.rootVisible}));n.node&&n.setRootNode(n.node);n.animQueue={};n.animWraps={};n.addEvents("afteritemexpand","afteritemcollapse","nodedragover");n.callParent(arguments);n.addRowTpl(Ext.XTemplate.getTpl(n,"treeRowTpl"))},onBeforeFill:function(){this.store.suspendEvents()},onFillComplete:function(n,t,i){var r=this,u=r.store,f=u.indexOf(i[0]);if(u.resumeEvents(),t.triggerUIUpdate(),i.length&&f!==-1){r.onAdd(r.store,i,f);r.refreshPartner()}},onBeforeSort:function(){this.store.suspendEvents()},onSort:function(n){n.isStore&&(this.store.resumeEvents(),this.refresh(),this.refreshPartner())},refreshPartner:function(){var n=this.lockingPartner;n&&n.refresh()},getMaskStore:function(){return this.panel.getStore()},afterRender:function(){var n=this;n.callParent(arguments);n.el.on({scope:n,delegate:n.expanderSelector,mouseover:n.onExpanderMouseOver,mouseout:n.onExpanderMouseOut,click:{delegate:n.checkboxSelector,fn:n.onCheckboxChange,scope:n}})},afterComponentLayout:function(){this.callParent(arguments);var n=this.stretcher;n&&n.setWidth(this.getWidth()-Ext.getScrollbarSize().width)},processUIEvent:function(n){return n.getTarget("."+this.nodeAnimWrapCls,this.el)?!1:this.callParent(arguments)},onClear:function(){this.store.removeAll()},setRootNode:function(n){var t=this;t.store.setNode(n);t.node=n},onCheckboxChange:function(n){var t=this,i=n.getTarget(t.getItemSelector(),t.getTargetEl());if(i)t.onCheckChange(t.getRecord(i))},onCheckChange:function(n){var t=n.get("checked");Ext.isBoolean(t)&&(t=!t,n.set("checked",t),this.fireEvent("checkchange",n,t))},getChecked:function(){var n=[];return this.node.cascadeBy(function(t){t.get("checked")&&n.push(t)}),n},isItemChecked:function(n){return n.get("checked")},createAnimWrap:function(n){var t=this,r=t.getNode(n),i,u,f=[];return t.renderColumnSizer(f),u=Ext.get(r),i=u.insertSibling({tag:"tr",html:['<td colspan="'+t.panel.headerCt.getColumnCount()+'">','<div class="'+t.nodeAnimWrapCls+'">','<table class="'+Ext.baseCSSPrefix+t.id+"-table "+Ext.baseCSSPrefix+'grid-table" style="border:0" cellspacing="0" cellpadding="0">',f.join(""),"<tbody><\/tbody><\/table>","<\/div>","<\/td>"].join("")},"after"),{record:n,node:r,el:i,expanding:!1,collapsing:!1,animating:!1,animateEl:i.down("div"),targetEl:i.down("tbody")}},getAnimWrap:function(n,t){if(!this.animate)return null;var r=this.animWraps,i=r[n.internalId];if(t!==!1)while(!i&&n)n=n.parentNode,n&&(i=r[n.internalId]);return i},doAdd:function(n,t){var i=this,f=i.bufferRender(n,t,!0),c=n[0],u=c.parentNode,l=i.all,e,r=i.getAnimWrap(u),o,s,h;if(!r||!r.expanding)return i.callParent(arguments);if(u=r.record,o=r.targetEl,s=o.dom.childNodes,h=s.length,e=t-i.indexInStore(u)-1,!h||e>=h?o.appendChild(f):Ext.fly(s[e]).insertSibling(f,"before",!0),l.insert(t,f),r.isAnimating)i.onExpand(u)},onRemove:function(n,t,i){var u=this,f,r;if(u.viewReady){if(f=u.store.getCount()===0,f)u.refresh();else for(r=i.length-1;r>=0;--r)u.doRemove(t[r],i[r]);if(u.hasListeners.itemremove)for(r=i.length-1;r>=0;--r)u.fireEvent("itemremove",t[r],i[r])}},doRemove:function(n,t){var r=this,u=r.all,i=r.getAnimWrap(n),f=u.item(t),e=f?f.dom:null;if(!e||!i||!i.collapsing)return r.callParent(arguments);i.targetEl.dom.insertBefore(e,i.targetEl.dom.firstChild);u.removeElement(t)},onBeforeExpand:function(n){var t=this,i;t.rendered&&t.all.getCount()&&t.animate&&t.getNode(n)&&(i=t.getAnimWrap(n,!1),i?i.collapsing&&i.targetEl.select(t.itemSelector).remove():(i=t.animWraps[n.internalId]=t.createAnimWrap(n),i.animateEl.setHeight(0)),i.expanding=!0,i.collapsing=!1)},onExpand:function(n){var t=this,o=t.animQueue,s=n.getId(),r=t.getNode(n),f=r?t.indexOf(r):-1,i,u,e,h=Ext.isIEQuirks?1:0;if(t.singleExpand&&t.ensureSingleExpand(n),f!==-1){if(i=t.getAnimWrap(n,!1),!i){n.isExpandingOrCollapsing=!1;t.fireEvent("afteritemexpand",n,f,r);t.refreshSize();return}u=i.animateEl;e=i.targetEl;u.stopAnimation();o[s]=!0;u.dom.style.height=h+"px";u.animate({from:{height:h},to:{height:e.getHeight()},duration:t.expandDuration,listeners:{afteranimate:function(){var n=e.query(t.itemSelector);n.length&&i.el.insertSibling(n,"before",!0);i.el.remove();t.refreshSize();delete t.animWraps[i.record.internalId];delete o[s]}},callback:function(){n.isExpandingOrCollapsing=!1;t.fireEvent("afteritemexpand",n,f,r)}});i.isAnimating=!0}},onBeforeCollapse:function(n,t,i,r,u){var f=this,e;f.rendered&&f.all.getCount()&&(f.animate?Ext.Array.contains(n.stores,f.store)&&(e=f.getAnimWrap(n),e?e.expanding&&e.targetEl.select(this.itemSelector).remove():e=f.animWraps[n.internalId]=f.createAnimWrap(n,i),e.expanding=!1,e.collapsing=!0,e.callback=r,e.scope=u):(f.onCollapseCallback=r,f.onCollapseScope=u))},onCollapse:function(n){var t=this,f=t.animQueue,e=n.getId(),r=t.getNode(n),o=r?t.indexOf(r):-1,i=t.getAnimWrap(n),u;if(t.all.getCount()&&Ext.Array.contains(n.stores,t.store)){if(!i){n.isExpandingOrCollapsing=!1;t.fireEvent("afteritemcollapse",n,o,r);t.refreshSize();Ext.callback(t.onCollapseCallback,t.onCollapseScope);t.onCollapseCallback=t.onCollapseScope=null;return}u=i.animateEl;f[e]=!0;u.stopAnimation();u.animate({to:{height:Ext.isIEQuirks?1:0},duration:t.collapseDuration,listeners:{afteranimate:function(){i.el.remove();t.refreshSize();delete t.animWraps[i.record.internalId];delete f[e]}},callback:function(){n.isExpandingOrCollapsing=!1;t.fireEvent("afteritemcollapse",n,o,r);Ext.callback(i.callback,i.scope);i.callback=i.scope=null}});i.isAnimating=!0}},isAnimating:function(n){return!!this.animQueue[n.getId()]},expand:function(n,t,i,r){var e=this,u=!!e.animate,f;if(!u||!n.isExpandingOrCollapsing)return n.isLeaf()||(n.isExpandingOrCollapsing=u),Ext.suspendLayouts(),f=n.expand(t,i,r),Ext.resumeLayouts(!0),f},collapse:function(n,t,i,r){var f=this,u=!!f.animate;if(!u||!n.isExpandingOrCollapsing)return n.isLeaf()||(n.isExpandingOrCollapsing=u),n.collapse(t,i,r)},toggle:function(n,t,i,r){n.isExpanded()?this.collapse(n,t,i,r):this.expand(n,t,i,r)},onItemDblClick:function(n){var t=this,i=t.editingPlugin;t.callParent(arguments);!t.toggleOnDblClick||!n.isExpandable()||i&&i.clicksToEdit===2||t.toggle(n)},onBeforeItemMouseDown:function(n,t,i,r){return r.getTarget(this.expanderSelector,t)?!1:this.callParent(arguments)},onItemClick:function(n,t,i,r){return r.getTarget(this.expanderSelector,t)&&n.isExpandable()?(this.toggle(n,r.ctrlKey),!1):this.callParent(arguments)},onExpanderMouseOver:function(n){n.getTarget(this.cellSelector,10,!0).addCls(this.expanderIconOverCls)},onExpanderMouseOut:function(n){n.getTarget(this.cellSelector,10,!0).removeCls(this.expanderIconOverCls)},getStoreListeners:function(){var n=this,t=n.callParent(arguments);return Ext.apply(t,{beforeexpand:n.onBeforeExpand,expand:n.onExpand,beforecollapse:n.onBeforeCollapse,collapse:n.onCollapse,write:n.onStoreWrite,datachanged:n.onStoreDataChanged})},onBindStore:function(){var n=this,t=n.getTreeStore();n.callParent(arguments);n.mon(t,{scope:n,beforefill:n.onBeforeFill,fillcomplete:n.onFillComplete});t.remoteSort||n.mon(t,{scope:n,beforesort:n.onBeforeSort,sort:n.onSort})},onUnbindStore:function(){var n=this,t=n.getTreeStore();n.callParent(arguments);n.mun(t,{scope:n,beforefill:n.onBeforeFill,fillcomplete:n.onFillComplete});t.remoteSort||n.mun(t,{scope:n,beforesort:n.onBeforeSort,sort:n.onSort})},getTreeStore:function(){return this.panel.store},ensureSingleExpand:function(n){var t=n.parentNode;t&&t.eachChild(function(t){t!==n&&t.isExpanded()&&t.collapse()})},shouldUpdateCell:function(n,t,i){if(i)for(var r=0,u=i.length;r<u;++r)if(Ext.Array.contains(this.uiFields,i[r]))return!0;return this.callParent(arguments)},onStoreWrite:function(n,t){var i=this.panel.store;i.fireEvent("write",i,t)},onStoreDataChanged:function(){var n=this.panel.store;n.fireEvent("datachanged",n)}})