Ext.define("Ext.tree.ViewDropZone",{extend:"Ext.view.DropZone",allowParentInserts:!1,allowContainerDrops:!1,appendOnly:!1,expandDelay:500,indicatorCls:Ext.baseCSSPrefix+"tree-ddindicator",expandNode:function(n){var t=this.view;this.expandProcId=!1;n.isLeaf()||n.isExpanded()||(t.expand(n),this.expandProcId=!1)},queueExpand:function(n){this.expandProcId=Ext.Function.defer(this.expandNode,this.expandDelay,this,[n])},cancelExpand:function(){this.expandProcId&&(clearTimeout(this.expandProcId),this.expandProcId=!1)},getPosition:function(n,t){var s=this.view,r=s.getRecord(t),u=n.getPageY(),f=r.isLeaf(),o=!1,i=Ext.fly(t).getRegion(),e;return r.isRoot()?"append":this.appendOnly?f?!1:"append":(this.allowParentInserts||(o=r.hasChildNodes()&&r.isExpanded()),e=(i.bottom-i.top)/(f?2:3),u>=i.top&&u<i.top+e?"before":!o&&(f||u>=i.bottom-e&&u<=i.bottom)?"after":"append")},isValidDropPoint:function(n,t,i,r,u){if(!n||!u.item)return!1;var h=this.view,f=h.getRecord(n),e=u.records,c=e.length,l=e.length,o,s;if(!(f&&t&&c))return!1;for(o=0;o<l;o++)if(s=e[o],s.isNode&&s.contains(f))return!1;return t==="append"&&f.get("allowDrop")===!1?!1:t!="append"&&f.parentNode.get("allowDrop")===!1?!1:Ext.Array.contains(e,f)?!1:h.fireEvent("nodedragover",f,t,u,r)!==!1},onNodeOver:function(n,t,i,r){var f=this.getPosition(i,n),e=this.dropNotAllowed,h=this.view,u=h.getRecord(n),o=this.getIndicator(),s=0;return this.cancelExpand(),f!="append"||this.expandProcId||Ext.Array.contains(r.records,u)||u.isLeaf()||u.isExpanded()||this.queueExpand(u),this.isValidDropPoint(n,f,t,i,r)?(this.valid=!0,this.currentPosition=f,this.overRecord=u,o.setWidth(Ext.fly(n).getWidth()),s=Ext.fly(n).getY()-Ext.fly(h.el).getY()-1,f=="before"?(e=u.isFirst()?Ext.baseCSSPrefix+"tree-drop-ok-above":Ext.baseCSSPrefix+"tree-drop-ok-between",o.showAt(0,s),t.proxy.show()):f=="after"?(e=u.isLast()?Ext.baseCSSPrefix+"tree-drop-ok-below":Ext.baseCSSPrefix+"tree-drop-ok-between",s+=Ext.fly(n).getHeight(),o.showAt(0,s),t.proxy.show()):(e=Ext.baseCSSPrefix+"tree-drop-ok-append",o.hide())):this.valid=!1,this.currentCls=e,e},onNodeOut:function(){this.valid=!1;this.getIndicator().hide()},onContainerOver:function(n,t){return t.getTarget("."+this.indicatorCls)?this.currentCls:this.dropNotAllowed},notifyOut:function(){this.callParent(arguments);this.cancelExpand()},handleNodeDrop:function(n,t,i){var e=this,c=e.view,o=t?t.parentNode:c.panel.getRootNode(),a=c.getStore().treeStore.model,v,u,s,r,h,f,y,l;if(n.copy)for(v=n.records,n.records=[],u=0,s=v.length;u<s;u++)r=v[u],r.isNode?n.records.push(r.copy(undefined,!0)):n.records.push(new a(r.data,r.getId()));if(e.cancelExpand(),i=="before"?(h=o.insertBefore,f=[null,t],t=o):i=="after"?(t.nextSibling?(h=o.insertBefore,f=[null,t.nextSibling]):(h=o.appendChild,f=[null]),t=o):(t.isExpanded()||t.isLoading()||(y=!0),h=t.appendChild,f=[null]),l=function(){var o,i;for(Ext.suspendLayouts(),c.getSelectionModel().clearSelections(),u=0,s=n.records.length;u<s;u++)r=n.records[u],r.isNode||(r=r.isModel?new a(r.data,r.getId()):new a(r),n.records[u]=r),f[0]=r,h.apply(t,f);if(e.sortOnDrop&&t.sort(t.getOwnerTree().store.generateComparator()),Ext.resumeLayouts(!0),Ext.enableFx&&e.dropHighlight)for(o=e.dropHighlightColor,u=0;u<s;u++)i=c.getNode(n.records[u]),i&&Ext.fly(i).highlight(o)},y)t.expand(!1,l);else if(t.isLoading())t.on({expand:l,delay:1,single:!0});else l()}})