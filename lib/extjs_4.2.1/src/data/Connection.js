Ext.define("Ext.data.Connection",{mixins:{observable:"Ext.util.Observable"},requires:["Ext.data.flash.BinaryXhr"],statics:{requestId:0},url:null,async:!0,method:null,username:"",password:"",disableCaching:!0,withCredentials:!1,binary:!1,cors:!1,isXdr:!1,defaultXdrContentType:"text/plain",disableCachingParam:"_dc",timeout:3e4,useDefaultHeader:!0,defaultPostHeader:"application/x-www-form-urlencoded; charset=UTF-8",useDefaultXhrHeader:!0,defaultXhrHeader:"XMLHttpRequest",constructor:function(n){n=n||{};Ext.apply(this,n);this.requests={};this.mixins.observable.constructor.call(this)},request:function(n){n=n||{};var t=this,o=n.scope||window,s=n.username||t.username,h=n.password||t.password||"",f,r,i,e,u;return t.fireEvent("beforerequest",t,n)!==!1?(r=t.setOptions(n,o),t.isFormUpload(n))?(t.upload(n.form,r.url,r.data,n),null):((n.autoAbort||t.autoAbort)&&t.abort(),f=n.async!==!1?n.async||t.async:!1,u=t.openRequest(n,r,f,s,h),t.isXdr||(e=t.setupHeaders(u,n,r.data,r.params)),i={id:++Ext.data.Connection.requestId,xhr:u,headers:e,options:n,async:f,binary:n.binary||t.binary,timeout:setTimeout(function(){i.timedout=!0;t.abort(i)},n.timeout||t.timeout)},t.requests[i.id]=i,t.latestId=i.id,f&&(t.isXdr||(u.onreadystatechange=Ext.Function.bind(t.onStateChange,t,[i]))),t.isXdr&&t.processXdrRequest(i,u),u.send(r.data),!f)?t.onComplete(i):i:(Ext.callback(n.callback,n.scope,[n,undefined,undefined]),null)},processXdrRequest:function(n,t){var i=this;delete n.headers;n.contentType=n.options.contentType||i.defaultXdrContentType;t.onload=Ext.Function.bind(i.onStateChange,i,[n,!0]);t.onerror=t.ontimeout=Ext.Function.bind(i.onStateChange,i,[n,!1])},processXdrResponse:function(n,t){n.getAllResponseHeaders=function(){return[]};n.getResponseHeader=function(){return""};n.contentType=t.contentType||this.defaultXdrContentType},upload:function(n,t,i,r){n=Ext.getDom(n);r=r||{};var u=Ext.id(),o=document.createElement("iframe"),a=[],v="multipart/form-data",y={target:n.target,method:n.method,encoding:n.encoding,enctype:n.enctype,action:n.action},p=function(t,i){s=document.createElement("input");Ext.fly(s).set({type:"hidden",value:i,name:t});n.appendChild(s);a.push(s)},s,h,f,e,w,c,b,l;if(Ext.fly(o).set({id:u,name:u,cls:Ext.baseCSSPrefix+"hide-display",src:Ext.SSL_SECURE_URL}),document.body.appendChild(o),document.frames&&(document.frames[u].name=u),Ext.fly(n).set({target:u,method:"POST",enctype:v,encoding:v,action:t||y.action}),i){h=Ext.Object.fromQueryString(i)||{};for(e in h)if(h.hasOwnProperty(e))if(f=h[e],Ext.isArray(f))for(w=f.length,c=0;c<w;c++)p(e,f[c]);else p(e,f)}Ext.fly(o).on("load",Ext.Function.bind(this.onUploadComplete,this,[o,r]),null,{single:!Ext.isOpera});for(n.submit(),Ext.fly(n).set(y),b=a.length,l=0;l<b;l++)Ext.removeNode(a[l])},onUploadComplete:function(n,t){var o=this,r={responseText:"",responseXML:null},f,e,i,u;try{if(i=n.contentWindow.document||n.contentDocument||window.frames[n.id].document,i){if(Ext.isOpera&&i.location=="about:blank")return;i.body&&(r.responseText=(u=i.body.firstChild)&&/pre/i.test(u.tagName)?u.textContent:(u=i.getElementsByTagName("textarea")[0])?u.value:i.body.textContent||i.body.innerText);r.responseXML=i.XMLDocument||i;f=t.success;e=!0}}catch(s){r.responseText='{success:false,message:"'+Ext.String.trim(s.message||s.description)+'"}';f=t.failure;e=!1}o.fireEvent("requestcomplete",o,r,t);Ext.callback(f,t.scope,[r,t]);Ext.callback(t.callback,t.scope,[t,e,r]);setTimeout(function(){Ext.removeNode(n)},100)},isFormUpload:function(n){var t=this.getForm(n);return t?n.isUpload||/multipart\/form-data/i.test(t.getAttribute("enctype")):!1},getForm:function(n){return Ext.getDom(n.form)||null},setOptions:function(n,t){var f=this,i=n.params||{},o=f.extraParams,e=n.urlParams,r=n.url||f.url,h=n.jsonData,s,c,u;return Ext.isFunction(i)&&(i=i.call(t,n)),Ext.isFunction(r)&&(r=r.call(t,n)),r=this.setupUrl(n,r),r||Ext.Error.raise({options:n,msg:"No URL specified"}),u=n.rawData||n.binaryData||n.xmlData||h||null,h&&!Ext.isPrimitive(h)&&(u=Ext.encode(u)),n.binaryData&&(Ext.isArray(n.binaryData)||Ext.log.warn("Binary submission data must be an array of byte values! Instead got "+typeof n.binaryData),f.nativeBinaryPostSupport()&&(u=new Uint8Array(n.binaryData),(Ext.isChrome&&Ext.chromeVersion<22||Ext.isSafari||Ext.isGecko)&&(u=u.buffer))),Ext.isObject(i)&&(i=Ext.Object.toQueryString(i)),Ext.isObject(o)&&(o=Ext.Object.toQueryString(o)),i=i+(o?(i?"&":"")+o:""),e=Ext.isObject(e)?Ext.Object.toQueryString(e):e,i=this.setupParams(n,i),s=(n.method||f.method||(i||u?"POST":"GET")).toUpperCase(),this.setupMethod(n,s),c=n.disableCaching!==!1?n.disableCaching||f.disableCaching:!1,s==="GET"&&c&&(r=Ext.urlAppend(r,(n.disableCachingParam||f.disableCachingParam)+"="+(new Date).getTime())),(s=="GET"||u)&&i&&(r=Ext.urlAppend(r,i),i=null),e&&(r=Ext.urlAppend(r,e)),{url:r,method:s,data:u||i||null}},setupUrl:function(n,t){var i=this.getForm(n);return i&&(t=t||i.action),t},setupParams:function(n,t){var r=this.getForm(n),i;return r&&!this.isFormUpload(n)&&(i=Ext.Element.serializeForm(r),t=t?t+"&"+i:i),t},setupMethod:function(n,t){return this.isFormUpload(n)?"POST":t},setupHeaders:function(n,t,i,r){var f=this,u=Ext.apply({},t.headers||{},f.defaultHeaders||{}),o=f.defaultPostHeader,h=t.jsonData,c=t.xmlData,e,s;!u["Content-Type"]&&(i||r)&&(i&&(t.rawData?o="text/plain":c&&Ext.isDefined(c)?o="text/xml":h&&Ext.isDefined(h)&&(o="application/json")),u["Content-Type"]=o);f.useDefaultXhrHeader&&!u["X-Requested-With"]&&(u["X-Requested-With"]=f.defaultXhrHeader);try{for(e in u)u.hasOwnProperty(e)&&(s=u[e],n.setRequestHeader(e,s))}catch(l){f.fireEvent("exception",e,s)}return u},newRequest:function(n){var t=this,i;return n.binaryData?i=t.nativeBinaryPostSupport()?this.getXhrInstance():new Ext.data.flash.BinaryXhr:(n.cors||t.cors)&&Ext.isIE&&Ext.ieVersion<=9?(i=t.getXdrInstance(),t.isXdr=!0):i=t.getXhrInstance(),i},openRequest:function(n,t,i,r,u){var e=this,f=e.newRequest(n);return r?f.open(t.method,t.url,i,r,u):e.isXdr?f.open(t.method,t.url):f.open(t.method,t.url,i),(n.binary||e.binary)&&(window.Uint8Array?f.responseType="arraybuffer":f.overrideMimeType?f.overrideMimeType("text/plain; charset=x-user-defined"):Ext.isIE||Ext.log.warn("Your does not support loading binary data using Ajax.")),(n.withCredentials||e.withCredentials)&&(f.withCredentials=!0),f},getXdrInstance:function(){var n;return Ext.ieVersion>=8?n=new XDomainRequest:Ext.Error.raise({msg:"Your browser does not support CORS"}),n},getXhrInstance:function(){for(var i=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new ActiveXObject("MSXML2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],n=0,r=i.length,t;n<r;++n)try{t=i[n];t();break}catch(u){}return t}(),isLoading:function(n){if(n||(n=this.getLatest()),!(n&&n.xhr))return!1;var t=n.xhr.readyState;return n.xhr instanceof Ext.data.flash.BinaryXhr&&t!=4||!(t===0||t==4)},abort:function(n){var t=this,i;if(n||(n=t.getLatest()),n&&t.isLoading(n)){i=n.xhr;try{i.onreadystatechange=null}catch(r){i.onreadystatechange=Ext.emptyFn}i.abort();t.clearTimeout(n);n.timedout||(n.aborted=!0);t.onComplete(n);t.cleanup(n)}},abortAll:function(){var n=this.requests;for(var t in n)n.hasOwnProperty(t)&&this.abort(n[t])},getLatest:function(){var n=this.latestId,t;return n&&(t=this.requests[n]),t||null},onStateChange:function(n,t){var i=this;if(n.xhr&&n.xhr.readyState==4||i.isXdr){i.clearTimeout(n);i.onComplete(n,t);i.cleanup(n);Ext.EventManager.idleEvent.fire()}},clearTimeout:function(n){clearTimeout(n.timeout);delete n.timeout},cleanup:function(n){n.xhr=null;delete n.xhr},onComplete:function(n,t){var r=this,i=n.options,f,e,u;try{f=r.parseStatus(n.xhr.status)}catch(o){f={success:!1,isException:!1}}return e=r.isXdr?t:f.success,e?(u=r.createResponse(n),r.fireEvent("requestcomplete",r,u,i),Ext.callback(i.success,i.scope,[u,i])):(u=f.isException||n.aborted||n.timedout?r.createException(n):r.createResponse(n),r.fireEvent("requestexception",r,u,i),Ext.callback(i.failure,i.scope,[u,i])),Ext.callback(i.callback,i.scope,[i,e,u]),delete r.requests[n.id],u},parseStatus:function(n){n=n==1223?204:n;var t=n>=200&&n<300||n==304,i=!1;if(!t)switch(n){case 12002:case 12029:case 12030:case 12031:case 12152:case 13030:i=!0}return{success:t,isException:i}},createResponse:function(n){for(var f=this,t=n.xhr,o=f.isXdr,e={},s=o?[]:t.getAllResponseHeaders().replace(/\r\n/g,"\n").split("\n"),h=s.length,u,i,c,r;h--;)u=s[h],i=u.indexOf(":"),i>=0&&(c=u.substr(0,i).toLowerCase(),u.charAt(i+1)==" "&&++i,e[c]=u.substr(i+1));return n.xhr=null,delete n.xhr,r={request:n,requestId:n.id,status:t.status,statusText:t.statusText,getResponseHeader:function(n){return e[n.toLowerCase()]},getAllResponseHeaders:function(){return e}},o&&f.processXdrResponse(r,t),n.binary?r.responseBytes=f.getByteArray(t):(r.responseText=t.responseText,r.responseXML=t.responseXML),t=null,r},createException:function(n){return{request:n,requestId:n.id,status:n.aborted?-1:0,statusText:n.aborted?"transaction aborted":"communication failure",aborted:n.aborted,timedout:n.timedout}},getByteArray:function(n){var u=n.response,e=n.responseBody,t,r,f,i;if(n instanceof Ext.data.flash.BinaryXhr)t=n.responseBytes;else if(window.Uint8Array)t=u?new Uint8Array(u):[];else if(Ext.isIE9p)try{t=new VBArray(e).toArray()}catch(o){t=[]}else if(Ext.isIE)this.self.vbScriptInjected||this.injectVBScript(),getIEByteArray(n.responseBody,t=[]);else for(t=[],r=n.responseText,f=r.length,i=0;i<f;i++)t.push(r.charCodeAt(i)&255);return t},injectVBScript:function(){var n=document.createElement("script");n.type="text/vbscript";n.text="Function getIEByteArray(byteArray, out)\nDim len, i\nlen = LenB(byteArray)\nFor i = 1 to len\nout.push(AscB(MidB(byteArray, i, 1)))\nNext\nEnd Function";Ext.getHead().dom.appendChild(n);this.self.vbScriptInjected=!0},nativeBinaryPostSupport:function(){return Ext.isChrome||Ext.isSafari&&Ext.isDefined(window.Uint8Array)||Ext.isGecko&&Ext.isDefined(window.Uint8Array)}})