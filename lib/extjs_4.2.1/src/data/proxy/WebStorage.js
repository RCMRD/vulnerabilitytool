Ext.define("Ext.data.proxy.WebStorage",{extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.WebStorageProxy",requires:["Ext.data.SequentialIdGenerator"],id:undefined,constructor:function(){this.callParent(arguments);this.cache={};this.getStorageObject()===undefined&&Ext.Error.raise("Local Storage is not supported in this browser, please use another type of data proxy");this.id=this.id||(this.store?this.store.storeId:undefined);this.id===undefined&&Ext.Error.raise("No unique id was provided to the local storage proxy. See Ext.data.proxy.LocalStorage documentation for details");this.initialize()},create:function(n,t,i){var r=this,o=n.records,h=o.length,s=r.getIds(),f,u,e;for(n.setStarted(),r.isHierarchical===undefined&&(r.isHierarchical=!!o[0].isNode,r.isHierarchical&&r.getStorageObject().setItem(r.getTreeKey(),!0)),e=0;e<h;e++)u=o[e],u.phantom?(u.phantom=!1,f=r.getNextId()):f=u.getId(),r.setRecord(u,f),u.commit(),s.push(f);r.setIds(s);n.setCompleted();n.setSuccessful();typeof t=="function"&&t.call(i||r,n)},read:function(n,t,i){var r=this,e=[],o=0,c=!0,l=r.model,s,a,h,u,f;if(n.setStarted(),r.isHierarchical)e=r.getTreeData();else if(s=r.getIds(),a=s.length,f=n.id,f)u=r.getRecord(f),u!==null&&(h=new l(u,f,u)),h?e.push(h):c=!1;else for(;o<a;o++)f=s[o],u=r.getRecord(f),e.push(new l(u,f,u));c&&n.setSuccessful();n.setCompleted();n.resultSet=Ext.create("Ext.data.ResultSet",{records:e,total:e.length,loaded:!0});typeof t=="function"&&t.call(i||r,n)},update:function(n,t,i){var o=n.records,s=o.length,e=this.getIds(),r,u,f;for(n.setStarted(),f=0;f<s;f++)r=o[f],this.setRecord(r),r.commit(),u=r.getId(),u!==undefined&&Ext.Array.indexOf(e,u)==-1&&e.push(u);this.setIds(e);n.setCompleted();n.setSuccessful();typeof t=="function"&&t.call(i||this,n)},destroy:function(n,t,i){var u=this,e=n.records,o=u.getIds(),c=o.length,s=[],h={},r=e.length,f;for(n.setStarted();r--;)Ext.apply(h,u.removeRecord(e[r]));for(r=0;r<c;r++)f=o[r],h[f]||s.push(f);u.setIds(s);n.setCompleted();n.setSuccessful();typeof t=="function"&&t.call(i||u,n)},getRecord:function(n){var t=this,r=t.cache,i=r[n]?r[n]:Ext.decode(t.getStorageObject().getItem(t.getRecordKey(n)));return i?(r[n]=i,i[t.model.prototype.idProperty]=n,i):null},setRecord:function(n,t){t?n.setId(t):t=n.getId();for(var i=this,c=n.data,r={},l=i.model,h=l.prototype.fields.items,a=h.length,u=0,f,e,o,s;u<a;u++)f=h[u],e=f.name,f.persist&&(r[e]=c[e]);delete r[i.model.prototype.idProperty];n.isNode&&n.get("depth")===1&&delete r.parentId;o=i.getStorageObject();s=i.getRecordKey(t);i.cache[t]=r;o.removeItem(s);o.setItem(s,Ext.encode(r))},removeRecord:function(n){var t=this,i=n.getId(),r={},u,f;if(r[i]=n,t.getStorageObject().removeItem(t.getRecordKey(i)),delete t.cache[i],n.childNodes)for(f=n.childNodes,u=f.length;u--;)Ext.apply(r,t.removeRecord(f[u]));return r},getRecordKey:function(n){return n.isModel&&(n=n.getId()),Ext.String.format("{0}-{1}",this.id,n)},getRecordCounterKey:function(){return Ext.String.format("{0}-counter",this.id)},getTreeKey:function(){return Ext.String.format("{0}-tree",this.id)},getIds:function(){var i=this,n=(i.getStorageObject().getItem(i.id)||"").split(","),r=i.model,u=n.length,f=r.prototype.fields.get(r.prototype.idProperty).type.type==="string",t;if(u==1&&n[0]==="")n=[];else for(t=0;t<u;t++)n[t]=f?n[t]:+n[t];return n},setIds:function(n){var t=this.getStorageObject(),i=n.join(",");t.removeItem(this.id);Ext.isEmpty(i)||t.setItem(this.id,i)},getNextId:function(){var t=this,r=t.getStorageObject(),u=t.getRecordCounterKey(),i=t.model,f=i.prototype.fields.get(i.prototype.idProperty).type.type==="string",n;return n=t.idGenerator.generate(),r.setItem(u,n),f||(n=+n),n},getTreeData:function(){for(var r=this,c=r.getIds(),e=c.length,u=[],l={},i=[],t=0,a=r.model,v=a.prototype.idProperty,o,n,f,s,y,h;t<e;t++)h=c[t],n=r.getRecord(h),u.push(n),l[h]=n,n.parentId||i.push(n);for(o=i.length,Ext.Array.sort(u,r.sortByParentId),t=o;t<e;t++)n=u[t],s=n.parentId,f&&f[v]===s||(f=l[s],f.children=y=[]),y.push(n);for(t=e;t--;)n=u[t],n.children||n.leaf||(n.loaded=!0);for(t=o;t--;)n=i[t],i[t]=new a(n,n[v],n);return i},sortByParentId:function(n,t){return(n.parentId||0)-(t.parentId||0)},initialize:function(){var n=this,t=n.getStorageObject(),i=+t.getItem(n.getRecordCounterKey());t.setItem(n.id,t.getItem(n.id)||"");t.getItem(n.getTreeKey())&&(n.isHierarchical=!0);n.idGenerator=new Ext.data.SequentialIdGenerator({seed:i?i+1:1})},clear:function(){for(var n=this,t=n.getStorageObject(),r=n.getIds(),u=r.length,i=0;i<u;i++)t.removeItem(n.getRecordKey(r[i]));t.removeItem(n.getRecordCounterKey());t.removeItem(n.getTreeKey());t.removeItem(n.id);n.cache={}},getStorageObject:function(){Ext.Error.raise("The getStorageObject function has not been defined in your Ext.data.proxy.WebStorage subclass")}})