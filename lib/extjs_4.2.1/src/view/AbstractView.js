Ext.define("Ext.view.AbstractView",{extend:"Ext.Component",requires:["Ext.LoadMask","Ext.data.StoreManager","Ext.CompositeElementLite","Ext.DomQuery","Ext.selection.DataViewModel"],mixins:{bindable:"Ext.util.Bindable"},inheritableStatics:{getRecord:function(n){return this.getBoundView(n).getRecord(n)},getBoundView:function(n){return Ext.getCmp(n.boundView)}},deferInitialRefresh:!0,itemCls:Ext.baseCSSPrefix+"dataview-item",loadingText:"Loading...",loadMask:!0,loadingUseMsg:!0,selectedItemCls:Ext.baseCSSPrefix+"item-selected",emptyText:"",deferEmptyText:!0,trackOver:!1,blockRefresh:!1,preserveScrollOnRefresh:!1,last:!1,triggerEvent:"itemclick",triggerCtEvent:"containerclick",addCmpEvents:function(){},initComponent:function(){var n=this,i=Ext.isDefined,t=n.itemTpl,r={};t&&(Ext.isArray(t)?t=t.join(""):Ext.isObject(t)&&(r=Ext.apply(r,t.initialConfig),t=t.html),n.itemSelector||(n.itemSelector="."+n.itemCls),t=Ext.String.format('<tpl for="."><div class="{0}">{1}<\/div><\/tpl>',n.itemCls,t),n.tpl=new Ext.XTemplate(t,r));i(n.tpl)&&i(n.itemSelector)||Ext.Error.raise({sourceClass:"Ext.view.View",tpl:n.tpl,itemSelector:n.itemSelector,msg:"DataView requires both tpl and itemSelector configurations to be defined."});n.callParent();n.tpl=n.getTpl("tpl");(i(n.overCls)||i(n.overClass))&&(Ext.isDefined(Ext.global.console)&&Ext.global.console.warn("Ext.view.View: Using the deprecated overCls or overClass configuration. Use overItemCls instead."),n.overItemCls=n.overCls||n.overClass,delete n.overCls,delete n.overClass);(i(n.selectedCls)||i(n.selectedClass))&&(Ext.isDefined(Ext.global.console)&&Ext.global.console.warn("Ext.view.View: Using the deprecated selectedCls or selectedClass configuration. Use selectedItemCls instead."),n.selectedItemCls=n.selectedCls||n.selectedClass,delete n.selectedCls,delete n.selectedClass);n.overItemCls&&(n.trackOver=!0);n.addEvents("beforerefresh","refresh","viewready","itemupdate","itemadd","itemremove");n.addCmpEvents();n.store=Ext.data.StoreManager.lookup(n.store||"ext-empty-store");n.dataSource||(n.dataSource=n.store);n.bindStore(n.dataSource,!0,"dataSource");n.all||(n.all=new Ext.CompositeElementLite);n.scrollState={top:0,left:0};n.on({scroll:n.onViewScroll,element:"el",scope:n})},onRender:function(){var n=this,t=n.loadMask,r=n.getMaskStore(),i={target:n,msg:n.loadingText,msgCls:n.loadingCls,useMsg:n.loadingUseMsg,store:r};if(n.callParent(arguments),t&&!r.proxy.isSynchronous){Ext.isObject(t)&&(i=Ext.apply(i,t));n.loadMask=new Ext.LoadMask(i);n.loadMask.on({scope:n,beforeshow:n.onMaskBeforeShow,hide:n.onMaskHide})}},finishRender:function(){var n=this;n.callParent(arguments);n.up("[collapsed],[hidden]")||n.doFirstRefresh(n.dataSource)},onBoxReady:function(){var n=this;n.callParent(arguments);n.firstRefreshDone||n.doFirstRefresh(n.dataSource)},getMaskStore:function(){return this.store},onMaskBeforeShow:function(){var n=this,t=n.loadingHeight;t&&t>n.getHeight()&&(n.hasLoadingHeight=!0,n.oldMinHeight=n.minHeight,n.minHeight=t,n.updateLayout())},onMaskHide:function(){var n=this;!n.destroying&&n.hasLoadingHeight&&(n.minHeight=n.oldMinHeight,n.updateLayout(),delete n.hasLoadingHeight)},beforeRender:function(){this.callParent(arguments);this.getSelectionModel().beforeViewRender(this)},afterRender:function(){this.callParent(arguments);this.getSelectionModel().bindComponent(this)},getSelectionModel:function(){var n=this,t="SINGLE";return n.simpleSelect?t="SIMPLE":n.multiSelect&&(t="MULTI"),n.selModel&&n.selModel.events||(n.selModel=new Ext.selection.DataViewModel(Ext.apply({allowDeselect:n.allowDeselect,mode:t},n.selModel))),n.selModel.hasRelaySetup||(n.relayEvents(n.selModel,["selectionchange","beforeselect","beforedeselect","select","deselect","focuschange"]),n.selModel.hasRelaySetup=!0),n.disableSelection&&(n.selModel.locked=!0),n.selModel},refresh:function(){var n=this,i,r,f,e,t,u;n.rendered&&!n.isDestroyed&&(n.hasListeners.beforerefresh&&n.fireEvent("beforerefresh",n)===!1||(i=n.getTargetEl(),u=n.getViewRange(),t=i.dom,n.preserveScrollOnRefresh||(r=t.parentNode,f=t.style.display,t.style.display="none",e=t.nextSibling,r.removeChild(t)),n.refreshCounter?n.clearViewEl():(n.fixedNodes=i.dom.childNodes.length,n.refreshCounter=1),n.tpl.append(i,n.collectData(u,n.all.startIndex)),u.length<1?(this.store.loading||n.deferEmptyText&&!n.hasFirstRefresh||Ext.core.DomHelper.insertHtml("beforeEnd",i.dom,n.emptyText),n.all.clear()):(n.collectNodes(i.dom),n.updateIndexes(0)),n.hasFirstRefresh&&(n.refreshSelmodelOnRefresh!==!1?n.selModel.refresh():n.selModel.pruneIf()),n.hasFirstRefresh=!0,n.preserveScrollOnRefresh||(r.insertBefore(t,e),t.style.display=f),this.refreshSize(),n.fireEvent("refresh",n),n.viewReady||(n.viewReady=!0,n.fireEvent("viewready",n))))},collectNodes:function(n){this.all.fill(Ext.query(this.getItemSelector(),Ext.getDom(n)),this.all.startIndex)},getViewRange:function(){return this.dataSource.getRange()},refreshSize:function(){var n=this.getSizeModel();(n.height.shrinkWrap||n.width.shrinkWrap)&&this.updateLayout()},clearViewEl:function(){var n=this,t=n.getTargetEl();if(n.fixedNodes)while(t.dom.childNodes[n.fixedNodes])t.dom.removeChild(t.dom.childNodes[n.fixedNodes]);else t.update("");n.refreshCounter++},onViewScroll:Ext.emptyFn,onIdChanged:Ext.emptyFn,saveScrollState:function(){if(this.rendered){var n=this.el.dom,t=this.scrollState;t.left=n.scrollLeft;t.top=n.scrollTop}},restoreScrollState:function(){if(this.rendered){var n=this.el.dom,t=this.scrollState;n.scrollLeft=t.left;n.scrollTop=t.top}},prepareData:function(n,t,i){var r,u,f;if(i){r=i.getAssociatedData();for(u in r)r.hasOwnProperty(u)&&(f||(n=Ext.Object.chain(n),f=!0),n[u]=r[u])}return n},collectData:function(n,t){for(var u=[],i=0,f=n.length,r;i<f;i++)r=n[i],u[i]=this.prepareData(r.data,t+i,r);return u},bufferRender:function(n,t){var i=this,r=i.renderBuffer||(i.renderBuffer=document.createElement("div"));return i.tpl.overwrite(r,i.collectData(n,t)),Ext.DomQuery.select(i.getItemSelector(),r)},getNodeContainer:function(){return this.getTargetEl()},onUpdate:function(n,t){var i=this,r,u;if(i.viewReady&&(r=i.dataSource.indexOf(t),r>-1&&(u=i.bufferRender([t],r)[0],i.getNode(t)))){i.all.replaceElement(r,u,!0);i.updateIndexes(r,r);i.selModel.onUpdate(t);return i.hasListeners.itemupdate&&i.fireEvent("itemupdate",t,r,u),u}},onAdd:function(n,t,i){var r=this,u;r.rendered&&(r.all.getCount()===0?(r.refresh(),u=r.all.slice()):(u=r.doAdd(t,i),r.refreshSelmodelOnRefresh!==!1&&r.selModel.refresh(),r.updateIndexes(i),r.refreshSize()),r.hasListeners.itemadd&&r.fireEvent("itemadd",t,i,u))},doAdd:function(n,t){var f=this,i=f.bufferRender(n,t,!0),r=f.all,e=r.getCount(),u,o;if(e===0)for(u=0,o=i.length;u<o;u++)this.getNodeContainer().appendChild(i[u]);else t<e?t===0?r.item(t).insertSibling(i,"before",!0):r.item(t-1).insertSibling(i,"after",!0):r.last().insertSibling(i,"after",!0);return r.insert(t,i),i},onRemove:function(n,t,i){var u=this,o=u.hasListeners.itemremove,r,f,e;if(u.all.getCount()){if(u.dataSource.getCount()===0){if(o)for(r=i.length-1;r>=0;--r)u.fireEvent("itemremove",t[r],i[r]);u.refresh()}else{for(r=i.length-1;r>=0;--r)f=t[r],e=i[r],u.doRemove(f,e),o&&u.fireEvent("itemremove",f,e);u.updateIndexes(i[0])}this.refreshSize()}},doRemove:function(n,t){this.all.removeElement(t,!0)},refreshNode:function(n){this.onUpdate(this.dataSource,this.dataSource.getAt(n))},updateIndexes:function(n,t){var r=this.all.elements,u=this.getViewRange(),i;for(n=n||0,t=t||(t===0?0:r.length-1),i=n;i<=t;i++)r[i].viewIndex=i,r[i].viewRecordId=u[i].internalId,r[i].boundView||(r[i].boundView=this.id)},getStore:function(){return this.store},bindStore:function(n,t){var i=this;i.mixins.bindable.bindStore.apply(i,arguments);t||i.getSelectionModel().bindStore(n);i.componentLayoutCounter&&i.doFirstRefresh(n)},doFirstRefresh:function(n){var t=this;t.firstRefreshDone=!0;n&&!n.loading&&(t.deferInitialRefresh?t.applyFirstRefresh():t.refresh())},applyFirstRefresh:function(){var n=this;n.isDestroyed||(n.up("[isCollapsingOrExpanding]")?Ext.Function.defer(n.applyFirstRefresh,100,n):Ext.Function.defer(function(){n.isDestroyed||n.refresh()},1))},onUnbindStore:function(){this.setMaskBind(null)},onBindStore:function(n,t,i){this.setMaskBind(n);t||i!=="store"||this.bindStore(n,!1,"dataSource")},setMaskBind:function(n){var t=this.loadMask;t&&t.bindStore&&t.bindStore(n)},getStoreListeners:function(){var n=this;return{idchanged:n.onIdChanged,refresh:n.onDataRefresh,add:n.onAdd,bulkremove:n.onRemove,update:n.onUpdate,clear:n.refresh}},onDataRefresh:function(){this.refreshView()},refreshView:function(){var n=this,t=!n.firstRefreshDone&&(!n.rendered||n.up("[collapsed],[isCollapsingOrExpanding],[hidden]"));t?n.deferInitialRefresh=!1:n.blockRefresh!==!0&&(n.firstRefreshDone=!0,n.refresh())},findItemByChild:function(n){return Ext.fly(n).findParent(this.getItemSelector(),this.getTargetEl())},findTargetByEvent:function(n){return n.getTarget(this.getItemSelector(),this.getTargetEl())},getSelectedNodes:function(){for(var t=[],i=this.selModel.getSelection(),r=i.length,n=0;n<r;n++)t.push(this.getNode(i[n]));return t},getRecords:function(n){for(var t=[],i=0,r=n.length,u=this.dataSource.data;i<r;i++)t[t.length]=u.getByKey(n[i].viewRecordId);return t},getRecord:function(n){return this.dataSource.data.getByKey(Ext.getDom(n).viewRecordId)},isSelected:function(n){var t=this.getRecord(n);return this.selModel.isSelected(t)},select:function(n,t,i){this.selModel.select(n,t,i)},deselect:function(n,t){this.selModel.deselect(n,t)},getNode:function(n){return!n&&n!==0||!this.rendered?null:Ext.isString(n)?document.getElementById(n):Ext.isNumber(n)?this.all.elements[n]:n.isModel?this.getNodeByRecord(n):n},getNodeByRecord:function(n){for(var i=this.all.elements,r=i.length,t=0;t<r;t++)if(i[t].viewRecordId===n.internalId)return i[t];return null},getNodes:function(n,t){var i=this.all;return t===undefined?t=i.getCount():t++,i.slice(n||0,t)},indexOf:function(n){return(n=this.getNode(n),!n&&n!==0)?-1:Ext.isNumber(n.viewIndex)?n.viewIndex:this.all.indexOf(n)},onDestroy:function(){var n=this;n.all.clear();n.callParent();n.bindStore(null);n.selModel.destroy()},onItemSelect:function(n){var t=this.getNode(n);t&&Ext.fly(t).addCls(this.selectedItemCls)},onItemDeselect:function(n){var t=this.getNode(n);t&&Ext.fly(t).removeCls(this.selectedItemCls)},getItemSelector:function(){return this.itemSelector}},function(){Ext.deprecate("extjs","4.0",function(){Ext.view.AbstractView.override({getSelectionCount:function(){return Ext.global.console&&Ext.global.console.warn("DataView: getSelectionCount will be removed, please interact with the Ext.selection.DataViewModel"),this.selModel.getSelection().length},getSelectedRecords:function(){return Ext.global.console&&Ext.global.console.warn("DataView: getSelectedRecords will be removed, please interact with the Ext.selection.DataViewModel"),this.selModel.getSelection()},select:function(){Ext.global.console&&Ext.global.console.warn("DataView: select will be removed, please access select through a DataView's SelectionModel, ie: view.getSelectionModel().select()");var n=this.getSelectionModel();return n.select.apply(n,arguments)},clearSelections:function(){Ext.global.console&&Ext.global.console.warn("DataView: clearSelections will be removed, please access deselectAll through DataView's SelectionModel, ie: view.getSelectionModel().deselectAll()");var n=this.getSelectionModel();return n.deselectAll()}})})})