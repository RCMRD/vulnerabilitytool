Ext.define("Ext.form.field.ComboBox",{extend:"Ext.form.field.Picker",requires:["Ext.util.DelayedTask","Ext.EventObject","Ext.view.BoundList","Ext.view.BoundListKeyNav","Ext.data.StoreManager","Ext.layout.component.field.ComboBox"],alternateClassName:"Ext.form.ComboBox",alias:["widget.combobox","widget.combo"],mixins:{bindable:"Ext.util.Bindable"},componentLayout:"combobox",triggerCls:Ext.baseCSSPrefix+"form-arrow-trigger",hiddenName:"",hiddenDataCls:Ext.baseCSSPrefix+"hide-display "+Ext.baseCSSPrefix+"form-data-hidden",fieldSubTpl:['<div class="{hiddenDataCls}" role="presentation"><\/div>','<input id="{id}" type="{type}" {inputAttrTpl} class="{fieldCls} {typeCls} {editableCls}" autocomplete="off"','<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"<\/tpl>','<tpl if="name"> name="{name}"<\/tpl>','<tpl if="placeholder"> placeholder="{placeholder}"<\/tpl>','<tpl if="size"> size="{size}"<\/tpl>','<tpl if="maxLength !== undefined"> maxlength="{maxLength}"<\/tpl>','<tpl if="readOnly"> readonly="readonly"<\/tpl>','<tpl if="disabled"> disabled="disabled"<\/tpl>','<tpl if="tabIdx"> tabIndex="{tabIdx}"<\/tpl>','<tpl if="fieldStyle"> style="{fieldStyle}"<\/tpl>',"/>",{compiled:!0,disableFormats:!0}],getSubTplData:function(){var n=this;return Ext.applyIf(n.subTplData,{hiddenDataCls:n.hiddenDataCls}),n.callParent(arguments)},afterRender:function(){var n=this;n.callParent(arguments);n.setHiddenValue(n.value)},multiSelect:!1,delimiter:", ",displayField:"text",triggerAction:"all",allQuery:"",queryParam:"query",queryMode:"remote",queryCaching:!0,pageSize:0,anyMatch:!1,caseSensitive:!1,autoSelect:!0,typeAhead:!1,typeAheadDelay:250,selectOnTab:!0,forceSelection:!1,growToLongestValue:!0,defaultListConfig:{loadingHeight:70,minWidth:70,maxHeight:300,shadow:"sides"},ignoreSelection:0,removingRecords:null,resizeComboToGrow:function(){var n=this;return n.grow&&n.growToLongestValue},initComponent:function(){var n=this,r=Ext.isDefined,i=n.store,f=n.transform,t,u;Ext.applyIf(n.renderSelectors,{hiddenDataEl:"."+n.hiddenDataCls.split(" ").join(".")});n.typeAhead&&n.multiSelect&&Ext.Error.raise("typeAhead and multiSelect are mutually exclusive options -- please remove one of them.");n.typeAhead&&!n.editable&&Ext.Error.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.");n.selectOnFocus&&!n.editable&&Ext.Error.raise("If selectOnFocus is enabled the combo must be editable: true -- please change one of those settings.");this.addEvents("beforequery","select","beforeselect","beforedeselect");f&&(t=Ext.getDom(f),t&&(n.store||(i=Ext.Array.map(Ext.Array.from(t.options),function(n){return[n.value,n.text]})),n.name||(n.name=t.name),"value"in n||(n.value=t.value)));n.bindStore(i||"ext-empty-store",!0);i=n.store;i.autoCreated&&(n.queryMode="local",n.valueField=n.displayField="field1",i.expanded||(n.displayField="field2"));r(n.valueField)||(n.valueField=n.displayField);u=n.queryMode==="local";r(n.queryDelay)||(n.queryDelay=u?10:500);r(n.minChars)||(n.minChars=u?0:4);n.displayTpl?Ext.isString(n.displayTpl)&&(n.displayTpl=new Ext.XTemplate(n.displayTpl)):n.displayTpl=new Ext.XTemplate('<tpl for=".">{[typeof values === "string" ? values : values["'+n.displayField+'"]]}<tpl if="xindex < xcount">'+n.delimiter+"<\/tpl><\/tpl>");n.callParent();n.doQueryTask=new Ext.util.DelayedTask(n.doRawQuery,n);n.store.getCount()>0&&n.setValue(n.value);t&&(n.render(t.parentNode,t),Ext.removeNode(t),delete n.renderTo)},getStore:function(){return this.store},beforeBlur:function(){this.doQueryTask.cancel();this.assertValue()},assertValue:function(){var n=this,i=n.getRawValue(),t,r;n.forceSelection&&(n.multiSelect?i!==n.getDisplayValue()&&n.setValue(n.lastSelection):(t=n.findRecordByDisplay(i),t?(r=n.value,n.findRecordByValue(r)||n.select(t,!0)):n.setValue(n.lastSelection)));n.collapse()},onTypeAhead:function(){var n=this,u=n.displayField,r=n.store.findRecord(u,n.getRawValue()),f=n.getPicker(),t,e,i;r&&(t=r.get(u),e=t.length,i=n.getRawValue().length,f.highlightItem(f.getNode(r)),i!==0&&i!==e&&(n.setRawValue(t),n.selectText(i,t.length)))},resetToDefault:Ext.emptyFn,beforeReset:function(){this.callParent();this.queryFilter&&!this.queryFilter.disabled&&(this.queryFilter.disabled=!0,this.store.filter())},onUnbindStore:function(n){var t=this,i=t.picker;t.queryFilter&&t.store.removeFilter(t.queryFilter);!n&&i&&i.bindStore(null)},onBindStore:function(n,t){var i=this.picker;t||this.resetToDefault();i&&i.bindStore(n)},getStoreListeners:function(){var n=this;return{beforeload:n.onBeforeLoad,clear:n.onClear,datachanged:n.onDataChanged,load:n.onLoad,exception:n.onException,remove:n.onRemove}},onBeforeLoad:function(){++this.ignoreSelection},onDataChanged:function(){var n=this;n.resizeComboToGrow()&&n.updateLayout()},onClear:function(){var n=this;n.resizeComboToGrow()&&(n.removingRecords=!0,n.onDataChanged())},onRemove:function(){var n=this;n.resizeComboToGrow()&&(n.removingRecords=!0)},onException:function(){this.ignoreSelection>0&&--this.ignoreSelection;this.collapse()},onLoad:function(n,t,i){var r=this;r.ignoreSelection>0&&--r.ignoreSelection;i&&!n.lastOptions.rawQuery&&(r.value==null?r.store.getCount()?r.doAutoSelect():r.setValue(r.value):r.setValue(r.value))},doRawQuery:function(){this.doQuery(this.getRawValue(),!1,!0)},doQuery:function(n,t,i){var r=this,u=r.beforeQuery({query:n||"",rawQuery:i,forceAll:t,combo:r,cancel:!1});return u===!1||u.cancel?!1:(r.queryCaching&&u.query===r.lastQuery?r.expand():(r.lastQuery=u.query,r.queryMode==="local"?r.doLocalQuery(u):r.doRemoteQuery(u)),!0)},beforeQuery:function(n){var t=this;return t.fireEvent("beforequery",n)===!1?n.cancel=!0:n.cancel||n.query.length<t.minChars&&!n.forceAll&&(n.cancel=!0),n},doLocalQuery:function(n){var t=this,i=n.query;t.queryFilter||(t.queryFilter=new Ext.util.Filter({id:t.id+"-query-filter",anyMatch:t.anyMatch,caseSensitive:t.caseSensitive,root:"data",property:t.displayField}),t.store.addFilter(t.queryFilter,!1));i||!n.forceAll?(t.queryFilter.disabled=!1,t.queryFilter.setValue(t.enableRegEx?new RegExp(i):i)):t.queryFilter.disabled=!0;t.store.filter();t.store.getCount()?t.expand():t.collapse();t.afterQuery(n)},doRemoteQuery:function(n){var t=this,i=function(){t.afterQuery(n)};t.expand();t.pageSize?t.loadPage(1,{rawQuery:n.rawQuery,callback:i}):t.store.load({params:t.getParams(n.query),rawQuery:n.rawQuery,callback:i})},afterQuery:function(n){var t=this;t.store.getCount()&&(t.typeAhead&&t.doTypeAhead(),t.getRawValue()!==t.getDisplayValue()&&(t.ignoreSelection++,t.picker.getSelectionModel().deselectAll(),t.ignoreSelection--),n.rawQuery?(t.syncSelection(),t.picker&&!t.picker.getSelectionModel().hasSelection()&&t.doAutoSelect()):t.doAutoSelect())},loadPage:function(n,t){this.store.loadPage(n,Ext.apply({params:this.getParams(this.lastQuery)},t))},onPageChange:function(n,t){return this.loadPage(t),!1},getParams:function(n){var t={},i=this.queryParam;return i&&(t[i]=n),t},doAutoSelect:function(){var i=this,n=i.picker,r,t;n&&i.autoSelect&&i.store.getCount()>0&&(r=n.getSelectionModel().lastSelected,t=n.getNode(r||0),t&&(n.highlightItem(t),n.listEl.scrollChildIntoView(t,!1)))},doTypeAhead:function(){this.typeAheadTask||(this.typeAheadTask=new Ext.util.DelayedTask(this.onTypeAhead,this));this.lastKey!=Ext.EventObject.BACKSPACE&&this.lastKey!=Ext.EventObject.DELETE&&this.typeAheadTask.delay(this.typeAheadDelay)},onTriggerClick:function(){var n=this;if(!n.readOnly&&!n.disabled){if(n.isExpanded)n.collapse();else{n.onFocus({});n.triggerAction==="all"?n.doQuery(n.allQuery,!0):n.triggerAction==="last"?n.doQuery(n.lastQuery,!0):n.doQuery(n.getRawValue(),!1,!0)}n.inputEl.focus()}},onPaste:function(){var n=this;n.readOnly||n.disabled||!n.editable||n.doQueryTask.delay(n.queryDelay)},onKeyUp:function(n){var t=this,i=n.getKey();t.readOnly||t.disabled||!t.editable||(t.lastKey=i,n.isSpecialKey()&&i!=n.BACKSPACE&&i!=n.DELETE||t.doQueryTask.delay(t.queryDelay));t.enableKeyEvents&&t.callParent(arguments)},initEvents:function(){var n=this;n.callParent();n.enableKeyEvents||n.mon(n.inputEl,"keyup",n.onKeyUp,n);n.mon(n.inputEl,"paste",n.onPaste,n)},onDestroy:function(){Ext.destroy(this.listKeyNav);this.bindStore(null);this.callParent()},onAdded:function(){var n=this;n.callParent(arguments);n.picker&&(n.picker.ownerCt=n.up("[floating]"),n.picker.registerWithOwnerCt())},createPicker:function(){var n=this,t,i=Ext.apply({xtype:"boundlist",pickerField:n,selModel:{mode:n.multiSelect?"SIMPLE":"SINGLE"},floating:!0,hidden:!0,store:n.store,displayField:n.displayField,focusOnToFront:!1,pageSize:n.pageSize,tpl:n.tpl},n.listConfig,n.defaultListConfig);if(t=n.picker=Ext.widget(i),n.pageSize)t.pagingToolbar.on("beforechange",n.onPageChange,n);return n.mon(t,{itemclick:n.onItemClick,refresh:n.onListRefresh,scope:n}),n.mon(t.getSelectionModel(),{beforeselect:n.onBeforeSelect,beforedeselect:n.onBeforeDeselect,selectionchange:n.onListSelectionChange,scope:n}),t},alignPicker:function(){var t=this,n=t.getPicker(),i=t.getPosition()[1]-Ext.getBody().getScroll().top,u=Ext.Element.getViewHeight()-i-t.getHeight(),r=Math.max(i,u);n.height&&(delete n.height,n.updateLayout());n.getHeight()>r-5&&n.setHeight(r-5);t.callParent()},onListRefresh:function(){this.expanding||this.alignPicker();this.syncSelection()},onItemClick:function(n,t){var i=this,r=i.picker.getSelectionModel().getSelection(),u=i.valueField;!i.multiSelect&&r.length&&t.get(u)===r[0].get(u)&&(i.displayTplData=[t.data],i.setRawValue(i.getDisplayValue()),i.collapse())},onBeforeSelect:function(n,t){return this.fireEvent("beforeselect",this,t,t.index)},onBeforeDeselect:function(n,t){return this.fireEvent("beforedeselect",this,t,t.index)},onListSelectionChange:function(n,t){var i=this,r=i.multiSelect,u=t.length>0;!i.ignoreSelection&&i.isExpanded&&(r||Ext.defer(i.collapse,1,i),(r||u)&&i.setValue(t,!1),u&&i.fireEvent("select",i,t),i.inputEl.focus())},onExpand:function(){var n=this,t=n.listKeyNav,i=n.selectOnTab,r=n.getPicker();t?t.enable():t=n.listKeyNav=new Ext.view.BoundListKeyNav(this.inputEl,{boundList:r,forceKeyDown:!0,tab:function(t){return i&&(this.selectHighlighted(t),n.triggerBlur()),!0},enter:function(t){var i=r.getSelectionModel(),u=i.getCount();this.selectHighlighted(t);n.multiSelect||u!==i.getCount()||n.collapse()}});i&&(n.ignoreMonitorTab=!0);Ext.defer(t.enable,1,t);n.inputEl.focus()},onCollapse:function(){var n=this,t=n.listKeyNav;t&&(t.disable(),n.ignoreMonitorTab=!1)},select:function(n,t){var i=this,r=i.picker,u;n&&n.isModel&&t===!0&&r&&(u=!r.getSelectionModel().isSelected(n));i.setValue(n,!0);u&&i.fireEvent("select",i,n)},findRecord:function(n,t){var i=this.store,r=i.findExact(n,t);return r!==-1?i.getAt(r):!1},findRecordByValue:function(n){return this.findRecord(this.valueField,n)},findRecordByDisplay:function(n){return this.findRecord(this.displayField,n)},setValue:function(n,t){var i=this,s=i.valueNotFoundText,h=i.inputEl,u,c,r,o,l=[],e=[],f=[];if(i.store.loading)return i.value=n,i.setHiddenValue(i.value),i;for(n=Ext.Array.from(n),u=0,c=n.length;u<c;u++)r=n[u],r&&r.isModel||(r=i.findRecordByValue(r)),r?(l.push(r),e.push(r.data),f.push(r.get(i.valueField))):i.forceSelection?Ext.isDefined(s)&&e.push(s):(f.push(n[u]),o={},o[i.displayField]=n[u],e.push(o));return i.setHiddenValue(f),i.value=i.multiSelect?f:f[0],Ext.isDefined(i.value)||(i.value=null),i.displayTplData=e,i.lastSelection=i.valueModels=l,h&&i.emptyText&&!Ext.isEmpty(n)&&h.removeCls(i.emptyCls),i.setRawValue(i.getDisplayValue()),i.checkChange(),t!==!1&&i.syncSelection(),i.applyEmptyText(),i},setHiddenValue:function(n){var e=this,s=e.hiddenName,i,r,u,o,f,t;if(e.hiddenDataEl&&s){for(n=Ext.Array.from(n),r=e.hiddenDataEl.dom,u=r.childNodes,o=u[0],f=n.length,t=u.length,!o&&f>0&&(e.hiddenDataEl.update(Ext.DomHelper.markup({tag:"input",type:"hidden",name:s})),t=1,o=r.firstChild);t>f;)r.removeChild(u[0]),--t;while(t<f)r.appendChild(o.cloneNode(!0)),++t;for(i=0;i<f;i++)u[i].value=n[i]}},getDisplayValue:function(){return this.displayTpl.apply(this.displayTplData)},getValue:function(){var n=this,t=n.picker,i=n.getRawValue(),r=n.value;return n.getDisplayValue()!==i&&(r=i,n.value=n.displayTplData=n.valueModels=null,t&&(n.ignoreSelection++,t.getSelectionModel().deselectAll(),n.ignoreSelection--)),r},getSubmitValue:function(){var n=this.getValue();return Ext.isEmpty(n)&&(n=""),n},isEqual:function(n,t){var u=Ext.Array.from,i,r;if(n=u(n),t=u(t),r=n.length,r!==t.length)return!1;for(i=0;i<r;i++)if(t[i]!==n[i])return!1;return!0},clearValue:function(){this.setValue([])},syncSelection:function(){var n=this,f=n.picker,i,u,e=n.valueModels||[],o=e.length,r,t;if(f){for(i=[],r=0;r<o;r++)t=e[r],t&&t.isModel&&n.store.indexOf(t)>=0&&i.push(t);n.ignoreSelection++;u=f.getSelectionModel();u.deselectAll();i.length&&u.select(i,undefined,!0);n.ignoreSelection--}},onEditorTab:function(n){var t=this.listKeyNav;this.selectOnTab&&t&&t.selectHighlighted(n)}})