Ext.define("Ext.form.field.HtmlEditor",{extend:"Ext.form.FieldContainer",mixins:{field:"Ext.form.field.Field"},alias:"widget.htmleditor",alternateClassName:"Ext.form.HtmlEditor",requires:["Ext.tip.QuickTipManager","Ext.picker.Color","Ext.layout.container.VBox","Ext.toolbar.Item","Ext.toolbar.Toolbar","Ext.util.Format","Ext.layout.component.field.HtmlEditor"],componentLayout:"htmleditor",componentTpl:["{beforeTextAreaTpl}",'<textarea id="{id}-textareaEl" name="{name}" tabIndex="-1" {inputAttrTpl}',' class="{textareaCls}" autocomplete="off">',"{[Ext.util.Format.htmlEncode(values.value)]}","<\/textarea>","{afterTextAreaTpl}","{beforeIFrameTpl}",'<iframe id="{id}-iframeEl" name="{iframeName}" frameBorder="0" {iframeAttrTpl}',' src="{iframeSrc}" class="{iframeCls}"><\/iframe>',"{afterIFrameTpl}",{disableFormats:!0}],stretchInputElFixed:!0,subTplInsertions:["beforeTextAreaTpl","afterTextAreaTpl","beforeIFrameTpl","afterIFrameTpl","iframeAttrTpl","inputAttrTpl"],enableFormat:!0,enableFontSize:!0,enableColors:!0,enableAlignments:!0,enableLists:!0,enableSourceEdit:!0,enableLinks:!0,enableFont:!0,createLinkText:"Please enter the URL for the link:",defaultLinkValue:"http://",fontFamilies:["Arial","Courier New","Tahoma","Times New Roman","Verdana"],defaultValue:Ext.isOpera||Ext.isIE6?"&#160;":"&#8203;",extraFieldBodyCls:Ext.baseCSSPrefix+"html-editor-wrap",initialized:!1,activated:!1,sourceEditMode:!1,iframePad:3,hideMode:"offsets",maskOnDisable:!0,containerElCls:Ext.baseCSSPrefix+"html-editor-container",initComponent:function(){var n=this;n.addEvents("initialize","activate","beforesync","beforepush","sync","push","editmodechange");n.items=[n.createToolbar(),n.createInputCmp()];n.layout={type:"vbox",align:"stretch"};n.callParent(arguments);n.initField()},createInputCmp:function(){return this.inputCmp=Ext.widget(this.getInputCmpCfg()),this.inputCmp},getInputCmpCfg:function(){var n=this,t=n.id+"-inputCmp",i={id:t,name:n.name,textareaCls:Ext.baseCSSPrefix+"hidden",value:n.value,iframeName:Ext.id(),iframeSrc:Ext.SSL_SECURE_URL,iframeCls:Ext.baseCSSPrefix+"htmleditor-iframe"};return n.getInsertionRenderData(i,n.subTplInsertions),{flex:1,xtype:"component",tpl:n.getTpl("componentTpl"),childEls:["iframeEl","textareaEl"],id:t,cls:Ext.baseCSSPrefix+"html-editor-input",data:i}},createToolbar:function(){return this.toolbar=Ext.widget(this.getToolbarCfg()),this.toolbar},getToolbarCfg:function(){function i(t,i,f){return{itemId:t,cls:r+"btn-icon",iconCls:r+"edit-"+t,enableToggle:i!==!1,scope:n,handler:f||n.relayBtnCmd,clickEvent:"mousedown",tooltip:e?n.buttonTips[t]||u:u,overflowText:n.buttonTips[t].title||u,tabIndex:-1}}var n=this,t=[],f,e=Ext.quickTipsActive&&Ext.tip.QuickTipManager.isEnabled(),r=Ext.baseCSSPrefix,o,u;for(n.enableFont&&!Ext.isSafari2&&(o=Ext.widget("component",{itemId:"fontSelect",renderTpl:['<select id="{id}-selectEl" class="'+r+'font-select">',"<\/select>"],childEls:["selectEl"],afterRender:function(){n.fontSelect=this.selectEl;Ext.Component.prototype.afterRender.apply(this,arguments)},onDisable:function(){var n=this.selectEl;n&&(n.dom.disabled=!0);Ext.Component.prototype.onDisable.apply(this,arguments)},onEnable:function(){var n=this.selectEl;n&&(n.dom.disabled=!1);Ext.Component.prototype.onEnable.apply(this,arguments)},listeners:{change:function(){n.win.focus();n.relayCmd("fontName",n.fontSelect.dom.value);n.deferFocus()},element:"selectEl"}}),t.push(o,"-")),n.enableFormat&&t.push(i("bold"),i("italic"),i("underline")),n.enableFontSize&&t.push("-",i("increasefontsize",!1,n.adjustFont),i("decreasefontsize",!1,n.adjustFont)),n.enableColors&&t.push("-",{itemId:"forecolor",cls:r+"btn-icon",iconCls:r+"edit-forecolor",overflowText:n.buttonTips.forecolor.title,tooltip:e?n.buttonTips.forecolor||u:u,tabIndex:-1,menu:Ext.widget("menu",{plain:!0,items:[{xtype:"colorpicker",allowReselect:!0,focus:Ext.emptyFn,value:"000000",plain:!0,clickEvent:"mousedown",handler:function(t,i){n.relayCmd("forecolor",Ext.isWebKit||Ext.isIE?"#"+i:i);this.up("menu").hide()}}]})},{itemId:"backcolor",cls:r+"btn-icon",iconCls:r+"edit-backcolor",overflowText:n.buttonTips.backcolor.title,tooltip:e?n.buttonTips.backcolor||u:u,tabIndex:-1,menu:Ext.widget("menu",{plain:!0,items:[{xtype:"colorpicker",focus:Ext.emptyFn,value:"FFFFFF",plain:!0,allowReselect:!0,clickEvent:"mousedown",handler:function(t,i){Ext.isGecko?(n.execCmd("useCSS",!1),n.execCmd("hilitecolor","#"+i),n.execCmd("useCSS",!0),n.deferFocus()):n.relayCmd(Ext.isOpera?"hilitecolor":"backcolor",Ext.isWebKit||Ext.isIE||Ext.isOpera?"#"+i:i);this.up("menu").hide()}}]})}),n.enableAlignments&&t.push("-",i("justifyleft"),i("justifycenter"),i("justifyright")),Ext.isSafari2||(n.enableLinks&&t.push("-",i("createlink",!1,n.createLink)),n.enableLists&&t.push("-",i("insertorderedlist"),i("insertunorderedlist")),n.enableSourceEdit&&t.push("-",i("sourceedit",!0,function(){n.toggleSourceEdit(!n.sourceEditMode)}))),f=0;f<t.length;f++)t[f].itemId!=="sourceedit"&&(t[f].disabled=!0);return{xtype:"toolbar",defaultButtonUI:n.defaultButtonUI,cls:Ext.baseCSSPrefix+"html-editor-tb",enableOverflow:!0,items:t,listeners:{click:function(n){n.preventDefault()},element:"el"}}},getMaskTarget:function(){return Ext.isGecko?this.inputCmp.el:this.bodyEl},setReadOnly:function(n){var t=this,r=t.textareaEl,u=t.iframeEl,i;t.readOnly=n;r&&(r.dom.readOnly=n);t.initialized&&(i=t.getEditorBody(),Ext.isIE?(u.setDisplayed(!1),i.contentEditable=!n,u.setDisplayed(!0)):t.setDesignMode(!n),i&&(i.style.cursor=n?"default":"text"),t.disableItems(n))},getDocMarkup:function(){var n=this,i=n.iframeEl.getHeight()-n.iframePad*2,t=Ext.isIE8m;return Ext.String.format((t?"":"<!DOCTYPE html>")+'<html><head><style type="text/css">'+(Ext.isOpera?"p{margin:0}":"")+"body{border:0;margin:0;padding:{0}px;direction:"+(n.rtl?"rtl;":"ltr;")+(t?Ext.emptyString:"min-")+"height:{1}px;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;cursor:text;background-color:white;"+(Ext.isIE?"":"font-size:12px;font-family:{2}")+"}<\/style><\/head><body><\/body><\/html>",n.iframePad,i,n.defaultFont)},getEditorBody:function(){var n=this.getDoc();return n.body||n.documentElement},getDoc:function(){return!Ext.isIE&&this.iframeEl.dom.contentDocument||this.getWin().document},getWin:function(){return Ext.isIE?this.iframeEl.dom.contentWindow:window.frames[this.iframeEl.dom.name]},initDefaultFont:function(){var t=this,o=0,i,n,u,f,r,s,e;if(!t.defaultFont){for(n=t.textareaEl.getStyle("font-family"),n=Ext.String.capitalize(n.split(",")[0]),i=Ext.Array.clone(t.fontFamilies),Ext.Array.include(i,n),i.sort(),t.defaultFont=n,u=t.down("#fontSelect").selectEl.dom,r=0,s=i.length;r<s;++r)n=i[r],e=n.toLowerCase(),f=new Option(n,e),n==t.defaultFont&&(o=r),f.style.fontFamily=e,Ext.isIE?u.add(f):u.options.add(f);u.options[o].selected=!0}},isEqual:function(n,t){return this.isEqualAsString(n,t)},afterRender:function(){var n=this,t=n.inputCmp;n.callParent(arguments);n.iframeEl=t.iframeEl;n.textareaEl=t.textareaEl;n.inputEl=n.iframeEl;n.enableFont&&n.initDefaultFont();n.monitorTask=Ext.TaskManager.start({run:n.checkDesignMode,scope:n,interval:100});n.relayCmd("fontName",n.defaultFont)},initFrameDoc:function(){var n=this,t,i;Ext.TaskManager.stop(n.monitorTask);t=n.getDoc();n.win=n.getWin();t.open();t.write(n.getDocMarkup());t.close();i={run:function(){var t=n.getDoc();(t.body||t.readyState==="complete")&&(Ext.TaskManager.stop(i),n.setDesignMode(!0),Ext.defer(n.initEditor,10,n))},interval:10,duration:1e4,scope:n};Ext.TaskManager.start(i)},checkDesignMode:function(){var n=this,t=n.getDoc();t&&(!t.editorInitialized||n.getDesignMode()!=="on")&&n.initFrameDoc()},setDesignMode:function(n){var t=this,i=t.getDoc();i&&(t.readOnly&&(n=!1),i.designMode=/on|true/i.test(String(n).toLowerCase())?"on":"off")},getDesignMode:function(){var n=this.getDoc();return n?String(n.designMode).toLowerCase():""},disableItems:function(n){for(var r=this.getToolbar().items.items,u=r.length,i,t=0;t<u;t++)i=r[t],i.getItemId()!=="sourceedit"&&i.setDisabled(n)},toggleSourceEdit:function(n){var t=this,u=t.iframeEl,i=t.textareaEl,r=Ext.baseCSSPrefix+"hidden",f=t.getToolbar().getComponent("sourceedit");Ext.isBoolean(n)||(n=!t.sourceEditMode);t.sourceEditMode=n;f.pressed!==n&&f.toggle(n);n?(t.disableItems(!0),t.syncValue(),u.addCls(r),i.removeCls(r),i.dom.removeAttribute("tabIndex"),i.focus(),t.inputEl=i):(t.initialized&&t.disableItems(t.readOnly),t.pushValue(),u.removeCls(r),i.addCls(r),i.dom.setAttribute("tabIndex",-1),t.deferFocus(),t.inputEl=u);t.fireEvent("editmodechange",t,n);t.updateLayout()},createLink:function(){var n=prompt(this.createLinkText,this.defaultLinkValue);n&&n!=="http://"&&this.relayCmd("createlink",n)},clearInvalid:Ext.emptyFn,setValue:function(n){var t=this,i=t.textareaEl,r=t.inputCmp;return t.mixins.field.setValue.call(t,n),(n===null||n===undefined)&&(n=""),i&&(i.dom.value=n),t.pushValue(),!t.rendered&&t.inputCmp&&(t.inputCmp.data.value=n),t},cleanHtml:function(n){return n=String(n),Ext.isWebKit&&(n=n.replace(/\sclass="(?:Apple-style-span|Apple-tab-span|khtml-block-placeholder)"/gi,"")),n.charCodeAt(0)===parseInt(this.defaultValue.replace(/\D/g,""),10)&&(n=n.substring(1)),n},syncValue:function(){var t=this,u,f,n,e,i,r;t.initialized&&(u=t.getEditorBody(),n=u.innerHTML,r=t.textareaEl.dom,Ext.isWebKit&&(e=u.getAttribute("style"),i=e.match(/text-align:(.*?);/i),i&&i[1]&&(n='<div style="'+i[0]+'">'+n+"<\/div>")),n=t.cleanHtml(n),t.fireEvent("beforesync",t,n)!==!1&&(Ext.isGecko&&r.value===""&&n==="<br>"&&(n=""),r.value!==n&&(r.value=n,f=!0),t.fireEvent("sync",t,n),f&&t.checkChange()))},getValue:function(){var n=this,t;return n.sourceEditMode||n.syncValue(),t=n.rendered?n.textareaEl.dom.value:n.value,n.value=t,t},pushValue:function(){var n=this,t;n.initialized&&(t=n.textareaEl.dom.value||"",!n.activated&&t.length<1&&(t=n.defaultValue),n.fireEvent("beforepush",n,t)!==!1&&(n.getEditorBody().innerHTML=t,Ext.isGecko&&(n.setDesignMode(!1),n.setDesignMode(!0)),n.fireEvent("push",n,t)))},deferFocus:function(){this.focus(!1,!0)},getFocusEl:function(){var n=this,t=n.win;return t&&!n.sourceEditMode?t:n.textareaEl},focus:function(n,t){var i=this,u,r;return t?(i.focusTask||(i.focusTask=new Ext.util.DelayedTask(i.focus)),i.focusTask.delay(Ext.isNumber(t)?t:10,null,i,[n,!1])):(n&&(i.textareaEl&&i.textareaEl.dom&&(u=i.textareaEl.dom.value),u&&u.length&&i.execCmd("selectall",!0)),r=i.getFocusEl(),r&&r.focus&&r.focus()),i},initEditor:function(){try{var n=this,r=n.getEditorBody(),u=n.textareaEl.getStyles("font-size","font-family","background-image","background-repeat","background-color","color"),t,i;if(u["background-attachment"]="fixed",r.bgProperties="fixed",Ext.DomHelper.applyStyles(r,u),t=n.getDoc(),t)try{Ext.EventManager.removeAll(t)}catch(f){}i=Ext.Function.bind(n.onEditorEvent,n);Ext.EventManager.on(t,{mousedown:i,dblclick:i,click:i,keyup:i,buffer:100});i=n.onRelayedEvent;Ext.EventManager.on(t,{mousedown:i,mousemove:i,mouseup:i,click:i,dblclick:i,scope:n});if(Ext.isGecko)Ext.EventManager.on(t,"keypress",n.applyCommand,n);if(n.fixKeys)Ext.EventManager.on(t,"keydown",n.fixKeys,n);if(n.fixKeysAfter)Ext.EventManager.on(t,"keyup",n.fixKeysAfter,n);if(Ext.isIE9&&Ext.isStrict)Ext.EventManager.on(t.documentElement,"focus",n.focus,n);if(Ext.isIE8m||Ext.isIE9&&!Ext.isStrict){Ext.EventManager.on(t,"focusout",function(){n.savedSelection=t.selection.type!=="None"?t.selection.createRange():null},n);Ext.EventManager.on(t,"focusin",function(){n.savedSelection&&n.savedSelection.select()},n)}Ext.EventManager.onWindowUnload(n.beforeDestroy,n);t.editorInitialized=!0;n.initialized=!0;n.pushValue();n.setReadOnly(n.readOnly);n.fireEvent("initialize",n)}catch(e){}},beforeDestroy:function(){var n=this,r=n.monitorTask,t,i;if(r&&Ext.TaskManager.stop(r),n.rendered){Ext.EventManager.removeUnloadListener(n.beforeDestroy,n);try{if(t=n.getDoc(),t){Ext.EventManager.removeAll(Ext.fly(t));for(i in t)t.hasOwnProperty&&t.hasOwnProperty(i)&&delete t[i]}}catch(u){}delete n.iframeEl;delete n.textareaEl;delete n.toolbar;delete n.inputCmp}n.callParent()},onRelayedEvent:function(n){var t=this.iframeEl,i=Ext.Element.getTrueXY(t),u=n.getXY(),r=Ext.EventManager.getPageXY(n.browserEvent);n.xy=[i[0]+r[0],i[1]+r[1]];n.injectEvent(t);n.xy=u},onFirstFocus:function(){var n=this,t,i;if(n.activated=!0,n.disableItems(n.readOnly),Ext.isGecko){n.win.focus();t=n.win.getSelection();t.focusNode&&t.focusNode.nodeType===3||(i=t.getRangeAt(0),i.selectNodeContents(n.getEditorBody()),i.collapse(!0),n.deferFocus());try{n.execCmd("useCSS",!0);n.execCmd("styleWithCSS",!1)}catch(r){}}n.fireEvent("activate",n)},adjustFont:function(n){var i=n.getItemId()==="increasefontsize"?1:-1,t=this.getDoc().queryCommandValue("FontSize")||"2",u=Ext.isString(t)&&t.indexOf("px")!==-1,r;t=parseInt(t,10);u?(t=t<=10?1+i:t<=13?2+i:t<=16?3+i:t<=18?4+i:t<=24?5+i:6+i,t=Ext.Number.constrain(t,1,6)):(r=Ext.isSafari,r&&(i*=2),t=Math.max(1,t+i)+(r?"px":0));this.relayCmd("FontSize",t)},onEditorEvent:function(){this.updateToolbar()},updateToolbar:function(){function o(){var n;for(t=0,s=arguments.length,i;t<s;t++){i=arguments[t];try{n=u.queryCommandState(i)}catch(r){n=!1}h[i].toggle(n)}}var n=this,t,s,h,u,i,r,f,e;if(!n.readOnly){if(!n.activated){n.onFirstFocus();return}for(h=n.getToolbar().items.map,u=n.getDoc(),n.enableFont&&!Ext.isSafari2&&(r=u.queryCommandValue("fontName"),i=(r?r.split(",")[0].replace(/^'/,"").replace(/'$/,""):n.defaultFont).toLowerCase(),f=n.fontSelect.dom,(i!==f.value||i!=r)&&(f.value=i)),n.enableFormat&&o("bold","italic","underline"),n.enableAlignments&&o("justifyleft","justifycenter","justifyright"),!Ext.isSafari2&&n.enableLists&&o("insertorderedlist","insertunorderedlist"),e=n.toolbar.query("menu"),t=0;t<e.length;t++)e[t].hide();n.syncValue()}},relayBtnCmd:function(n){this.relayCmd(n.getItemId())},relayCmd:function(n,t){Ext.defer(function(){var i=this;this.isDestroyed||(i.win.focus(),i.execCmd(n,t),i.updateToolbar())},10,this)},execCmd:function(n,t){var i=this,r=i.getDoc();r.execCommand(n,!1,t==undefined?null:t);i.syncValue()},applyCommand:function(n){if(n.ctrlKey){var r=this,i=n.getCharCode(),t;if(i>0){i=String.fromCharCode(i);switch(i){case"b":t="bold";break;case"i":t="italic";break;case"u":t="underline"}t&&(r.win.focus(),r.execCmd(t),r.deferFocus(),n.preventDefault())}}},insertAtCursor:function(n){var t=this,i;t.activated&&(t.win.focus(),Ext.isIE?(i=t.getDoc().selection.createRange(),i&&(i.pasteHTML(n),t.syncValue(),t.deferFocus())):(t.execCmd("InsertHTML",n),t.deferFocus()))},fixKeys:function(){return Ext.isIE?function(n){var i=this,u=n.getKey(),f=i.getDoc(),e=i.readOnly,t,r;u===n.TAB?(n.stopEvent(),e||(t=f.selection.createRange(),t&&(t.collapse&&(t.collapse(!0),t.pasteHTML("&#160;&#160;&#160;&#160;")),i.deferFocus()))):u===n.ENTER&&(e||(t=f.selection.createRange(),t&&(r=t.parentElement(),r&&r.tagName.toLowerCase()==="li"||(n.stopEvent(),t.pasteHTML("<br />"),t.collapse(!1),t.select()))))}:Ext.isOpera?function(n){var t=this,i=n.getKey(),r=t.readOnly;i===n.TAB&&(n.stopEvent(),r||(t.win.focus(),t.execCmd("InsertHTML","&#160;&#160;&#160;&#160;"),t.deferFocus()))}:null}(),fixKeysAfter:function(){return Ext.isIE?function(n){var i=this,r=n.getKey(),u=i.getDoc(),f=i.readOnly,t;f||r!==n.BACKSPACE&&r!==n.DELETE||(t=u.body.innerHTML,(t==="<p>&nbsp;<\/p>"||t==="<P>&nbsp;<\/P>")&&(u.body.innerHTML=""))}:null}(),getToolbar:function(){return this.toolbar},buttonTips:{bold:{title:"Bold (Ctrl+B)",text:"Make the selected text bold.",cls:Ext.baseCSSPrefix+"html-editor-tip"},italic:{title:"Italic (Ctrl+I)",text:"Make the selected text italic.",cls:Ext.baseCSSPrefix+"html-editor-tip"},underline:{title:"Underline (Ctrl+U)",text:"Underline the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},increasefontsize:{title:"Grow Text",text:"Increase the font size.",cls:Ext.baseCSSPrefix+"html-editor-tip"},decreasefontsize:{title:"Shrink Text",text:"Decrease the font size.",cls:Ext.baseCSSPrefix+"html-editor-tip"},backcolor:{title:"Text Highlight Color",text:"Change the background color of the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},forecolor:{title:"Font Color",text:"Change the color of the selected text.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifyleft:{title:"Align Text Left",text:"Align text to the left.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifycenter:{title:"Center Text",text:"Center text in the editor.",cls:Ext.baseCSSPrefix+"html-editor-tip"},justifyright:{title:"Align Text Right",text:"Align text to the right.",cls:Ext.baseCSSPrefix+"html-editor-tip"},insertunorderedlist:{title:"Bullet List",text:"Start a bulleted list.",cls:Ext.baseCSSPrefix+"html-editor-tip"},insertorderedlist:{title:"Numbered List",text:"Start a numbered list.",cls:Ext.baseCSSPrefix+"html-editor-tip"},createlink:{title:"Hyperlink",text:"Make the selected text a hyperlink.",cls:Ext.baseCSSPrefix+"html-editor-tip"},sourceedit:{title:"Source Edit",text:"Switch to source editing mode.",cls:Ext.baseCSSPrefix+"html-editor-tip"}}})