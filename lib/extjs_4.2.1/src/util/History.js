Ext.define("Ext.util.History",{singleton:!0,alternateClassName:"Ext.History",mixins:{observable:"Ext.util.Observable"},useTopWindow:!0,fieldId:Ext.baseCSSPrefix+"history-field",iframeId:Ext.baseCSSPrefix+"history-frame",constructor:function(){var n=this;n.oldIEMode=Ext.isIE7m||!Ext.isStrict&&Ext.isIE8;n.iframe=null;n.hiddenField=null;n.ready=!1;n.currentToken=null;n.mixins.observable.constructor.call(n)},getHash:function(){var n=window.location.href,t=n.indexOf("#");return t>=0?n.substr(t+1):null},setHash:function(n){var t=this,i=t.useTopWindow?window.top:window;try{i.location.hash=n}catch(r){}},doSave:function(){this.hiddenField.value=this.currentToken},handleStateChange:function(n){this.currentToken=n;this.fireEvent("change",n)},updateIFrame:function(n){var i='<html><body><div id="state">'+Ext.util.Format.htmlEncode(n)+"<\/div><\/body><\/html>",t;try{return t=this.iframe.contentWindow.document,t.open(),t.write(i),t.close(),!0}catch(r){return!1}},checkIFrame:function(){var n=this,t=n.iframe.contentWindow,f,r,u,i;if(!t||!t.document){Ext.Function.defer(this.checkIFrame,10,this);return}f=t.document;r=f.getElementById("state");u=r?r.innerText:null;i=n.getHash();Ext.TaskManager.start({run:function(){var o=t.document,e=o.getElementById("state"),r=e?e.innerText:null,f=n.getHash();r!==u?(u=r,n.handleStateChange(r),n.setHash(r),i=r,n.doSave()):f!==i&&(i=f,n.updateIFrame(f))},interval:50,scope:n});n.ready=!0;n.fireEvent("ready",n)},startUp:function(){var n=this,t;n.currentToken=n.hiddenField.value||this.getHash();n.oldIEMode?n.checkIFrame():(t=n.getHash(),Ext.TaskManager.start({run:function(){var i=n.getHash();i!==t&&(t=i,n.handleStateChange(t),n.doSave())},interval:50,scope:n}),n.ready=!0,n.fireEvent("ready",n))},init:function(n,t){var i=this,r=Ext.DomHelper;if(i.ready){Ext.callback(n,t,[i]);return}if(!Ext.isReady){Ext.onReady(function(){i.init(n,t)});return}if(i.hiddenField=Ext.getDom(i.fieldId),i.hiddenField||(i.hiddenField=Ext.getBody().createChild({id:Ext.id(),tag:"form",cls:Ext.baseCSSPrefix+"hide-display",children:[{tag:"input",type:"hidden",id:i.fieldId}]},!1,!0).firstChild),i.oldIEMode&&(i.iframe=Ext.getDom(i.iframeId),i.iframe||(i.iframe=r.append(i.hiddenField.parentNode,{tag:"iframe",id:i.iframeId,src:Ext.SSL_SECURE_URL}))),i.addEvents("ready","change"),n)i.on("ready",n,t,{single:!0});i.startUp()},add:function(n,t){var i=this;return t!==!1&&i.getToken()===n?!0:i.oldIEMode?i.updateIFrame(n):(i.setHash(n),!0)},back:function(){window.history.go(-1)},forward:function(){window.history.go(1)},getToken:function(){return this.ready?this.currentToken:this.getHash()}})