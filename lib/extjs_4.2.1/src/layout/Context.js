Ext.define("Ext.layout.Context",{requires:["Ext.util.Queue","Ext.layout.ContextItem","Ext.layout.Layout","Ext.fx.Anim","Ext.fx.Manager"],remainingLayouts:0,state:0,constructor:function(n){var t=this;Ext.apply(t,n);t.items={};t.layouts={};t.blockCount=0;t.cycleCount=0;t.flushCount=0;t.calcCount=0;t.animateQueue=t.newQueue();t.completionQueue=t.newQueue();t.finalizeQueue=t.newQueue();t.finishQueue=t.newQueue();t.flushQueue=t.newQueue();t.invalidateData={};t.layoutQueue=t.newQueue();t.invalidQueue=[];t.triggers={data:{},dom:{}}},callLayout:function(n,t){this.currentLayout=n;n[t](this.getCmp(n.owner))},cancelComponent:function(n,t,i){for(var r=this,v=n,y=!n.isComponent,w=y?v.length:1,o,s,f,u,p,h,c,l,a,e=0;e<w;++e){if(y&&(n=v[e]),i&&n.ownerCt&&(a=this.items[n.ownerCt.el.id],a&&Ext.Array.remove(a.childItems,r.getCmp(n))),!t&&(h=r.invalidQueue,s=h.length,s))for(r.invalidQueue=p=[],o=0;o<s;++o)c=h[o],l=c.item.target,l==n||l.isDescendant(n)||p.push(c);u=n.componentLayout;r.cancelLayout(u);u.getLayoutItems&&(f=u.getLayoutItems(),f.length&&r.cancelComponent(f,!0));n.isContainer&&!n.collapsed&&(u=n.layout,r.cancelLayout(u),f=u.getVisibleItems(),f.length&&r.cancelComponent(f,!0))}},cancelLayout:function(n){var t=this;t.completionQueue.remove(n);t.finalizeQueue.remove(n);t.finishQueue.remove(n);t.layoutQueue.remove(n);n.running&&t.layoutDone(n);n.ownerContext=null},clearTriggers:function(n,t){for(var o=n.id,i=this.triggers[t?"dom":"data"],u=i&&i[o],s=u&&u.length||0,f,e,r=0;r<s;++r)e=u[r],f=e.item,i=t?f.domTriggers:f.triggers,delete i[e.prop][o]},flush:function(){var t=this,i=t.flushQueue.clear(),r=i.length,n;if(r)for(++t.flushCount,n=0;n<r;++n)i[n].flush()},flushAnimations:function(){var r=this,t=r.animateQueue.clear(),i=t.length,n;if(i){for(n=0;n<i;n++)t[n].target.animate!==!1&&t[n].flushAnimations();Ext.fx.Manager.runner()}},flushInvalidates:function(){var n=this,r=n.invalidQueue,e=r&&r.length,t,u,f,i;if(n.invalidQueue=[],e){for(u=[],i=0;i<e;++i)t=(f=r[i]).item.target,t.container.isDetachedBody||(u.push(t),f.options&&(n.invalidateData[t.id]=f.options));n.invalidate(u,null)}},flushLayouts:function(n,t,i){var r=this,e=i?r[n].items:r[n].clear(),o=e.length,u,f;if(o){for(u=0;u<o;++u)f=e[u],f.running||r.callLayout(f,t);r.currentLayout=null}},getCmp:function(n){return this.getItem(n,n.el)},getEl:function(n,t){var i=this.getItem(t,t);return i.parent||(i.parent=n,n.children.length?n.children.push(i):n.children=[i]),i},getItem:function(n,t){var i=t.id,r=this.items;return r[i]||(r[i]=new Ext.layout.ContextItem({context:this,target:n,el:t}))},handleFailure:function(){var n=this.layouts,t,i;Ext.failedLayouts=(Ext.failedLayouts||0)+1;for(i in n)t=n[i],n.hasOwnProperty(i)&&(t.running=!1,t.ownerContext=null);Ext.repoDevMode&&!this.pageAnalyzerMode?Ext.Error.raise("Layout run failed"):Ext.log.error("Layout run failed")},invalidate:function(n,t){for(var r=this,v=!n.isComponent,c,l,f,i,o,e,u,s,a,h=0,y=v?n.length:1;h<y;++h)f=v?n[h]:n,f.rendered&&!f.hidden&&(i=r.getCmp(f),e=f.componentLayout,l=!e.ownerContext,u=f.isContainer&&!f.collapsed?f.layout:null,s=r.invalidateData[i.id],delete r.invalidateData[i.id],a=i.init(t,s),s&&r.processInvalidate(s,i,"before"),e.beforeLayoutCycle&&e.beforeLayoutCycle(i),u&&u.beforeLayoutCycle&&u.beforeLayoutCycle(i),a=i.initContinue(a),c=!0,e.getLayoutItems&&(e.renderChildren(),o=e.getLayoutItems(),o.length&&r.invalidate(o,!0)),u&&(c=!1,u.renderChildren(),o=u.getVisibleItems(),o.length&&r.invalidate(o,!0)),i.initDone(c),r.resetLayout(e,i,l),u&&r.resetLayout(u,i,l),i.initAnimation(),s&&r.processInvalidate(s,i,"after"));r.currentLayout=null},layoutDone:function(n){var t=n.ownerContext;n.running=!1;n.isComponentLayout?(t.measuresBox&&t.onBoxMeasured(),t.setProp("done",!0)):t.setProp("containerLayoutDone",!0);--this.remainingLayouts;++this.progressCount},newQueue:function(){return new Ext.util.Queue},processInvalidate:function(n,t,i){if(n[i]){var r=this,u=r.currentLayout;r.currentLayout=n.layout||null;n[i](t,n);r.currentLayout=u}},queueAnimation:function(n){this.animateQueue.add(n)},queueCompletion:function(n){this.completionQueue.add(n)},queueFinalize:function(n){this.finalizeQueue.add(n)},queueFlush:function(n){this.flushQueue.add(n)},chainFns:function(n,t,i){var r=this,f=n.layout,e=t.layout,u=n[i],o=t[i];return function(i){var s=r.currentLayout;u&&(r.currentLayout=f,u.call(n.scope||n,i,n));r.currentLayout=e;o.call(t.scope||t,i,t);r.currentLayout=s}},queueInvalidate:function(n,t){var r=this,o=[],s=r.invalidQueue,h=s.length,u,f,e,i,c;for(n.isComponent?n=r.getCmp(u=n):u=n.target,n.invalid=!0;h--;){if(f=s[h],e=f.item.target,u.isDescendant(e))return;if(e==u){(i=f.options)?t&&(t.widthModel&&(i.widthModel=t.widthModel),t.heightModel&&(i.heightModel=t.heightModel),(c=i.state)?t.state&&Ext.apply(c,t.state):i.state=t.state,t.before&&(i.before=r.chainFns(i,t,"before")),t.after&&(i.after=r.chainFns(i,t,"after"))):f.options=t;return}e.isDescendant(u)||o.push(f)}o.push({item:n,options:t});r.invalidQueue=o},queueItemLayouts:function(n){var i=n.isComponent?n:n.target,t=i.componentLayout;t.pending||t.invalid||t.done||this.queueLayout(t);t=i.layout;!t||t.pending||t.invalid||t.done||this.queueLayout(t)},queueLayout:function(n){this.layoutQueue.add(n);n.pending=!0},removeEl:function(n,t){var i=t.id,r=n.children,u=this.items;r&&Ext.Array.remove(r,u[i]);delete u[i]},resetLayout:function(n,t,i){var r=this;r.currentLayout=n;n.done=!1;n.pending=!0;n.firedTriggers=0;r.layoutQueue.add(n);i?(r.layouts[n.id]=n,n.running=!0,n.finishedLayout&&r.finishQueue.add(n),++r.remainingLayouts,++n.layoutCount,n.ownerContext=t,n.beginCount=0,n.blockCount=0,n.calcCount=0,n.triggerCount=0,n.initialized||n.initLayout(),n.beginLayout(t)):(++n.beginCount,n.running||(++r.remainingLayouts,n.running=!0,n.isComponentLayout&&t.unsetProp("done"),r.completionQueue.remove(n),r.finalizeQueue.remove(n)));n.beginLayoutCycle(t,i)},run:function(){var n=this,t=!1,i=100;for(n.flushInvalidates(),n.state=1,n.totalCount=n.layoutQueue.getCount(),n.flush();(n.remainingLayouts||n.invalidQueue.length)&&i--;){if(n.invalidQueue.length&&n.flushInvalidates(),n.runCycle())t=!1;else if(t){if(!n.invalidQueue.length){n.state=2;break}}else n.flush(),t=!0,n.flushLayouts("completionQueue","completeLayout");n.remainingLayouts||n.invalidQueue.length||(n.flush(),n.flushLayouts("completionQueue","completeLayout"),n.flushLayouts("finalizeQueue","finalizeLayout"))}return n.runComplete()},runComplete:function(){var n=this;return(n.state=2,n.remainingLayouts)?(n.handleFailure(),!1):(n.flush(),n.flushLayouts("finishQueue","finishedLayout",!0),n.flushLayouts("finishQueue","notifyOwner"),n.flush(),n.flushAnimations(),!0)},runCycle:function(){var n=this,i=n.layoutQueue.clear(),r=i.length,t;for(++n.cycleCount,n.progressCount=0,t=0;t<r;++t)n.runLayout(n.currentLayout=i[t]);return n.currentLayout=null,n.progressCount>0},runLayout:function(n){var t=this,i=t.getCmp(n.owner);(n.pending=!1,i.state.blocks)||(n.done=!0,++n.calcCount,++t.calcCount,n.calculate(i),n.done?(t.layoutDone(n),n.completeLayout&&t.queueCompletion(n),n.finalizeLayout&&t.queueFinalize(n)):n.pending||n.invalid||n.blockCount+n.triggerCount-n.firedTriggers||t.queueLayout(n))},setItemSize:function(n,t,i){var r=n,u=1,e,f;for(n.isComposite?(r=n.elements,u=r.length,n=r[0]):n.dom||n.el||(u=r.length,n=r[0]),f=0;f<u;)e=this.get(n),e.setSize(t,i),n=r[++f]}})