Ext.define("Ext.selection.CellModel",{extend:"Ext.selection.Model",alias:"selection.cellmodel",requires:["Ext.grid.CellContext","Ext.util.KeyNav"],isCellModel:!0,enableKeyNav:!0,preventWrap:!1,noSelection:{row:-1,column:-1},constructor:function(){this.addEvents("deselect","select");this.callParent(arguments)},bindComponent:function(n){var t=this,i=n.ownerCt;t.primaryView=n;t.views=t.views||[];t.views.push(n);t.bindStore(n.getStore(),!0);n.on({cellmousedown:t.onMouseDown,refresh:t.onViewRefresh,scope:t});if(i.optimizedColumnMove!==!1)i.on("columnmove",t.onColumnMove,t);t.enableKeyNav&&t.initKeyNav(n)},initKeyNav:function(n){var t=this;if(!n.rendered){n.on("render",Ext.Function.bind(t.initKeyNav,t,[n],0),t,{single:!0});return}n.el.set({tabIndex:-1});t.keyNav=new Ext.util.KeyNav({target:n.el,ignoreInputFields:!0,up:t.onKeyUp,down:t.onKeyDown,right:t.onKeyRight,left:t.onKeyLeft,tab:t.onKeyTab,scope:t})},getHeaderCt:function(){var n=this.getCurrentPosition(),t=n?n.view:this.primaryView;return t.headerCt},onKeyUp:function(n){this.doMove("up",n)},onKeyDown:function(n){this.doMove("down",n)},onKeyLeft:function(n){this.doMove("left",n)},onKeyRight:function(n){this.doMove("right",n)},doMove:function(n,t){this.keyNavigation=!0;this.move(n,t);this.keyNavigation=!1},onVetoUIEvent:Ext.emptyFn,select:function(n,t,i){var r=this,u,f=r.getCurrentPosition(),e=r.view.store;(n||n===0)&&(n.isModel?(u=e.indexOf(n),n=u!==-1?{row:u,column:f?f.column:0}:null):typeof n=="number"&&(n={row:n,column:0}));n?r.selectByPosition(n,i):r.deselect()},deselect:function(n,t){this.selectByPosition(null,t)},move:function(n,t){var u=this,i=u.getCurrentPosition(),r;return i&&(r=i.view.walkCells(i,n,t,u.preventWrap),r)?(r.view=i.view,u.setCurrentPosition(r)):null},getCurrentPosition:function(){return this.selecting?this.nextSelection:this.selection},setCurrentPosition:function(n,t){var i=this,r=i.selection;if(i.lastSelection=r,r)if(n&&n.record===r.record&&n.columnHeader===r.columnHeader&&n.view===r.view)n=null;else i.onCellDeselect(i.selection,t);if(n){i.nextSelection=new Ext.grid.CellContext(i.primaryView).setPosition(n);i.selecting=!0;i.onCellSelect(i.nextSelection,t);return i.selecting=!1,i.selection=i.nextSelection}return null},isCellSelected:function(n,t,i){var f=this,u,r=f.getCurrentPosition();if(r&&r.view===n)return u=new Ext.grid.CellContext(n).setPosition({row:t,column:i}),u.record===r.record&&u.columnHeader===r.columnHeader},onStoreRemove:function(n,t,i){var e=this,r=e.getCurrentPosition(),u,s=t.length,o,f=0;if(e.callParent(arguments),r){if(i[0]>r.row)return;for(u=0;u<s;u++)if(o=i[u],o<r.row)f++;else break;f&&r.setRow(r.row-f)}},onMouseDown:function(n,t,i,r,u,f){f!==-1&&this.setCurrentPosition({view:n,row:u,column:i})},onCellSelect:function(n,t){n&&n.row!==undefined&&n.row>-1&&this.doSelect(n.record,!1,t)},onCellDeselect:function(n,t){n&&n.row!==undefined&&this.doDeselect(n.record,t)},onSelectChange:function(n,t,i,r){var u=this,f,e,o;if(t?(f=u.nextSelection,e="select"):(f=u.lastSelection||u.noSelection,e="deselect"),o=f.view||u.primaryView,(i||u.fireEvent("before"+e,u,n,f.row,f.column))!==!1&&r()!==!1){if(t){o.focusRow(n,!0);o.onCellSelect(f)}else{o.onCellDeselect(f);delete u.selection}i||u.fireEvent(e,u,n,f.row,f.column)}},onKeyTab:function(n){var t=this,r=t.getCurrentPosition(),i;if(r)if(i=r.view.editingPlugin,i&&t.wasEditing)t.onEditorTab(i,n);else t.move(n.shiftKey?"left":"right",n)},onEditorTab:function(n,t){var r=this,u=t.shiftKey?"left":"right",i=r.move(u,t);i&&(r.wasEditing=n.startEdit(i.record,i.columnHeader)?!1:!0)},refresh:function(){var n=this.getCurrentPosition(),t;n&&(t=this.store.indexOf(this.selected.last()))!==-1&&(n.row=t)},onColumnMove:function(n){var t=n.up("tablepanel");if(t)this.onViewRefresh(t.view)},onUpdate:function(n){var t=this,i;if(t.isSelected(n)){i=t.selecting?t.nextSelection:t.selection;t.view.onCellSelect(i)}},onViewRefresh:function(n){var f=this,i=f.getCurrentPosition(),r=n.headerCt,u,t;i&&i.view===n&&(u=i.record,t=i.columnHeader,t.isDescendantOf(r)||(t=r.queryById(t.id)||r.down('[text="'+t.text+'"]')||r.down('[dataIndex="'+t.dataIndex+'"]')),t&&n.store.indexOfId(u.getId())!==-1&&f.setCurrentPosition({row:u,column:t,view:n}))},selectByPosition:function(n,t){this.setCurrentPosition(n,t)}})