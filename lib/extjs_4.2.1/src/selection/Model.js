Ext.define("Ext.selection.Model",{extend:"Ext.util.Observable",alternateClassName:"Ext.AbstractSelectionModel",requires:["Ext.data.StoreManager"],mixins:{bindable:"Ext.util.Bindable"},allowDeselect:undefined,toggleOnClick:!0,selected:null,pruneRemoved:!0,suspendChange:0,constructor:function(n){var t=this;n=n||{};Ext.apply(t,n);t.addEvents("selectionchange","focuschange");t.modes={SINGLE:!0,SIMPLE:!0,MULTI:!0};t.setSelectionMode(n.mode||t.mode);t.selected=new Ext.util.MixedCollection(null,t.getSelectionId);t.callParent(arguments)},bindStore:function(n,t){var i=this;i.mixins.bindable.bindStore.apply(i,arguments);i.store&&!t&&i.refresh()},getStoreListeners:function(){var n=this;return{add:n.onStoreAdd,clear:n.onStoreClear,bulkremove:n.onStoreRemove,update:n.onStoreUpdate,load:n.onStoreLoad,idchanged:n.onModelIdChanged,refresh:n.onStoreRefresh}},suspendChanges:function(){++this.suspendChange},resumeChanges:function(){this.suspendChange&&--this.suspendChange},selectAll:function(n){var t=this,r=t.store.getRange(),i=0,u=r.length,f=t.getSelection().length;for(t.suspendChanges();i<u;i++)t.doSelect(r[i],!0,n);t.resumeChanges();n||t.maybeFireSelectionChange(t.getSelection().length!==f)},deselectAll:function(n){for(var t=this,i=t.getSelection(),u={},o=t.store,s=i.length,f,r=0,e=i.length;r<e;r++)f=i[r],u[f.internalId]=o.indexOf(f);i=Ext.Array.sort(i,function(n,t){var i=u[n.internalId],r=u[t.internalId];return i<r?-1:1});t.suspendChanges();t.doDeselect(i,n);t.resumeChanges();n||t.maybeFireSelectionChange(t.getSelection().length!==s)},selectWithEvent:function(n,t){var i=this,r=i.isSelected(n),e=t.shiftKey,u=t.ctrlKey,c=i.selectionStart,l=i.getSelection(),a=l.length,o=i.allowDeselect,s,f,h;switch(i.selectionMode){case"MULTI":if(e&&c)i.selectRange(c,n,u);else if(u&&r)i.doDeselect(n,!1);else if(u)i.doSelect(n,!0,!1);else if(r&&!e&&!u&&a>1){for(s=[],f=0;f<a;++f)h=l[f],h!==n&&s.push(h);i.doDeselect(s)}else r||i.doSelect(n,!1);break;case"SIMPLE":r?i.doDeselect(n):i.doSelect(n,!0);break;case"SINGLE":o&&!u&&(o=i.toggleOnClick);o&&r?i.doDeselect(n):i.doSelect(n,!1)}e||(i.selectionStart=i.isSelected(n)?n:null)},afterKeyNavigate:function(n,t){var i=this,r,o,u=i.isSelected(t),f=i.selectionStart&&i.isSelected(i.lastFocused)?i.selectionStart:i.selectionStart=i.lastFocused,e=n.getCharCode(),s=e===n.SPACE,h=e===n.UP||e===n.PAGE_UP?"up":e===n.DOWN||e===n.DOWN?"down":null;switch(i.selectionMode){case"MULTI":s?n.shiftKey?i.selectRange(f,t,n.ctrlKey):u?(i.doDeselect(t,n.ctrlKey),i.setLastFocused(null),i.setLastFocused(t)):i.doSelect(t,n.ctrlKey):n.shiftKey&&f?(o=i.store.indexOf(f),r=i.store.indexOf(t),h==="up"&&o<=r?i.deselectRange(i.lastFocused,r+1):h==="down"&&o>=r?i.deselectRange(i.lastFocused,r-1):f!==t&&i.selectRange(f,t,n.ctrlKey),i.lastSelected=t,i.setLastFocused(t)):n.ctrlKey&&u?i.setLastFocused(t):n.ctrlKey?i.setLastFocused(t):i.doSelect(t,!1);break;case"SIMPLE":u?i.doDeselect(t):i.doSelect(t,!0);break;case"SINGLE":s?u?(i.doDeselect(t),i.setLastFocused(t)):i.doSelect(t):n.ctrlKey?i.setLastFocused(t):i.allowDeselect&&u?i.doDeselect(t):i.doSelect(t,!1)}n.shiftKey||i.isSelected(t)&&(i.selectionStart=t)},selectRange:function(n,t,i){var u=this,o=u.store,a=u.selected.items,s,r,f,h,e,c,l;if(!u.isLocked()){for(s=u.normalizeRowRange(n,t),n=s[0],t=s[1],h=[],r=n;r<=t;r++)u.isSelected(o.getAt(r))||h.push(o.getAt(r));if(!i){for(e=[],u.suspendChanges(),r=0,f=a.length;r<f;++r)l=a[r],c=o.indexOf(l),(c<n||c>t)&&e.push(l);for(r=0,f=e.length;r<f;++r)u.doDeselect(e[r]);u.resumeChanges()}u.doMultiSelect(h,!0)}},deselectRange:function(n,t){var i=this,o=i.store,u,r,f,e;if(!i.isLocked()){for(u=i.normalizeRowRange(n,t),n=u[0],t=u[1],f=[],r=n;r<=t;r++)e=o.getAt(r),i.isSelected(e)&&f.push(e);i.doDeselect(f)}},normalizeRowRange:function(n,t){var i=this.store,r;return Ext.isNumber(n)||(n=i.indexOf(n)),n=Math.max(0,n),Ext.isNumber(t)||(t=i.indexOf(t)),t=Math.min(t,i.getCount()-1),n>t&&(r=t,t=n,n=r),[n,t]},onModelIdChanged:function(n,t,i,r,u){this.selected.updateKey(u,r)},select:function(n,t,i){Ext.isDefined(n)&&this.doSelect(n,t,i)},deselect:function(n,t){this.doDeselect(n,t)},doSelect:function(n,t,i){var r=this,u;if(!r.locked&&r.store){if(typeof n=="number"){if(u=r.store.getAt(n),!u)return;n=[u]}r.selectionMode=="SINGLE"&&n?(u=n.length?n[0]:n,r.doSingleSelect(u,i)):r.doMultiSelect(n,t,i)}},doMultiSelect:function(n,t,i){var r=this,e=r.selected,s=!1,o,f,h,u,c;if(!r.locked){if(n=Ext.isArray(n)?n:[n],h=n.length,!t&&e.getCount()>0&&(o=r.deselectDuringSelect(n,e.getRange(),i),o[0])){r.maybeFireSelectionChange(o[1]>0&&!i);return}for(c=function(){e.add(u);s=!0},f=0;f<h;f++)if(u=n[f],!r.isSelected(u)){r.lastSelected=u;r.onSelectChange(u,!0,i,c)}r.preventFocus||r.setLastFocused(u,i);r.maybeFireSelectionChange(s&&!i)}},deselectDuringSelect:function(n,t,i){var u=this,s=t.length,e=0,o=!1,f,r;for(u.suspendChanges(),r=0;r<s;++r)f=t[r],Ext.Array.contains(n,f)||(u.doDeselect(f,i)?++e:o=!0);return u.resumeChanges(),[o,e]},doDeselect:function(n,t){var i=this,e=i.selected,u=0,o,r,s=0,f=0,h;if(i.locked||!i.store)return!1;if(typeof n=="number"){if(r=i.store.getAt(n),!r)return!1;n=[r]}else Ext.isArray(n)||(n=[n]);for(h=function(){++f;e.remove(r)},o=n.length,i.suspendChanges();u<o;u++)if(r=n[u],i.isSelected(r)){i.lastSelected===r&&(i.lastSelected=e.last(),i.lastFocused===r&&i.setLastFocused(null));++s;i.onSelectChange(r,!1,t,h)}return i.resumeChanges(),i.maybeFireSelectionChange(f>0&&!t),f===s},doSingleSelect:function(n,t){var i=this,r=!1,u=i.selected,f;if(!i.locked&&!i.isSelected(n)){if(u.getCount()){if(i.suspendChanges(),!i.doDeselect(i.lastSelected,t)){i.resumeChanges();return}i.resumeChanges()}f=function(){u.add(n);i.lastSelected=n;r=!0};i.onSelectChange(n,!0,t,f);r&&(t||i.preventFocus||i.setLastFocused(n),i.maybeFireSelectionChange(!t))}},setLastFocused:function(n,t){var i=this,r=i.lastFocused;if(n!==r){i.lastFocused=n;i.onLastFocusChanged(r,n,t)}},isFocused:function(n){return n===this.getLastFocused()},maybeFireSelectionChange:function(n){var t=this;n&&!t.suspendChange&&t.fireEvent("selectionchange",t,t.getSelection())},getLastSelected:function(){return this.lastSelected},getLastFocused:function(){return this.lastFocused},getSelection:function(){return this.selected.getRange()},getSelectionMode:function(){return this.selectionMode},setSelectionMode:function(n){n=n?n.toUpperCase():"SINGLE";this.selectionMode=this.modes[n]?n:"SINGLE"},isLocked:function(){return this.locked},setLocked:function(n){this.locked=!!n},isRangeSelected:function(n,t){var r=this,f=r.store,i,u;for(u=r.normalizeRowRange(n,t),n=u[0],t=u[1],i=n;i<=t;i++)if(!r.isSelected(f.getAt(i)))return!1;return!0},isSelected:function(n){return n=Ext.isNumber(n)?this.store.getAt(n):n,this.selected.contains(n)},hasSelection:function(){return this.selected.getCount()>0},getSelectionId:function(n){return n.internalId},pruneIf:function(){var i=this,r=i.selected,t=[],u=r.length,n,f;if(i.pruneRemoved){for(n=0;n<u;n++)f=r.getAt(n),this.storeHasSelected(f)||t.push(f);if(t.length){for(n=0,u=t.length;n<u;n++)r.remove(t[n]);i.maybeFireSelectionChange(!0)}}},storeHasSelected:function(n){var r=this.store,i,u,f,t;if(n.hasId()&&r.getById(n))return!0;for(i=r.data.items,u=i.length,f=n.internalId,t=0;t<u;++t)if(f===i[t].internalId)return!0;return!1},refresh:function(){var n=this,u=n.store,f,i=[],t=[],o=n.getSelection(),c=o.length,r,s,e=0,h=n.getLastFocused();if(u){for(;e<c;e++)if(r=o[e],u.indexOf(r)!==-1?i.push(r):n.pruneRemoved||(f=u.getById(r.getId()),f?i.push(f):t.push(r)),n.mode==="SINGLE"&&t.length)break;n.selected.getCount()!=i.length+t.length&&(s=!0);n.clearSelections();u.indexOf(h)!==-1&&n.setLastFocused(h,!0);i.length&&n.doSelect(i,!1,!0);t.length&&(n.selected.addAll(t),n.lastSelected||(n.lastSelected=t[t.length-1]));n.maybeFireSelectionChange(s)}},clearSelections:function(){this.selected.clear();this.lastSelected=null;this.setLastFocused(null)},onStoreAdd:Ext.emptyFn,onStoreClear:function(){this.selected.getCount()>0&&(this.clearSelections(),this.maybeFireSelectionChange(!0))},onStoreRemove:function(n,t,i,r){var u=this;(u.selectionStart&&Ext.Array.contains(t,u.selectionStart)&&(u.selectionStart=null),r||u.locked||!u.pruneRemoved)||u.deselectDeletedRecords(t)},deselectDeletedRecords:function(n){for(var t=this,f=t.selected,e=n.length,u=0,r,i=0;i<e;i++)r=n[i],f.remove(r)&&(t.lastSelected==r&&(t.lastSelected=null),t.getLastFocused()==r&&t.setLastFocused(null),++u);u&&t.maybeFireSelectionChange(!0)},getCount:function(){return this.selected.getCount()},onUpdate:Ext.emptyFn,destroy:function(){this.clearListeners()},onStoreUpdate:Ext.emptyFn,onStoreRefresh:Ext.emptyFn,onStoreLoad:Ext.emptyFn,onSelectChange:function(n,t,i,r){var u=this,f=t?"select":"deselect";(i||u.fireEvent("before"+f,u,n))!==!1&&r()!==!1&&(i||u.fireEvent(f,u,n))},onLastFocusChanged:function(n,t){this.fireEvent("focuschange",this,n,t)},onEditorKey:Ext.emptyFn,beforeViewRender:function(n){this.views=this.views||[];this.views.push(n);this.bindStore(n.getStore(),!0)},bindComponent:Ext.emptyFn})