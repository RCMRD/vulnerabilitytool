Ext.define("Ext.grid.locking.Lockable",{alternateClassName:"Ext.grid.Lockable",requires:["Ext.grid.locking.View","Ext.grid.header.Container","Ext.grid.locking.HeaderContainer","Ext.view.Table"],syncRowHeight:!0,headerCounter:0,scrollDelta:40,lockedGridCls:Ext.baseCSSPrefix+"grid-inner-locked",unlockText:"Unlock",lockText:"Lock",bothCfgCopy:["invalidateScrollerOnRefresh","hideHeaders","enableColumnHide","enableColumnMove","enableColumnResize","sortableColumns","columnLines","rowLines"],normalCfgCopy:["verticalScroller","verticalScrollDock","verticalScrollerType","scroll"],lockedCfgCopy:[],determineXTypeToCreate:function(n){var f=this,i,t,r,e,u;if(f.subGridXType)i=f.subGridXType;else{if(!n)return"gridpanel";t=this.getXTypes().split("/");r=t.length;e=t[r-1];u=t[r-2];i=u!=="tablepanel"?u:e}return i},injectLockable:function(){this.lockable=!0;this.hasView=!0;var n=this,h=Ext.getScrollbarSize().height,a=n.store=Ext.StoreManager.lookup(n.store),v=n.getSelectionModel(),y,c,i,t,r,f,e,l,u,o,s,p=n.findPlugin("bufferedrenderer");for(y=n.constructLockableFeatures(),n.features&&(n.features=null),c=n.constructLockablePlugins(),n.plugins=c.topPlugins,i=Ext.apply({id:n.id+"-locked",isLocked:!0,ownerLockable:n,xtype:n.determineXTypeToCreate(!0),store:a,scrollerOwner:!1,animate:!1,scroll:h?!1:"vertical",selModel:v,border:!1,cls:n.lockedGridCls,isLayoutRoot:function(){return!1},features:y.lockedFeatures,plugins:c.lockedPlugins},n.lockedGridConfig),t=Ext.apply({id:n.id+"-normal",isLocked:!1,ownerLockable:n,xtype:n.determineXTypeToCreate(),store:a,scrollerOwner:!1,selModel:v,border:!1,isLayoutRoot:function(){return!1},features:y.normalFeatures,plugins:c.normalPlugins},n.normalGridConfig),n.addCls(Ext.baseCSSPrefix+"grid-locked"),Ext.copyTo(t,n,n.bothCfgCopy,!0),Ext.copyTo(i,n,n.bothCfgCopy,!0),Ext.copyTo(t,n,n.normalCfgCopy,!0),Ext.copyTo(i,n,n.lockedCfgCopy,!0),r=0;r<n.normalCfgCopy.length;r++)delete n[n.normalCfgCopy[r]];for(r=0;r<n.lockedCfgCopy.length;r++)delete n[n.lockedCfgCopy[r]];if(n.addEvents("processcolumns","lockcolumn","unlockcolumn"),n.addStateEvents(["lockcolumn","unlockcolumn"]),f=n.processColumns(n.columns),i.width=f.lockedWidth+Ext.num(v.headerWidth,0)+(f.locked.items.length?1:0),i.columns=f.locked,t.columns=f.normal,t.flex=1,i.viewConfig=n.lockedViewConfig||{},i.viewConfig.loadingUseMsg=!1,i.viewConfig.loadMask=!1,h&&(i.viewConfig.style="border-bottom:"+h+"px solid #f6f6f6;"+(i.viewConfig.style||"")),t.viewConfig=n.normalViewConfig||{},t.viewConfig.loadMask=!1,n.viewConfig&&n.viewConfig.id&&Ext.log.warn('id specified on Lockable viewConfig, it will be shared between both views: "'+n.viewConfig.id+'"'),Ext.applyIf(i.viewConfig,n.viewConfig),Ext.applyIf(t.viewConfig,n.viewConfig),n.lockedGrid=Ext.ComponentManager.create(i),n.isTree&&(n.lockedGrid.getView().animate=!1,t.store=n.lockedGrid.view.store,t.deferRowRender=!1,t.viewConfig.stripeRows=n.lockedGrid.view.stripeRows,t.rowLines=n.lockedGrid.rowLines),u=n.lockedGrid.getView(),t.viewConfig.lockingPartner=u,n.normalGrid=Ext.ComponentManager.create(t),u.lockingPartner=o=n.normalGrid.getView(),n.view=new Ext.grid.locking.View({loadingText:o.loadingText,loadingCls:o.loadingCls,loadingUseMsg:o.loadingUseMsg,loadMask:n.loadMask!==!1,locked:n.lockedGrid,normal:n.normalGrid,panel:n}),s=p?{}:{scroll:{fn:n.onLockedViewScroll,element:"el",scope:n}},h){n.lockedGrid.on({afterlayout:n.afterLockedViewLayout,scope:n});u.getOverflowStyle();u.scrollFlags.y?n.lockedGrid.headerCt.forceFit=!0:s.mousewheel={fn:n.onLockedViewMouseWheel,element:"el",scope:n}}u.on(s);s=p?{}:{scroll:{fn:n.onNormalViewScroll,element:"el",scope:n},scope:n};o.on(s);e=n.lockedGrid.headerCt;l=n.normalGrid.headerCt;n.headerCt=n.view.headerCt=new Ext.grid.locking.HeaderContainer(n);e.lockedCt=!0;e.lockableInjected=!0;l.lockableInjected=!0;e.on({add:{buffer:1,scope:n,fn:n.onLockedHeaderAdd},columnshow:n.onLockedHeaderShow,columnhide:n.onLockedHeaderHide,sortchange:n.onLockedHeaderSortChange,columnresize:n.onLockedHeaderResize,scope:n});l.on({sortchange:n.onNormalHeaderSortChange,scope:n});n.modifyHeaderCt();n.items=[n.lockedGrid,n.normalGrid];n.relayHeaderCtEvents(e);n.relayHeaderCtEvents(l);n.storeRelayers=n.relayEvents(a,["filterchange"]);n.layout={type:"hbox",align:"stretch"}},getLockingViewConfig:function(){return{xclass:"Ext.grid.locking.View",locked:this.lockedGrid,normal:this.normalGrid,panel:this}},processColumns:function(n){var i,e,t,r=this.dummyHdrCtr||(this.self.prototype.dummyHdrCtr=new Ext.grid.header.Container),u=[],f=[],o={itemId:"lockedHeaderCt",stretchMaxPartner:"^^>>#normalHeaderCt",items:u},s={itemId:"normalHeaderCt",stretchMaxPartner:"^^>>#lockedHeaderCt",items:f},h={lockedWidth:0,locked:o,normal:s};for(Ext.isObject(n)&&(Ext.applyIf(o,n),Ext.applyIf(s,n),Ext.apply(r,n),n=n.items),i=0,e=n.length;i<e;++i)t=n[i],t.isComponent||(t=r.lookupComponent(r.applyDefaults(t))),t.processed=!0,t.locked||t.autoLock?(t.hidden||(h.lockedWidth+=this.getColumnWidth(t)||r.defaultWidth),u.push(t)):f.push(t),t.headerId||(t.headerId=(t.initialConfig||t).id||"h"+ ++this.headerCounter);return this.fireEvent("processcolumns",this,u,f),h},getColumnWidth:function(n){var i=n.width||0,r,u,t;if(n.flex&&Ext.Error.raise("Columns which are locked do NOT support a flex width. You must set a width on the "+n.text+"column."),!i&&n.isGroupHeader)for(r=n.items.items,u=r.length,t=0;t<u;t++)i+=this.getColumnWidth(r[t]);return i},afterLockedViewLayout:function(){var t=this,n=t.lockedGrid.getView(),i=n.el.dom,r=t.normalGrid.headerCt.tooNarrow?Ext.getScrollbarSize().height:0;n.scrollFlags.x&&i.scrollWidth>i.clientWidth&&(r=0);n.el.dom.style.borderBottomWidth=r+"px";Ext.isBorderBox||n.el.setHeight(n.lastBox.height)},onLockedViewMouseWheel:function(n){var i=this,e=-i.scrollDelta,r=e*n.getWheelDeltas().y,t=i.lockedGrid.getView().el.dom,u,f;i.ignoreMousewheel||(t&&(u=t.scrollTop!==t.scrollHeight-t.clientHeight,f=t.scrollTop!==0),(r<0&&f||r>0&&u)&&(n.stopEvent(),t.scrollTop+=r,i.normalGrid.getView().el.dom.scrollTop=t.scrollTop,i.onNormalViewScroll()))},onLockedViewScroll:function(){var n=this,i=n.lockedGrid.getView(),r=n.normalGrid.getView(),u=r.el.dom,f=i.el.dom,t,e;u.scrollTop!==f.scrollTop&&(u.scrollTop=f.scrollTop,n.store.buffered&&(e=i.el.child("table",!0),t=r.el.child("table",!0),t.style.position="absolute",t.style.top=e.style.top))},onNormalViewScroll:function(){var n=this,i=n.lockedGrid.getView(),r=n.normalGrid.getView(),u=r.el.dom,f=i.el.dom,e,t;u.scrollTop!==f.scrollTop&&(f.scrollTop=u.scrollTop,n.store.buffered&&(t=i.el.child("table",!0),e=r.el.child("table",!0),t.style.position="absolute",t.style.top=e.style.top))},syncRowHeights:function(){var r=this,n,u=r.lockedGrid.getView(),t=r.normalGrid.getView(),f=u.all.slice(),e=t.all.slice(),o=f.length,i;if(e.length===o){for(n=0;n<o;n++)t.syncRowHeights(f[n],e[n]);i=t.el.dom.scrollTop;t.el.dom.scrollTop=i;u.el.dom.scrollTop=i}},modifyHeaderCt:function(){var n=this;n.lockedGrid.headerCt.getMenuItems=n.getMenuItems(n.lockedGrid.headerCt.getMenuItems,!0);n.normalGrid.headerCt.getMenuItems=n.getMenuItems(n.normalGrid.headerCt.getMenuItems,!1);n.lockedGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(n.lockedGrid.headerCt.showMenuBy,n.showMenuBy);n.normalGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(n.normalGrid.headerCt.showMenuBy,n.showMenuBy)},onUnlockMenuClick:function(){this.unlock()},onLockMenuClick:function(){this.lock()},showMenuBy:function(n,t){var u=this.getMenu(),i=u.down("#unlockItem"),r=u.down("#lockItem"),f=i.prev();t.lockable===!1?(f.hide(),i.hide(),r.hide()):(f.show(),i.show(),r.show(),i.initialConfig.disabled||i.setDisabled(t.lockable===!1),r.initialConfig.disabled||r.setDisabled(!t.isLockable()))},getMenuItems:function(n,t){var i=this,r=i.unlockText,u=i.lockText,f=Ext.baseCSSPrefix+"hmenu-unlock",e=Ext.baseCSSPrefix+"hmenu-lock",o=Ext.Function.bind(i.onUnlockMenuClick,i),s=Ext.Function.bind(i.onLockMenuClick,i);return function(){var i=n.call(this);return i.push("-",{itemId:"unlockItem",cls:f,text:r,handler:o,disabled:!t}),i.push({itemId:"lockItem",cls:e,text:u,handler:s,disabled:t}),i}},syncLockedWidth:function(){var t=this,n=t.lockedGrid,i=n.view,e=i.el.dom,r=t.normalGrid,u=n.headerCt.getVisibleGridColumns().length,f=r.headerCt.getVisibleGridColumns().length;return Ext.suspendLayouts(),f?(r.show(),u?(n.headerCt.forceFit||(delete n.flex,n.setWidth(n.headerCt.getFullWidth())),n.addCls(t.lockedGridCls),n.show()):(n.getView().refresh(),n.hide()),i.el.setStyle(i.getOverflowStyle()),t.ignoreMousewheel=i.scrollFlags.y):(r.hide(),e.style.borderBottomWidth="0",n.flex=1,delete n.width,n.removeCls(t.lockedGridCls),n.show(),i.el.setStyle(r.view.getOverflowStyle()),t.ignoreMousewheel=!0),Ext.resumeLayouts(!0),[u,f]},onLockedHeaderAdd:function(){this.ignoreAddLockedColumn||this.syncLockedWidth()},onLockedHeaderResize:function(){this.syncLockedWidth()},onLockedHeaderHide:function(){this.syncLockedWidth()},onLockedHeaderShow:function(){this.syncLockedWidth()},onLockedHeaderSortChange:function(n,t,i){i&&this.normalGrid.headerCt.clearOtherSortStates(null,!0)},onNormalHeaderSortChange:function(n,t,i){i&&this.lockedGrid.headerCt.clearOtherSortStates(null,!0)},lock:function(n,t){var i=this,u=i.normalGrid,f=i.lockedGrid,s=u.headerCt,e=f.headerCt,r,o;(n=n||s.getMenu().activeHeader,o=n.ownerCt,n.isLockable())&&(n.flex&&(n.width=n.getWidth(),n.flex=null),Ext.suspendLayouts(),o.remove(n,!1),n.locked=!0,i.ignoreAddLockedColumn=!0,Ext.isDefined(t)?e.insert(t,n):e.add(n),i.ignoreAddLockedColumn=!1,r=i.syncLockedWidth(),r[0]&&f.getView().refresh(),r[1]&&u.getView().refresh(),Ext.resumeLayouts(!0),i.fireEvent("lockcolumn",i,n))},unlock:function(n,t){var i=this,u=i.normalGrid,f=i.lockedGrid,e=u.headerCt,o=f.headerCt,r;Ext.isDefined(t)||(t=0);n=n||o.getMenu().activeHeader;Ext.suspendLayouts();n.ownerCt.remove(n,!1);n.locked=!1;e.insert(t,n);r=i.syncLockedWidth();r[0]&&f.getView().refresh();r[1]&&u.getView().refresh();Ext.resumeLayouts(!0);i.fireEvent("unlockcolumn",i,n)},reconfigureLockable:function(n,t){var i=this,f=i.store,r=i.lockedGrid,u=i.normalGrid;Ext.suspendLayouts();t&&(r.headerCt.removeAll(),u.headerCt.removeAll(),t=i.processColumns(t),i.ignoreAddLockedColumn=!0,r.headerCt.add(t.locked.items),i.ignoreAddLockedColumn=!1,u.headerCt.add(t.normal.items),i.syncLockedWidth());n&&n!==f?(n=Ext.data.StoreManager.lookup(n),i.store=n,r.bindStore(n),u.bindStore(n)):(r.getView().refresh(),u.getView().refresh());Ext.resumeLayouts(!0)},constructLockableFeatures:function(){var r=this.features,n,u,t,i,f=0,e;if(r)for(t=[],i=[],e=r.length;f<e;f++){n=r[f];n.isFeature||(n=Ext.create("feature."+n.ftype,n));switch(n.lockableScope){case"locked":t.push(n);break;case"normal":i.push(n);break;default:n.lockableScope="both";t.push(n);i.push(u=n.clone());u.lockingPartner=n;n.lockingPartner=u}}return{normalFeatures:i,lockedFeatures:t}},constructLockablePlugins:function(){var r=this.plugins,n,u,f,e,t,i,o=0,s;if(r)for(e=[],t=[],i=[],s=r.length;o<s;o++){n=r[o];switch(n.lockableScope){case"both":t.push(f=n.clonePlugin());i.push(u=n.clonePlugin());f.lockingPartner=u;u.lockingPartner=f;Ext.destroy(n);break;case"locked":t.push(n);break;case"normal":i.push(n);break;default:e.push(n)}}return{topPlugins:e,normalPlugins:i,lockedPlugins:t}},destroyLockable:function(){Ext.destroy(this.view)}},function(){this.borrow(Ext.AbstractComponent,["constructPlugin"])})