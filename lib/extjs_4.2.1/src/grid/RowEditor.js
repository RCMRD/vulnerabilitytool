Ext.define("Ext.grid.RowEditor",{extend:"Ext.form.Panel",alias:"widget.roweditor",requires:["Ext.tip.ToolTip","Ext.util.HashMap","Ext.util.KeyNav","Ext.grid.RowEditorButtons"],saveBtnText:"Update",cancelBtnText:"Cancel",errorsText:"Errors",dirtyText:"You need to commit or cancel your changes",lastScrollLeft:0,lastScrollTop:0,border:!1,buttonUI:"default",hideMode:"offsets",initComponent:function(){var n=this,t=n.editingPlugin.grid,i=Ext.container.Container;n.cls=Ext.baseCSSPrefix+"grid-editor "+Ext.baseCSSPrefix+"grid-row-editor";n.layout={type:"hbox",align:"middle"};n.lockable=t.lockable;n.lockable?n.items=[n.lockedColumnContainer=new i({id:t.id+"-locked-editor-cells",layout:{type:"hbox",align:"middle"},margin:"0 1 0 0"}),n.normalColumnContainer=new i({flex:1,id:t.id+"-normal-editor-cells",layout:{type:"hbox",align:"middle"}})]:n.lockedColumnContainer=n.normalColumnContainer=n;n.callParent(arguments);n.fields&&(n.addFieldsForColumn(n.fields,!0),n.insertColumnEditor(n.fields),delete n.fields);n.mon(n.hierarchyEventSource,{scope:n,show:n.repositionIfVisible});n.getForm().trackResetOnLoad=!0},onGridResize:function(){var n=this,i=n.getClientWidth(),t=n.editingPlugin.grid,r=t.body,u=n.getFloatingButtons();n.setLocalX(r.getOffsetsTo(t)[0]+r.getBorderWidth("l")-t.el.getBorderWidth("l"));n.setWidth(i);u.setLocalX((i-u.getWidth())/2)},onFieldRender:function(n){var t=this,i=n.column;if(i.isVisible())t.syncFieldWidth(i);else if(!i.rendered)t.view.headerCt.on({afterlayout:Ext.Function.bind(t.syncFieldWidth,t,[i]),single:!0})},syncFieldWidth:function(n){var t=n.getEditor(),i;t._marginWidth=t._marginWidth||t.el.getMargin("lr");i=n.getWidth()-t._marginWidth;t.setWidth(i);t.xtype==="displayfield"&&(t.inputWidth=i)},onFieldChange:function(){var n=this,i=n.getForm(),t=i.isValid();n.errorSummary&&n.isVisible()&&n[t?"hideToolTip":"showToolTip"]();n.updateButton(t);n.isValid=t},updateButton:function(n){var t=this.floatingButtons;t?t.child("#update").setDisabled(!n):this.updateButtonDisabled=!n},afterRender:function(){var n=this,t=n.editingPlugin,i=t.grid,r=i.lockable?i.normalGrid.view:i.view;n.callParent(arguments);n.scrollingView=r;n.scrollingViewEl=r.el;r.mon(n.scrollingViewEl,"scroll",n.onViewScroll,n);n.mon(n.el,{click:Ext.emptyFn,stopPropagation:!0});n.mon(i,{resize:n.onGridResize,scope:n});n.el.swallowEvent(["keypress","keydown"]);n.fieldScroller=n.normalColumnContainer.layout.innerCt;n.fieldScroller.dom.style.overflow="hidden";n.fieldScroller.on({scroll:n.onFieldContainerScroll,scope:n});n.keyNav=new Ext.util.KeyNav(n.el,{enter:t.completeEdit,esc:t.onEscKey,scope:t});n.mon(t.view,{beforerefresh:n.onBeforeViewRefresh,refresh:n.onViewRefresh,itemremove:n.onViewItemRemove,scope:n});n.preventReposition=!0;Ext.Array.each(n.query("[isFormField]"),function(t){if(t.column.isVisible())n.onColumnShow(t.column)},n);delete n.preventReposition},onBeforeViewRefresh:function(n){var t=this,i=n.el.dom;t.el.dom.parentNode===i&&i.removeChild(t.el.dom)},onViewRefresh:function(n){var t=this,i=t.context,r;i&&(r=n.getNode(i.record,!0))?(i.row=r,t.reposition(),t.tooltip&&t.tooltip.isVisible()&&t.tooltip.setTarget(i.row)):t.editingPlugin.cancelEdit()},onViewItemRemove:function(n){var t=this.context;t&&n===t.record&&this.editingPlugin.cancelEdit()},onViewScroll:function(){var n=this,f=n.editingPlugin.view.el,i=n.scrollingViewEl,r=i.dom.scrollTop,u=i.getScrollLeft(),e=u!==n.lastScrollLeft,o=r!==n.lastScrollTop,t;n.lastScrollTop=r;n.lastScrollLeft=u;n.isVisible()&&(t=Ext.getDom(n.context.row.id),t&&f.contains(t)?o&&(n.context.row=t,n.reposition(null,!0),(n.tooltip&&n.tooltip.isVisible()||n.hiddenTip)&&n.repositionTip(),n.syncEditorClip()):n.setLocalY(-400));n.rendered&&e&&n.syncFieldsHorizontalScroll()},syncFieldsHorizontalScroll:function(){this.fieldScroller.setScrollLeft(this.lastScrollLeft)},onFieldContainerScroll:function(){this.scrollingViewEl.setScrollLeft(this.fieldScroller.getScrollLeft())},onColumnResize:function(n){var t=this;t.rendered&&(t.onGridResize(),t.onViewScroll(),n.isGroupHeader||(t.syncFieldWidth(n),t.repositionIfVisible()))},onColumnHide:function(n){n.isGroupHeader||(n.getEditor().hide(),this.repositionIfVisible())},onColumnShow:function(n){var t=this;t.rendered&&!n.isGroupHeader&&(n.getEditor().show(),t.syncFieldWidth(n),t.preventReposition||this.repositionIfVisible())},onColumnMove:function(n,t,i){var s=this,e,o=1,h,r,u,f=n.isLocked()?s.lockedColumnContainer:s.normalColumnContainer;if(n.isGroupHeader){for(Ext.suspendLayouts(),n=n.getGridColumns(),i>t&&(i--,o=0),this.addFieldsForColumn(n),e=0,h=n.length;e<h;e++,t+=o,i+=o)r=n[e].getEditor(),u=f.items.indexOf(r),u===-1?f.insert(i,r):u!=i&&f.move(t,i);Ext.resumeLayouts(!0)}else i>t&&i--,this.addFieldsForColumn(n),r=n.getEditor(),u=f.items.indexOf(r),u===-1?f.insert(i,r):u!=i&&f.move(t,i)},onColumnAdd:function(n){n.isGroupHeader&&(n=n.getGridColumns());this.addFieldsForColumn(n);this.insertColumnEditor(n);this.preventReposition=!1},insertColumnEditor:function(n){var i=this,r,u,t;if(Ext.isArray(n)){for(t=0,u=n.length;t<u;t++)i.insertColumnEditor(n[t]);return}n.getEditor&&(r=n.isLocked()?i.lockedColumnContainer:i.normalColumnContainer,r.insert(n.getVisibleIndex(),n.getEditor()))},onColumnRemove:function(n,t){t=t.isGroupHeader?t.getGridColumns():t;this.removeColumnEditor(t)},removeColumnEditor:function(n){var u=this,t,r,i;if(Ext.isArray(n)){for(i=0,r=n.length;i<r;i++)u.removeColumnEditor(n[i]);return}n.hasEditor()&&(t=n.getEditor(),t&&t.ownerCt&&t.ownerCt.remove(t,!1))},onColumnReplace:function(n,t,i,r){this.onColumnRemove(r.ownerCt,r)},getFloatingButtons:function(){var n=this,t=n.floatingButtons;return t||(n.floatingButtons=t=new Ext.grid.RowEditorButtons({rowEditor:n})),t},repositionIfVisible:function(n){var t=this,i=t.view;(!n||n!=t&&n.el.isAncestor(i.el))&&t.isVisible()&&i.isVisible(!0)&&t.reposition()},getRefOwner:function(){return this.editingPlugin.grid},getRefItems:function(){var t=this,n;return t.lockable?(n=t.lockedColumnContainer.getRefItems(),n.push.apply(n,t.normalColumnContainer.getRefItems())):n=t.callParent(),n.push.apply(n,t.getFloatingButtons().getRefItems()),n},reposition:function(n,t){var i=this,o=i.context,r=o&&Ext.get(o.row),s=0,h,f,e,u;r&&Ext.isElement(r.dom)&&(e=i.syncButtonPosition(i.getScrollDelta()),i.editingPlugin.grid.rowLines||(s=-parseInt(r.first().getStyle("border-bottom-width"))),h=i.calculateLocalRowTop(r),f=i.calculateEditorTop(h)+s,t||(u=function(){e&&i.scrollingViewEl.scrollBy(0,e,!0);i.focusContextCell()}),i.syncEditorClip(),n?i.animate(Ext.applyIf({to:{top:f},duration:n.duration||125,callback:u},n)):(i.setLocalY(f),u&&u()))},getScrollDelta:function(){var n=this,i=n.scrollingViewEl.dom,r=n.context,u=n.body,t=0;return r&&(t=Ext.fly(r.row).getOffsetsTo(i)[1]-u.getBorderPadding().beforeY,t>0&&(t=Math.max(t+n.getHeight()+n.floatingButtons.getHeight()-i.clientHeight-u.getBorderWidth("b"),0))),t},calculateLocalRowTop:function(n){var t=this.editingPlugin.grid;return Ext.fly(n).getOffsetsTo(t)[1]-t.el.getBorderWidth("t")+this.lastScrollTop},calculateEditorTop:function(n){return n-this.body.getBorderPadding().beforeY-this.lastScrollTop},getClientWidth:function(){var t=this,n=t.editingPlugin.grid;return t.lockable?n.lockedGrid.getWidth()+n.normalGrid.view.el.dom.clientWidth-1:n.view.el.dom.clientWidth},getEditor:function(n){var t=this;return Ext.isNumber(n)?t.query("[isFormField]")[n]:n.isHeader&&!n.isGroupHeader?n.getEditor():void 0},addFieldsForColumn:function(n,t){var i=this,u,f,r;if(Ext.isArray(n)){for(u=0,f=n.length;u<f;u++)i.addFieldsForColumn(n[u],t);return}if(n.getEditor)if(r=n.getEditor(null,{xtype:"displayfield",getModelData:function(){return null}}),n.align==="right"&&(r.fieldStyle="text-align:right"),n.xtype==="actioncolumn"&&(r.fieldCls+=" "+Ext.baseCSSPrefix+"form-action-col-field"),i.isVisible()&&i.context&&(r.is("displayfield")?i.renderColumnData(r,i.context.record,n):(r.suspendEvents(),r.setValue(i.context.record.get(n.dataIndex)),r.resumeEvents())),n.hidden)i.onColumnHide(n);else if(n.rendered&&!t)i.onColumnShow(n)},loadRecord:function(n){for(var i=this,u=i.getForm(),s=u.getFields(),f=s.items,r=f.length,e,o,t=0;t<r;t++)f[t].suspendEvents();for(u.loadRecord(n),t=0;t<r;t++)f[t].resumeEvents();for(o=u.isValid(),i.errorSummary&&(o?i.hideToolTip():i.showToolTip()),i.updateButton(o),e=i.query(">displayfield"),r=e.length,t=0;t<r;t++)i.renderColumnData(e[t],n)},renderColumnData:function(n,t,i){var f=this,v=f.editingPlugin.grid,e=v.headerCt,o=f.scrollingView,s=o.dataSource,r=i||n.column,u=t.get(r.dataIndex),h=r.editRenderer||r.renderer,c,l,a;h&&(c={tdCls:"",style:""},l=s.indexOf(t),a=e.getHeaderIndex(r),u=h.call(r.scope||e.ownerCt,u,c,t,l,a,s,o));n.setRawValue(u);n.resetOriginalValue()},beforeEdit:function(){var n=this,t;if(n.isVisible()&&n.errorSummary&&!n.autoCancel&&n.isDirty())return t=n.getScrollDelta(),t&&n.scrollingViewEl.scrollBy(0,t,!0),n.showToolTip(),!1},startEdit:function(n){var t=this,i=t.editingPlugin,r=i.grid,u=t.context=i.context;t.rendered?t.syncFieldsHorizontalScroll():(t.width=t.getClientWidth(),t.render(r.el,r.el.dom.firstChild),t.getFloatingButtons().render(t.el),t.onViewScroll());t.isVisible()?t.reposition(!0):t.show();t.onGridResize();u.grid.getSelectionModel().select(n);t.loadRecord(n)},syncButtonPosition:function(n){var t=this,r=t.getFloatingButtons(),i=t.scrollingViewEl.dom,u=this.getScrollDelta()-(i.scrollHeight-i.scrollTop-i.clientHeight);return u>0?(t._buttonsOnTop||(r.setButtonPosition("top"),t._buttonsOnTop=!0),n=0):t._buttonsOnTop&&(r.setButtonPosition("bottom"),t._buttonsOnTop=!1),n},syncEditorClip:function(){var n=this,t=n.getScrollDelta(),i;t?(n.isOverflowing=!0,i=n.floatingButtons.getHeight(),t>0?n.clipBottom(Math.max(n.getHeight()-t+i,-i)):t<0&&(t=Math.abs(t),n.clipTop(Math.max(t,0)))):n.isOverflowing&&(n.clearClip(),n.isOverflowing=!1)},focusContextCell:function(){var n=this.getEditor(this.context.column);n&&n.focus&&n.focus()},cancelEdit:function(){var r=this,t=r.getForm(),f=t.getFields(),i=f.items,u=i.length,n;for(r.hide(),t.clearInvalid(),n=0;n<u;n++)i[n].suspendEvents();for(t.reset(),n=0;n<u;n++)i[n].resumeEvents()},completeEdit:function(){var n=this,t=n.getForm();return t.isValid()?(t.updateRecord(n.context.record),n.hide(),!0):!1},onShow:function(){var n=this;n.callParent(arguments);n.reposition()},onHide:function(){var n=this;n.callParent(arguments);n.tooltip&&n.hideToolTip();n.context&&(n.context.view.focusRow(n.context.record),n.context=null)},isDirty:function(){var n=this,t=n.getForm();return t.isDirty()},getToolTip:function(){return this.tooltip||(this.tooltip=new Ext.tip.ToolTip({cls:Ext.baseCSSPrefix+"grid-row-editor-errors",title:this.errorsText,autoHide:!1,closable:!0,closeAction:"disable",anchor:"left",anchorToTarget:!1}))},hideToolTip:function(){var n=this,t=n.getToolTip();t.rendered&&t.disable();n.hiddenTip=!1},showToolTip:function(){var n=this,t=n.getToolTip();t.showAt([0,0]);t.update(n.getErrors());n.repositionTip();t.enable()},repositionTip:function(){var n=this,t=n.getToolTip(),e=n.context,i=Ext.get(e.row),r=n.scrollingViewEl,o=r.dom.clientHeight,u=n.lastScrollTop,s=u+o,h=i.getHeight(),f=i.getOffsetsTo(n.context.view.body)[1],c=f+h;c>u&&f<s?(t.showAt(t.getAlignToXY(r,"tl-tr",[15,i.getOffsetsTo(r)[1]])),n.hiddenTip=!1):(t.hide(),n.hiddenTip=!0)},getErrors:function(){for(var n=this,t=[],r=n.query(">[isFormField]"),u=r.length,i=0;i<u;i++)t=t.concat(Ext.Array.map(r[i].getErrors(),n.createErrorListItem));return t.length||n.autoCancel||!n.isDirty()||(t[0]=n.createErrorListItem(n.dirtyText)),'<ul class="'+Ext.plainListCls+'">'+t.join("")+"<\/ul>"},createErrorListItem:function(n){return'<li class="'+Ext.baseCSSPrefix+'grid-row-editor-errors-item">'+n+"<\/li>"},beforeDestroy:function(){Ext.destroy(this.floatingButtons,this.tooltip);this.callParent()},clipBottom:function(n){this.el.setStyle("clip","rect(-1000px auto "+n+"px auto)")},clipTop:function(n){this.el.setStyle("clip","rect("+n+"px auto 1000px auto)")},clearClip:function(){this.el.setStyle("clip",Ext.isIE8m||Ext.isIEQuirks?"rect(-1000px auto 1000px auto)":"auto")}})