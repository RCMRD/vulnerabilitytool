Ext.define("Ext.grid.feature.Grouping",{extend:"Ext.grid.feature.Feature",mixins:{summary:"Ext.grid.feature.AbstractSummary"},requires:["Ext.grid.feature.GroupStore"],alias:"feature.grouping",eventPrefix:"group",groupCls:Ext.baseCSSPrefix+"grid-group-hd",eventSelector:"."+Ext.baseCSSPrefix+"grid-group-hd",refreshData:{},groupInfo:{},wrapsItem:!0,groupHeaderTpl:"{columnName}: {name}",depthToIndent:17,collapsedCls:Ext.baseCSSPrefix+"grid-group-collapsed",hdCollapsedCls:Ext.baseCSSPrefix+"grid-group-hd-collapsed",hdNotCollapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-not-collapsible",collapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-collapsible",ctCls:Ext.baseCSSPrefix+"group-hd-container",groupByText:"Group by this field",showGroupsText:"Show in groups",hideGroupedHeader:!1,startCollapsed:!1,enableGroupingMenu:!0,enableNoGroups:!0,collapsible:!0,expandTip:"Click to expand. CTRL key collapses all others",collapseTip:"Click to collapse. CTRL/click collapses all others",showSummaryRow:!1,tableTpl:{before:function(n){this.groupingFeature.disabled||n.rows.length===1&&n.rows[0].isSummary||this.groupingFeature.setup(n.rows,n.view.rowValues)},after:function(n){this.groupingFeature.disabled||n.rows.length===1&&n.rows[0].isSummary||this.groupingFeature.cleanup(n.rows,n.view.rowValues)},priority:200},groupTpl:["{%","var me = this.groupingFeature;","if (me.disabled) {","values.needsWrap = false;","} else {","me.setupRowData(values.record, values.recordIndex, values);","values.needsWrap = !me.disabled && (values.isFirstRow || values.summaryRecord);","}","%}",'<tpl if="needsWrap">','<tr data-boundView="{view.id}" data-recordId="{record.internalId}" data-recordIndex="{[values.isCollapsedGroup ? -1 : values.recordIndex]}"','class="{[values.itemClasses.join(" ")]} '+Ext.baseCSSPrefix+'grid-wrap-row<tpl if="!summaryRecord"> '+Ext.baseCSSPrefix+'grid-group-row<\/tpl>">','<td class="'+Ext.baseCSSPrefix+'group-hd-container" colspan="{columns.length}">','<tpl if="isFirstRow">',"{%",'var groupTitleStyle = (!values.view.lockingPartner || (values.view.ownerCt === values.view.ownerCt.ownerLockable.lockedGrid) || (values.view.lockingPartner.headerCt.getVisibleGridColumns().length === 0)) ? "" : "visibility:hidden";',"%}",'<div id="{groupId}" class="'+Ext.baseCSSPrefix+'grid-group-hd {collapsibleCls}" tabIndex="0">','<div class="'+Ext.baseCSSPrefix+'grid-group-title" style="{[groupTitleStyle]}">','{[values.groupHeaderTpl.apply(values.groupInfo, parent) || "&#160;"]}',"<\/div>","<\/div>","<\/tpl>",'<tpl if="summaryRecord || !isCollapsedGroup">','<table class="',Ext.baseCSSPrefix,"{view.id}-table ",Ext.baseCSSPrefix,"grid-table",'<tpl if="summaryRecord"> ',Ext.baseCSSPrefix,'grid-table-summary<\/tpl>"','border="0" cellspacing="0" cellpadding="0" style="width:100%">',"{[values.view.renderColumnSizer(out)]}",'<tpl if="!isCollapsedGroup">',"{%","values.itemClasses.length = 0;","this.nextTpl.applyOut(values, out, parent);","%}","<\/tpl>",'<tpl if="summaryRecord">',"{%me.outputSummaryRecord(values.summaryRecord, values, out);%}","<\/tpl>","<\/table>","<\/tpl>","<\/td>","<\/tr>","<tpl else>","{%this.nextTpl.applyOut(values, out, parent);%}","<\/tpl>",{priority:200,syncRowHeights:function(n,t){n=Ext.fly(n,"syncDest");t=Ext.fly(t,"sycSrc");var u=this.owner,f=n.down(u.eventSelector,!0),e,o=n.down(u.summaryRowSelector,!0),s,i,r;f&&(e=t.down(u.eventSelector,!0))&&(f.style.height=e.style.height="",(i=f.offsetHeight)>(r=e.offsetHeight)?Ext.fly(e).setHeight(i):r>i&&Ext.fly(f).setHeight(r));o&&(s=t.down(u.summaryRowSelector,!0))&&(o.style.height=s.style.height="",(i=o.offsetHeight)>(r=s.offsetHeight)?Ext.fly(s).setHeight(i):r>i&&Ext.fly(o).setHeight(r))},syncContent:function(n,t){n=Ext.fly(n,"syncDest");t=Ext.fly(t,"sycSrc");var i=this.owner,r=n.down(i.eventSelector,!0),u=t.down(i.eventSelector,!0),f=n.down(i.summaryRowSelector,!0),e=t.down(i.summaryRowSelector,!0);r&&u&&Ext.fly(r).syncContent(u);f&&e&&Ext.fly(f).syncContent(e)}}],constructor:function(){this.groupCache={};this.callParent(arguments)},init:function(){var n=this,t=n.view;t.isGrouping=!0;n.lockingPartner&&n.lockingPartner.groupCache&&(n.groupCache=n.lockingPartner.groupCache);n.mixins.summary.init.call(n);n.callParent(arguments);t.headerCt.on({columnhide:n.onColumnHideShow,columnshow:n.onColumnHideShow,columnmove:n.onColumnMove,scope:n});t.addTableTpl(n.tableTpl).groupingFeature=n;t.addRowTpl(Ext.XTemplate.getTpl(n,"groupTpl")).groupingFeature=n;t.preserveScrollOnRefresh=!0;t.store.buffered?n.collapsible=!1:n.dataSource=this.lockingPartner&&this.lockingPartner.dataSource?t.dataSource=this.lockingPartner.dataSource:t.dataSource=new Ext.grid.feature.GroupStore(n,t.store);n.grid.on({reconfigure:n.onReconfigure});t.on({afterrender:n.afterViewRender,scope:n,single:!0})},clearGroupCache:function(){var n=this,t=n.groupCache={};return n.lockingPartner&&(n.lockingPartner.groupCache=t),t},vetoEvent:function(n,t,i,r){if(r.type!=="mouseover"&&r.type!=="mouseout"&&r.type!=="mouseenter"&&r.type!=="mouseleave"&&r.getTarget(this.eventSelector))return!1},enable:function(){var n=this,i=n.view,r=i.store,t;n.lastGroupField=n.getGroupField();i.isGrouping=!0;n.lastGroupIndex&&(n.block(),r.group(n.lastGroupIndex),n.unblock());n.callParent();t=n.view.headerCt.getMenu().down("#groupToggleMenuItem");t&&t.setChecked(!0,!0);n.refreshIf()},disable:function(){var n=this,r=n.view,u=r.store,t,i;r.isGrouping=!1;i=u.groupers.first();i&&(n.lastGroupIndex=i.property,n.block(),u.clearGrouping(),n.unblock());n.callParent();t=n.view.headerCt.getMenu().down("#groupToggleMenuItem");t&&t.setChecked(!1,!0);n.refreshIf()},refreshIf:function(){var n=this.grid.ownerCt,t=this.view;t.store.remoteGroup||this.blockRefresh||(n&&n.lockable?n.view.refresh():t.refresh())},afterViewRender:function(){var n=this,t=n.view;t.on({scope:n,groupclick:n.onGroupClick});n.enableGroupingMenu&&n.injectGroupingMenu();n.pruneGroupedHeader();n.lastGroupField=n.getGroupField();n.block();n.onGroupChange();n.unblock()},injectGroupingMenu:function(){var n=this,t=n.view.headerCt;t.showMenuBy=n.showMenuBy;t.getMenuItems=n.getMenuItems()},onColumnHideShow:function(){var t=this.view,i=t.headerCt,e=i.getMenu(),r=e.down("#groupMenuItem"),o=i.getGridColumns().length,u,f,n;if(r&&(i.getVisibleGridColumns().length>1?r.enable():r.disable()),t.rendered)for(u=t.el.query("."+this.ctCls),n=0,f=u.length;n<f;++n)u[n].colSpan=o},onColumnMove:function(){var o=this,n=o.view.store,r,t,e,i,u,f;if(n.isGrouped())for(r=n.getGroups(),e=r.length,t=0;t<e;t++)i=r[t],u=i.children[0],f=i.children[i.children.length-1],n.fireEvent("update",n,u,"edit",null),f!==u&&n.fireEvent("update",n,f,"edit",null)},showMenuBy:function(n,t){var r=this.getMenu(),f=r.down("#groupMenuItem"),e=t.groupable===!1||this.view.headerCt.getVisibleGridColumns().length<2?"disable":"enable",i=r.down("#groupToggleMenuItem"),u=this.view.store.isGrouped();f[e]();i&&(i.setChecked(u,!0),i[u?"enable":"disable"]());Ext.grid.header.Container.prototype.showMenuBy.apply(this,arguments)},getMenuItems:function(){var n=this,t=n.groupByText,i=n.disabled||!n.getGroupField(),r=n.showGroupsText,u=n.enableNoGroups,f=n.view.headerCt.getMenuItems;return function(){var e=f.call(this);return e.push("-",{iconCls:Ext.baseCSSPrefix+"group-by-icon",itemId:"groupMenuItem",text:t,handler:n.onGroupMenuItemClick,scope:n}),u&&e.push({itemId:"groupToggleMenuItem",text:r,checked:!i,checkHandler:n.onGroupToggleMenuItemClick,scope:n}),e}},onGroupMenuItemClick:function(n){var t=this,i=n.parentMenu,r=i.activeHeader,u=t.view,f=u.store;t.lastGroupIndex=null;t.block();t.enable();f.group(r.dataIndex);t.pruneGroupedHeader();t.unblock();t.refreshIf()},block:function(n){this.blockRefresh=this.view.blockRefresh=!0;this.lockingPartner&&!n&&this.lockingPartner.block(!0)},unblock:function(n){this.blockRefresh=this.view.blockRefresh=!1;this.lockingPartner&&!n&&this.lockingPartner.unblock(!0)},onGroupToggleMenuItemClick:function(n,t){this[t?"enable":"disable"]()},pruneGroupedHeader:function(){var n=this,t=n.getGroupedHeader();n.hideGroupedHeader&&t&&(Ext.suspendLayouts(),n.prunedHeader&&n.prunedHeader!==t&&n.prunedHeader.show(),n.prunedHeader=t,t.hide(),Ext.resumeLayouts(!0))},getHeaderNode:function(n){return Ext.get(this.createGroupId(n))},getGroup:function(n){var i=this.groupCache,t=i[n];return t||(t=i[n]={isCollapsed:!1}),t},isExpanded:function(n){return!this.getGroup(n).isCollapsed},expand:function(n,t){this.doCollapseExpand(!1,n,t)},expandAll:function(){var t=this,f=t.view,i=t.groupCache,n,r=t.lockingPartner,u;for(n in i)i.hasOwnProperty(n)&&(i[n].isCollapsed=!1);Ext.suspendLayouts();f.suspendEvent("beforerefresh","refresh");r&&(u=r.view,u.suspendEvent("beforerefresh","refresh"));t.dataSource.onRefresh();f.resumeEvent("beforerefresh","refresh");r&&u.resumeEvent("beforerefresh","refresh");Ext.resumeLayouts(!0);for(n in i)i.hasOwnProperty(n)&&(t.afterCollapseExpand(!1,n),r&&r.afterCollapseExpand(!1,n))},collapse:function(n,t){this.doCollapseExpand(!0,n,t)},isAllCollapsed:function(){var i=this,n=i.groupCache;for(var t in n)if(n.hasOwnProperty(t)&&!n[t].isCollapsed)return!1;return!0},isAllExpanded:function(){var i=this,n=i.groupCache;for(var t in n)if(n.hasOwnProperty(t)&&n[t].isCollapsed)return!1;return!0},collapseAll:function(){var i=this,f=i.view,r=i.groupCache,t,n=i.lockingPartner,u;for(t in r)r.hasOwnProperty(t)&&(r[t].isCollapsed=!0);Ext.suspendLayouts();f.suspendEvent("beforerefresh","refresh");n&&(u=n.view,u.suspendEvent("beforerefresh","refresh"));i.dataSource.onRefresh();f.resumeEvent("beforerefresh","refresh");n&&u.resumeEvent("beforerefresh","refresh");n&&!n.isAllCollapsed()&&n.collapseAll();Ext.resumeLayouts(!0);for(t in r)r.hasOwnProperty(t)&&(i.afterCollapseExpand(!0,t),n&&n.afterCollapseExpand(!0,t))},doCollapseExpand:function(n,t,i){var r=this,f=r.lockingPartner,u=r.groupCache[t];u.isCollapsed!=n&&(Ext.suspendLayouts(),n?r.dataSource.collapseGroup(u):r.dataSource.expandGroup(u),Ext.resumeLayouts(!0),r.afterCollapseExpand(n,t,i),f&&f.afterCollapseExpand(n,t,!1))},afterCollapseExpand:function(n,t,i){var f=this,r=f.view,u;u=Ext.get(this.getHeaderNode(t));r.fireEvent(n?"groupcollapse":"groupexpand",r,u,t);i&&u.up(r.getItemSelector()).scrollIntoView(r.el,null,!0)},onGroupChange:function(){var n=this,i=n.getGroupField(),t,r,u;n.hideGroupedHeader&&(n.lastGroupField&&(t=n.getMenuItem(n.lastGroupField),t&&t.setChecked(!0)),i&&(r=n.view.headerCt.getVisibleGridColumns(),u=r.length===1&&r[0].dataIndex==i,t=n.getMenuItem(i),t&&!u&&t.setChecked(!1)));n.refreshIf();n.lastGroupField=i},getMenuItem:function(n){var t=this.view,i=t.headerCt.down("gridcolumn[dataIndex="+n+"]"),r=t.headerCt.getMenu();return i?r.down("menuitem[headerId="+i.id+"]"):null},onGroupKey:function(n,t){var i=this,r=i.getGroupName(t.target);if(r)i.onGroupClick(i.view,t.target,r,t)},onGroupClick:function(n,t,i,r){var u=this,o=u.groupCache,e=!u.isExpanded(i),f;if(u.collapsible){if(r.ctrlKey){Ext.suspendLayouts();for(f in o)f===i?e&&u.expand(i):u.doCollapseExpand(!0,f,!1);Ext.resumeLayouts(!0);return}e?u.expand(i):u.collapse(i)}},setupRowData:function(n,t,i){var r=this,o=r.refreshData,u=r.groupInfo,h=o.header,e=o.groupField,c=r.view.dataSource,s,f,l,a;if(i.isCollapsedGroup=!1,i.summaryRecord=null,o.doGrouping){if(s=r.view.store.groupers.first(),n.children){f=s.getGroupString(n.children[0]);i.isFirstRow=i.isLastRow=!0;i.itemClasses.push(r.hdCollapsedCls);i.isCollapsedGroup=!0;i.groupInfo=u;u.groupField=e;u.name=f;u.groupValue=n.children[0].get(e);u.columnName=h?h.text:e;i.collapsibleCls=r.collapsible?r.collapsibleCls:r.hdNotCollapsibleCls;i.groupId=r.createGroupId(f);u.rows=u.children=n.children;r.showSummaryRow&&(i.summaryRecord=o.summaryData[f]);return}f=s.getGroupString(n);i.isFirstRow=t===0;i.isFirstRow||(l=c.getAt(t-1),l&&(i.isFirstRow=!l.isEqual(s.getGroupString(l),f)));i.isLastRow=t==c.getTotalCount()-1;i.isLastRow||(a=c.getAt(t+1),a&&(i.isLastRow=!a.isEqual(s.getGroupString(a),f)));i.isFirstRow&&(u.groupField=e,u.name=f,u.groupValue=n.get(e),u.columnName=h?h.text:e,i.collapsibleCls=r.collapsible?r.collapsibleCls:r.hdNotCollapsibleCls,i.groupId=r.createGroupId(f),r.isExpanded(f)||(i.itemClasses.push(r.hdCollapsedCls),i.isCollapsedGroup=!0),u.rows=c.buffered?u.children=[]:u.children=r.getRecordGroup(n).children,i.groupInfo=u);i.isLastRow&&r.showSummaryRow&&(i.summaryRecord=o.summaryData[f])}},setup:function(n,t){var i=this,r=i.refreshData,u=!i.disabled&&i.view.store.isGrouped();i.skippedRows=0;t.view.bufferedRenderer&&(t.view.bufferedRenderer.variableRowHeight=!0);r.groupField=i.getGroupField();r.header=i.getGroupedHeader(r.groupField);r.doGrouping=u;t.groupHeaderTpl=Ext.XTemplate.getTpl(i,"groupHeaderTpl");u&&i.showSummaryRow&&(r.summaryData=i.generateSummaryData())},cleanup:function(n,t){var i=this.refreshData;t.groupInfo=t.groupHeaderTpl=t.isFirstRow=null;i.groupField=i.header=null},getGroupName:function(n){var u=this,f=u.view,e=u.eventSelector,i,t,r;return t=Ext.fly(n).findParent(e),t||(r=Ext.fly(n).findParent(f.itemSelector),r&&(t=r.down(e,!0))),t&&(i=t.id.split(f.id+"-hd-"),i.length===2)?Ext.htmlDecode(i[1]):void 0},getRecordGroup:function(n){var t=this.view.store.groupers.first();if(t)return this.groupCache[t.getGroupString(n)]},createGroupId:function(n){return this.view.id+"-hd-"+Ext.htmlEncode(n)},createGroupCls:function(n){return this.view.id+"-"+Ext.htmlEncode(n)+"-item"},getGroupField:function(){return this.view.store.getGroupField()},getGroupedHeader:function(n){var r=this,f=r.view.headerCt,u=r.lockingPartner,i,t;return n=n||this.getGroupField(),n&&(i="[dataIndex="+n+"]",t=f.down(i),!t&&u&&(t=u.view.headerCt.down(i))),t||null},getFireEventArgs:function(n,t,i,r){return[n,t,i,this.getGroupName(i),r]},destroy:function(){var n=this,t=n.dataSource;n.view=n.prunedHeader=n.grid=n.groupCache=n.dataSource=null;n.callParent();t&&t.bindStore(null)},onReconfigure:function(n,t,i,r){var u=n;t&&t!==r&&(t.buffered!==r.buffered&&Ext.Error.raise("Cannot reconfigure grouping switching between buffered and non-buffered stores"),t.buffered&&(u.bindStore(t),u.dataSource.processStore(t)))}})