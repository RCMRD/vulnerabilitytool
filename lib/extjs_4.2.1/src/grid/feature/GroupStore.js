Ext.define("Ext.grid.feature.GroupStore",{extend:"Ext.util.Observable",isStore:!0,constructor:function(n,t){var i=this;i.superclass.constructor.apply(i,arguments);i.groupingFeature=n;i.bindStore(t);i.processStore(t);i.view.dataSource=i},bindStore:function(n){var t=this;t.store&&(Ext.destroy(t.storeListeners),t.store=null);n&&(t.storeListeners=n.on({bulkremove:t.onBulkRemove,add:t.onAdd,update:t.onUpdate,refresh:t.onRefresh,clear:t.onClear,scope:t,destroyable:!0}),t.store=n)},processStore:function(n){var i=this,e=n.getGroups(),s=e.length,f,t,r,u=i.data,o=i.groupingFeature.groupCache,h=i.groupingFeature.clearGroupCache(),c=i.groupingFeature.startCollapsed;if(u?u.clear():u=i.data=new Ext.util.MixedCollection(!1,Ext.data.Store.recordIdFn),n.getCount())for(i.groupingFeature.startCollapsed=!1,f=0;f<s;f++)t=e[f],h[t.name]=t,t.isCollapsed=c||o[t.name]&&o[t.name].isCollapsed,t.isCollapsed?(t.placeholder=r=new n.model(null,"group-"+t.name+"-placeholder"),r.set(i.getGroupField(),t.name),r.rows=r.children=t.children,r.isCollapsedPlaceholder=!0,u.add(r)):u.insert(i.data.length,t.children)},isCollapsed:function(n){return this.groupingFeature.groupCache[n].isCollapsed},isInCollapsedGroup:function(n){var t;return this.store.isGrouped()&&(t=this.groupingFeature.groupCache[n.get(this.getGroupField())])?t.isCollapsed||!1:!1},getCount:function(){return this.data.getCount()},getTotalCount:function(){return this.data.getCount()},rangeCached:function(n,t){return t<this.getCount()},getRange:function(n,t,i){var r=this.data.getRange(n,t);return i&&i.callback&&i.callback.call(i.scope||this,r,n,t,i),r},getAt:function(n){return this.getRange(n,n)[0]},getById:function(n){return this.store.getById(n)},expandGroup:function(n){var t=this,i;typeof n=="string"&&(n=t.groupingFeature.groupCache[n]);n&&n.children.length&&(i=t.indexOf(n.children[0],!0,!0))!==-1&&(n.isCollapsed=!1,t.isExpandingOrCollapsing=1,t.data.removeAt(i),t.fireEvent("bulkremove",t,[t.getGroupPlaceholder(n)],[i]),t.data.insert(i,n.children),t.fireEvent("add",t,n.children,i),t.fireEvent("groupexpand",t,n),t.isExpandingOrCollapsing=0)},collapseGroup:function(n){var t=this,i,o,r,f,u,e;if(typeof n=="string"&&(n=t.groupingFeature.groupCache[n]),n&&(u=n.children.length)&&(i=t.indexOf(n.children[0],!0))!==-1){for(n.isCollapsed=!0,t.isExpandingOrCollapsing=2,t.data.removeRange(i,u),e=new Array(u),r=0,f=i;r<u;r++,f++)e[r]=f;t.fireEvent("bulkremove",t,n.children,e);t.data.insert(i,o=t.getGroupPlaceholder(n));t.fireEvent("add",t,[o],i);t.fireEvent("groupcollapse",t,n);t.isExpandingOrCollapsing=0}},getGroupPlaceholder:function(n){if(!n.placeholder){var t=n.placeholder=new this.store.model(null,"group-"+n.name+"-placeholder");t.set(this.getGroupField(),n.name);t.rows=t.children=n.children;t.isCollapsedPlaceholder=!0}return n.placeholder},indexOf:function(n,t,i){var f=this,e,o,u,r,s,h=0;if(n&&(i||!f.isInCollapsedGroup(n)))for(e=f.store.getGroups(),o=e.length,u=0;u<o;u++){if(r=e[u],r.name===this.store.getGroupString(n))return s=Ext.Array.indexOf(r.children,n),h+s;h+=t&&f.isCollapsed(r.name)?1:r.children.length}return-1},indexOfTotal:function(n){var t=n.index;return t||t===0?t:this.istore.ndexOf(n)},onRefresh:function(){this.processStore(this.store);this.fireEvent("refresh",this)},onBulkRemove:function(){this.processStore(this.store);this.fireEvent("refresh",this)},onClear:function(){this.processStore(this.store);this.fireEvent("clear",this)},onAdd:function(){this.processStore(this.store);this.fireEvent("refresh",this)},onUpdate:function(n,t,i,r){var u=this,f=u.groupingFeature.getRecordGroup(t),e,o;if(n.isGrouped()){if(r&&Ext.Array.contains(r,u.groupingFeature.getGroupField()))return u.onRefresh(u.store);f.isCollapsed?u.fireEvent("update",u,f.placeholder):(Ext.suspendLayouts(),u.fireEvent("update",u,t,i,r),e=f.children[0],o=f.children[f.children.length-1],e!==t&&u.fireEvent("update",u,e,"edit"),o!==t&&o!==e&&u.fireEvent("update",u,o,"edit"),Ext.resumeLayouts(!0))}else u.fireEvent("update",u,t,i,r)}})