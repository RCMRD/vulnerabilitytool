Ext.define("Ext.grid.plugin.BufferedRenderer",{extend:"Ext.AbstractPlugin",requires:["Ext.grid.plugin.BufferedRendererTableView","Ext.grid.plugin.BufferedRendererTreeView"],alias:"plugin.bufferedrenderer",lockableScope:"both",percentageFromEdge:.35,variableRowHeight:!1,numFromEdge:8,trailingBufferZone:10,leadingBufferZone:20,synchronousRender:!0,scrollToLoadBuffer:200,viewSize:0,rowHeight:21,position:0,lastScrollDirection:1,bodyTop:0,init:function(n){var t=this,i=n.view,r={scroll:{fn:t.onViewScroll,element:"el",scope:t},boxready:t.onViewResize,resize:t.onViewResize,refresh:t.onViewRefresh,scope:t,destroyable:!0};!t.variableRowHeight&&n.ownerLockable&&(n.ownerLockable.syncRowHeight=!1);(n.isTree||n.ownerLockable&&n.ownerLockable.isTree)&&(i.blockRefresh=!1,i.loadMask=!0);i.positionBody&&(r.refresh=t.onViewRefresh);t.grid=n;t.view=i;i.bufferedRenderer=t;i.preserveScrollOnRefresh=!0;t.bindStore(i.dataSource);i.getViewRange=function(){return t.getViewRange()};t.position=0;t.gridListeners=n.on("reconfigure",t.onReconfigure,t);t.viewListeners=i.on(r)},bindStore:function(n){var t=this;if(t.store&&t.unbindStore(),t.storeListeners=n.on({scope:t,clear:t.onStoreClear,destroyable:!0}),t.store=n,t.view.componentLayout.layoutCount)t.onViewResize(t.view,0,t.view.getHeight())},onReconfigure:function(n,t){t&&t!==this.store&&this.bindStore(t)},unbindStore:function(){this.storeListeners.destroy();this.store=null},onStoreClear:function(){var n=this;n.view.rendered&&!n.store.isDestroyed&&(n.scrollTop!==0&&(n.ignoreNextScrollEvent=!0,n.view.el.dom.scrollTop=n.bodyTop=n.scrollTop=0),n.position=n.scrollHeight=0,n.lastScrollDirection=n.scrollOffset=null,delete n.rowHeight)},onViewRefresh:function(){var n=this,t=n.view,r=n.scrollHeight,i;if(t.all.getCount()&&delete n.rowHeight,i=n.getScrollHeight(),r&&i==r||n.stretchView(t,i),n.scrollTop!==t.el.dom.scrollTop)n.onViewScroll();else if(n.setBodyTop(n.bodyTop),t.all.getCount()){n.viewSize=0;n.onViewResize(t,null,t.getHeight())}},onViewResize:function(n,t,i,r,u){if(!u||i!==u){var f=this,e;e=Math.ceil(i/f.rowHeight)+f.trailingBufferZone+f.leadingBufferZone;f.viewSize=f.setViewSize(e)}},stretchView:function(n,t){var i=this,u=i.store.buffered?i.store.getTotalCount():i.store.getCount(),r;i.stretcher?i.stretcher.dom.style.marginTop=t-1+"px":(r=n.el,n.refreshCounter&&n.fixedNodes++,u&&i.view.all.endIndex===u-1&&(t=i.bodyTop+n.body.dom.offsetHeight),this.stretcher=r.createChild({style:{width:"1px",height:"1px",marginTop:t-1+"px",left:0,position:"absolute"}},r.dom.firstChild))},setViewSize:function(n){if(n!==this.viewSize){this.scrollTop=this.view.el.dom.scrollTop;var t=this,i=t.store,e=t.view.all.getCount(),u,f,r=t.lockingPartner;t.viewSize=i.viewSize=n;e&&(u=t.view.all.startIndex,f=Math.min(u+n-1,(i.buffered?i.getTotalCount():i.getCount())-1),r&&r.disable(),t.renderRange(u,f),r&&r.enable())}return n},getViewRange:function(){var n=this,t=n.view.all,i=n.store;return i.data.getCount()?i.getRange(t.startIndex,t.startIndex+(n.viewSize||n.store.defaultViewSize)-1):[]},scrollTo:function(n,t,i,r){var u=this,f=u.view,s=f.el.dom,e=u.store,l=e.buffered?e.getTotalCount():e.getCount(),h,a,c,v,o;n=Math.min(Math.max(n,0),l-1);h=Math.max(Math.min(n-(u.leadingBufferZone+u.trailingBufferZone)/2,l-u.viewSize+1),0);o=h*u.rowHeight;a=Math.min(h+u.viewSize-1,l-1);e.getRange(h,a,{callback:function(h,l,a){u.renderRange(l,a,!0);c=e.data.getRange(n,n)[0];v=f.getNode(c,!1);f.body.dom.style.top=o+"px";u.position=u.scrollTop=s.scrollTop=o=Math.min(Math.max(0,o-f.body.getOffsetsTo(v)[1]),s.scrollHeight-s.clientHeight);Ext.isIE&&(s.scrollTop=o);t&&f.selModel.select(c);i&&i.call(r||u,n,c)}})},onViewScroll:function(){var n=this,t=n.store,e=t.buffered?t.getTotalCount():t.getCount(),i,r,u=n.scrollTop=n.view.el.dom.scrollTop,f=!1;if(n.ignoreNextScrollEvent){n.ignoreNextScrollEvent=!1;return}n.disabled||e<n.viewSize||(i=u-n.position,r=i>0?1:-1,(Math.abs(i)>=20||r!==n.lastScrollDirection)&&(n.lastScrollDirection=r,n.handleViewScroll(n.lastScrollDirection),f=!0));f||n.lockingPartner&&n.lockingPartner.scrollTop!==u&&(n.lockingPartner.view.el.dom.scrollTop=u)},handleViewScroll:function(n){var t=this,i=t.view.all,u=t.store,e=t.viewSize,o=u.buffered?u.getTotalCount():u.getCount(),r,f;if(n==-1?i.startIndex&&t.getFirstVisibleRowIndex()-i.startIndex<t.numFromEdge&&(r=Math.max(0,t.getLastVisibleRowIndex()+t.trailingBufferZone-e)):i.endIndex<o-1&&i.endIndex-t.getLastVisibleRowIndex()<t.numFromEdge&&(r=Math.max(0,t.getFirstVisibleRowIndex()-t.trailingBufferZone)),r!=null&&(f=Math.min(r+e-1,o-1),r!==i.startIndex||f!==i.endIndex)){t.renderRange(r,f);return}t.lockingPartner&&t.lockingPartner.view.el&&t.lockingPartner.scrollTop!==t.scrollTop&&(t.lockingPartner.view.el.dom.scrollTop=t.scrollTop)},renderRange:function(n,t,i){var r=this,u=r.store;if(u.rangeCached(n,t))if(r.cancelLoad(),r.synchronousRender||i)r.onRangeFetched(null,n,t);else r.renderTask||(r.renderTask=new Ext.util.DelayedTask(r.onRangeFetched,r,null,!1)),r.renderTask.delay(1,null,null,[null,n,t]);else r.attemptLoad(n,t)},onRangeFetched:function(n,t,i,r){var f=this,s=f.view,l,u=s.all,e,a=0,h=t*f.rowHeight,c,o=f.lockingPartner;if(!s.isDestroyed&&(n||(n=f.store.getRange(t,i),n))&&((t>u.endIndex||i<u.startIndex)&&(u.clear(!0),c=h),u.getCount()?i>u.endIndex?(e=Math.max(t-u.startIndex,0),f.variableRowHeight&&(a=u.item(u.startIndex+e,!0).offsetTop),u.scroll(Ext.Array.slice(n,u.endIndex+1-t),1,e,t,i),c=f.variableRowHeight?f.bodyTop+a:h):(e=Math.max(u.endIndex-i,0),l=u.startIndex,u.scroll(Ext.Array.slice(n,0,u.startIndex-t),-1,e,t,i),c=f.variableRowHeight?f.bodyTop-u.item(l,!0).offsetTop:h):s.doAdd(n,t),f.position=f.scrollTop,s.positionBody&&f.setBodyTop(c,h),o&&!o.disabled&&!r)){o.onRangeFetched(n,t,i,!0);o.scrollTop!==f.scrollTop&&(o.view.el.dom.scrollTop=f.scrollTop)}},setBodyTop:function(n,t){var i=this,r=i.view,u=i.store,f=r.body.dom,e;n=Math.floor(n);t!==undefined&&(e=n-t,n=t);f.style.position="absolute";f.style.top=(i.bodyTop=n)+"px";e&&(i.scrollTop=i.position=r.el.dom.scrollTop-=e);r.all.endIndex===(u.buffered?u.getTotalCount():u.getCount())-1&&i.stretchView(r,i.bodyTop+f.offsetHeight)},getFirstVisibleRowIndex:function(n,t,i,r){var u=this,o=u.view,e=o.all,h=e.elements,c=o.el.dom.clientHeight,f,s;if(e.getCount()&&u.variableRowHeight){if(arguments.length)f=n+Math.floor((t-n)/2);else{if(n=e.startIndex,t=e.endIndex,i=u.scrollTop,r=i+c,u.bodyTop>r||u.bodyTop+o.body.getHeight()<i)return Math.floor(u.scrollTop/u.rowHeight);f=n+Math.min(u.numFromEdge+(u.lastScrollDirection==-1?u.leadingBufferZone:u.trailingBufferZone),Math.floor((t-n)/2))}if(s=u.bodyTop+h[f].offsetTop,s+h[f].offsetHeight<i)return u.getFirstVisibleRowIndex(f+1,t,i,r);if(s<=i)return f;if(f!==n)return u.getFirstVisibleRowIndex(n,f-1,i,r)}return Math.floor(u.scrollTop/u.rowHeight)},getLastVisibleRowIndex:function(n,t,i,r){var u=this,o=u.view,e=o.all,c=e.elements,s=o.el.dom.clientHeight,f,h,l;if(e.getCount()&&u.variableRowHeight){if(arguments.length)f=n+Math.floor((t-n)/2);else{if(n=e.startIndex,t=e.endIndex,i=u.scrollTop,r=i+s,u.bodyTop>r||u.bodyTop+o.body.getHeight()<i)return Math.floor(u.scrollTop/u.rowHeight)+Math.ceil(s/u.rowHeight);f=t-Math.min(u.numFromEdge+(u.lastScrollDirection==1?u.leadingBufferZone:u.trailingBufferZone),Math.floor((t-n)/2))}if(h=u.bodyTop+c[f].offsetTop,h>r)return u.getLastVisibleRowIndex(n,f-1,i,r);if(l=h+c[f].offsetHeight,l>=r)return f;if(f!==t)return u.getLastVisibleRowIndex(f+1,t,i,r)}return u.getFirstVisibleRowIndex()+Math.ceil(s/u.rowHeight)},getScrollHeight:function(){var n=this,t=n.view,i=n.store,r=!n.hasOwnProperty("rowHeight"),u=n.store.getCount();return u?(r&&t.all.getCount()&&(n.rowHeight=Math.floor(t.body.getHeight()/t.all.getCount())),this.scrollHeight=Math.floor((i.buffered?i.getTotalCount():i.getCount())*n.rowHeight)):0},attemptLoad:function(n,t){var i=this;i.scrollToLoadBuffer?(i.loadTask||(i.loadTask=new Ext.util.DelayedTask(i.doAttemptLoad,i,[])),i.loadTask.delay(i.scrollToLoadBuffer,i.doAttemptLoad,i,[n,t])):i.store.getRange(n,t,{callback:i.onRangeFetched,scope:i,fireEvent:!1})},cancelLoad:function(){this.loadTask&&this.loadTask.cancel()},doAttemptLoad:function(n,t){this.store.getRange(n,t,{callback:this.onRangeFetched,scope:this,fireEvent:!1})},destroy:function(){var n=this,t=n.view;t&&t.el&&t.el.un("scroll",n.onViewScroll,n);Ext.destroy(n.viewListeners,n.storeListeners,n.gridListeners)}})