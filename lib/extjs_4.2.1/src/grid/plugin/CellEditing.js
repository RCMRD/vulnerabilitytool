Ext.define("Ext.grid.plugin.CellEditing",{alias:"plugin.cellediting",extend:"Ext.grid.plugin.Editing",requires:["Ext.grid.CellEditor","Ext.util.DelayedTask"],lockableScope:"both",init:function(){var t=this,n=t.lockingPartner;t.callParent(arguments);t.editors=n?n.editors?n.editors:n.editors=new Ext.util.MixedCollection(!1,function(n){return n.editorId}):new Ext.util.MixedCollection(!1,function(n){return n.editorId})},onReconfigure:function(n,t,i){i&&this.editors.clear();this.callParent()},destroy:function(){var n=this;n.editors&&(n.editors.each(Ext.destroy,Ext),n.editors.clear());n.callParent(arguments)},onBodyScroll:function(){var t=this,n=t.getActiveEditor(),i=t.view.el.getScroll();n&&n.editing&&n.editingPlugin===t&&(i.top!==t.scroll.top?n.field&&(n.field.triggerBlur?n.field.triggerBlur():n.field.blur()):n.realign());t.scroll=i},initCancelTriggers:function(){var n=this,t=n.grid,i=t.view;n.mon(i,"bodyscroll",n.onBodyScroll,n);n.mon(t,{columnresize:n.cancelEdit,columnmove:n.cancelEdit,scope:n})},isCellEditable:function(n,t){var i=this,r=i.getEditingContext(n,t);if(i.grid.view.isVisible(!0)&&r&&(t=r.column,n=r.record,t&&i.getEditor(n,t)))return!0},startEdit:function(n,t,i){var r=this,u;return!i&&(r.preventBeforeCheck=!0,i=r.callParent(arguments),delete r.preventBeforeCheck,i===!1)?!1:i&&r.grid.view.isVisible(!0)?(n=i.record,t=i.column,r.completeEdit(),t&&!t.getEditor(n))?!1:(r.context=i,i.originalValue=i.value=n.get(t.dataIndex),r.beforeEdit(i)===!1||r.fireEvent("beforeedit",r,i)===!1||i.cancel)?!1:(u=r.getEditor(n,t),r.grid.view.cancelFocus(),r.view.scrollCellIntoView(r.getCell(n,t)),u)?(r.showEditor(u,i,i.value),!0):!1:void 0},showEditor:function(n,t,i){var r=this,e=t.record,o=t.column,f=r.grid.getSelectionModel(),u=f.getCurrentPosition(),s=u&&u.view;if(s&&s!==r.view)return r.lockingPartner.showEditor(n,r.lockingPartner.getEditingContext(u.record,u.columnHeader),i);r.setEditingContext(t);r.setActiveEditor(n);r.setActiveRecord(e);r.setActiveColumn(o);f.selectByPosition&&(!u||u.column!==t.colIdx||u.row!==t.rowIdx)&&f.selectByPosition({row:t.rowIdx,column:t.colIdx,view:r.view});n.startEdit(r.getCell(e,o),i,t);r.editing=!0;r.scroll=r.view.el.getScroll()},completeEdit:function(){var n=this.getActiveEditor();n&&(n.completeEdit(),this.editing=!1)},setEditingContext:function(n){this.context=n;this.lockingPartner&&(this.lockingPartner.context=n)},setActiveEditor:function(n){this.activeEditor=n;this.lockingPartner&&(this.lockingPartner.activeEditor=n)},getActiveEditor:function(){return this.activeEditor},setActiveColumn:function(n){this.activeColumn=n;this.lockingPartner&&(this.lockingPartner.activeColumn=n)},getActiveColumn:function(){return this.activeColumn},setActiveRecord:function(n){this.activeRecord=n;this.lockingPartner&&(this.lockingPartner.activeRecord=n)},getActiveRecord:function(){return this.activeRecord},getEditor:function(n,t){var r=this,u=r.editors,f=t.getItemId(),i=u.getByKey(f),e=r.grid.ownerLockable||r.grid;if(!i){if(i=t.getEditor(n),!i)return!1;i instanceof Ext.grid.CellEditor?i.floating=!0:i=new Ext.grid.CellEditor({floating:!0,editorId:f,field:i});e.add(i);i.on({scope:r,specialkey:r.onSpecialKey,complete:r.onEditComplete,canceledit:r.cancelEdit});t.on("removed",r.cancelActiveEdit,r);u.add(i)}return t.isTreeColumn&&(i.isForTree=t.isTreeColumn,i.addCls(Ext.baseCSSPrefix+"tree-cell-editor")),i.grid=r.grid,i.editingPlugin=r,i},cancelActiveEdit:function(n){var t=this.context;t&&t.column===n&&this.cancelEdit()},setColumnField:function(n){var t=this.editors.getByKey(n.getItemId());Ext.destroy(t,n.field);this.editors.removeAtKey(n.getItemId());this.callParent(arguments)},getCell:function(n,t){return this.grid.getView().getCell(n,t)},onSpecialKey:function(n,t,i){var r;if(i.getKey()===i.TAB){if(i.stopEvent(),n)n.onEditorTab(i);if(r=n.up("tablepanel").getSelectionModel(),r.onEditorTab)return r.onEditorTab(n.editingPlugin,i)}},onEditComplete:function(n,t,i){var r=this,e=r.getActiveColumn(),u=r.context,f;if(e){if(f=u.record,r.setActiveEditor(null),r.setActiveColumn(null),r.setActiveRecord(null),u.value=t,!r.validateEdit())return;f.isEqual(t,i)||f.set(e.dataIndex,t);u.view.focus(!1,!0);r.fireEvent("edit",r,u);r.editing=!1}},cancelEdit:function(){var n=this,t=n.getActiveEditor();if(n.setActiveEditor(null),n.setActiveColumn(null),n.setActiveRecord(null),t){t.cancelEdit();n.context.view.focus();n.callParent(arguments);return}return!0},startEditByPosition:function(n){return n.isCellContext||(n=new Ext.grid.CellContext(this.view).setPosition(n)),n.setColumn(this.view.getHeaderCt().getVisibleHeaderClosestToIndex(n.column).getIndex()),this.startEdit(n.record,n.columnHeader)}})