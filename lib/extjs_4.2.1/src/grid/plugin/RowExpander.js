Ext.define("Ext.grid.plugin.RowExpander",{extend:"Ext.AbstractPlugin",lockableScope:"normal",requires:["Ext.grid.feature.RowBody","Ext.grid.feature.RowWrap"],alias:"plugin.rowexpander",rowBodyTpl:null,expandOnEnter:!0,expandOnDblClick:!0,selectRowOnExpand:!1,rowBodyTrSelector:".x-grid-rowbody-tr",rowBodyHiddenCls:"x-grid-row-body-hidden",rowCollapsedCls:"x-grid-row-collapsed",addCollapsedCls:{before:function(n){var t=this.rowExpander;t.recordsExpanded[n.record.internalId]||n.itemClasses.push(t.rowCollapsedCls)},priority:500},setCmp:function(n){var t=this,r,i;t.callParent(arguments);t.recordsExpanded={};t.rowBodyTpl||Ext.Error.raise("The 'rowBodyTpl' config is required and is not defined.");t.rowBodyTpl=Ext.XTemplate.getTpl(t,"rowBodyTpl");r=this.rowBodyTpl;i=[{ftype:"rowbody",lockableScope:"normal",recordsExpanded:t.recordsExpanded,rowBodyHiddenCls:t.rowBodyHiddenCls,rowCollapsedCls:t.rowCollapsedCls,setupRowData:t.getRowBodyFeatureData,setup:t.setup,getRowBodyContents:function(n){return r.applyTemplate(n.getData())}},{ftype:"rowwrap",lockableScope:"normal"}];n.features=n.features?Ext.Array.push(i,n.features):i},init:function(n){var t=this,i=n,r,u;t.callParent(arguments);t.grid=n;r=t.view=n.getView();t.addExpander();t.bindView(r);r.addRowTpl(t.addCollapsedCls).rowExpander=t;n.ownerLockable&&(i=n.ownerLockable,i.syncRowHeight=!1,u=i.lockedGrid.getView(),t.bindView(u),u.addRowTpl(t.addCollapsedCls).rowExpander=t,i.mon(i,"columnschanged",t.refreshRowHeights,t),i.mon(i.store,"datachanged",t.refreshRowHeights,t));i.on("beforereconfigure",t.beforeReconfigure,t);if(n.ownerLockable&&!n.rowLines)r.on("rowfocus",t.refreshRowHeights,t)},beforeReconfigure:function(n,t,i){var r=this.getHeaderConfig();r.locked=!0;i.unshift(r)},addExpander:function(){var t=this,n=t.grid,i=t.getHeaderConfig();n.ownerLockable&&(n=n.ownerLockable.lockedGrid,n.width+=i.width);n.headerCt.insert(0,i)},getRowBodyFeatureData:function(n,t,i){var r=this;r.self.prototype.setupRowData.apply(r,arguments);i.rowBody=r.getRowBodyContents(n);i.rowBodyCls=r.recordsExpanded[n.internalId]?"":r.rowBodyHiddenCls},setup:function(n,t){var i=this;i.self.prototype.setup.apply(i,arguments);i.grid.ownerLockable||(t.rowBodyColspan-=1)},bindView:function(n){if(this.expandOnEnter)n.on("itemkeydown",this.onKeyDown,this);if(this.expandOnDblClick)n.on("itemdblclick",this.onDblClick,this)},onKeyDown:function(n,t,i,r,u){if(u.getKey()==u.ENTER)for(var o=n.store,e=n.getSelectionModel().getSelection(),s=e.length,f=0;f<s;f++)r=o.indexOf(e[f]),this.toggleRow(r,e[f])},onDblClick:function(n,t,i,r){this.toggleRow(r,t)},toggleRow:function(n,t){var i=this,u=i.view,l=u.getNode(n),r=Ext.fly(l,"_rowExpander"),h=r.down(i.rowBodyTrSelector,!0),f=r.hasCls(i.rowCollapsedCls),e=f?"removeCls":"addCls",o,c,s;Ext.suspendLayouts();r[e](i.rowCollapsedCls);Ext.fly(h)[e](i.rowBodyHiddenCls);i.recordsExpanded[t.internalId]=f;u.refreshSize();i.grid.ownerLockable?(o=i.grid.ownerLockable,s=o.getView(),u=o.lockedGrid.view,c=r.getHeight(),r=Ext.fly(u.getNode(n),"_rowExpander"),r.setHeight(c),r[e](i.rowCollapsedCls),u.refreshSize()):s=u;s.fireEvent(f?"expandbody":"collapsebody",r.dom,t,h);Ext.resumeLayouts(!0)},refreshRowHeights:function(){Ext.globalEvents.on({idle:this.doRefreshRowHeights,scope:this,single:!0})},doRefreshRowHeights:function(){var u=this,o=u.recordsExpanded,f,e,s=u.grid.ownerLockable.lockedGrid.view,h=u.grid.ownerLockable.normalGrid.view,n,t,i,r;for(f in o)o.hasOwnProperty(f)&&(e=this.view.store.data.get(f),t=s.getNode(e,!1),n=h.getNode(e,!1),t.style.height=n.style.height="",i=t.offsetHeight,r=n.offsetHeight,r>i?t.style.height=r+"px":i>r&&(n.style.height=i+"px"))},getHeaderConfig:function(){var n=this;return{width:24,lockable:!1,sortable:!1,resizable:!1,draggable:!1,hideable:!1,menuDisabled:!0,tdCls:Ext.baseCSSPrefix+"grid-cell-special",innerCls:Ext.baseCSSPrefix+"grid-cell-inner-row-expander",renderer:function(t,i){return n.grid.ownerLockable||(i.tdAttr+=' rowspan="2"'),'<div class="'+Ext.baseCSSPrefix+'grid-row-expander"><\/div>'},processEvent:function(t,i,r,u,f,e,o){if(t=="mousedown"&&e.getTarget(".x-grid-row-expander"))return n.toggleRow(u,o),n.selectRowOnExpand}}}})