Ext.define("Ext.grid.plugin.Editing",{alias:"editing.editing",extend:"Ext.AbstractPlugin",requires:["Ext.grid.column.Column","Ext.util.KeyNav"],mixins:{observable:"Ext.util.Observable"},clicksToEdit:2,triggerEvent:undefined,relayedEvents:["beforeedit","edit","validateedit","canceledit"],defaultFieldXType:"textfield",editStyle:"",constructor:function(){var n=this;n.addEvents("beforeedit","edit","validateedit","canceledit");n.callParent(arguments);n.mixins.observable.constructor.call(n);n.on("edit",function(t,i){n.fireEvent("afteredit",t,i)})},init:function(n){var t=this;t.grid=n;t.view=n.view;t.initEvents();t.mon(n,{reconfigure:t.onReconfigure,scope:t,beforerender:{fn:t.onReconfigure,single:!0,scope:t}});n.relayEvents(t,t.relayedEvents);t.grid.ownerLockable&&t.grid.ownerLockable.relayEvents(t,t.relayedEvents);n.isEditable=!0;n.editingPlugin=n.view.editingPlugin=t},onReconfigure:function(){var n=this.grid;n=n.ownerLockable?n.ownerLockable:n;this.initFieldAccessors(n.getView().getGridColumns())},destroy:function(){var n=this,t=n.grid;Ext.destroy(n.keyNav);n.clearListeners();t&&(n.removeFieldAccessors(t.columnManager.getColumns()),t.editingPlugin=t.view.editingPlugin=n.grid=n.view=n.editor=n.keyNav=null)},getEditStyle:function(){return this.editStyle},initFieldAccessors:function(n){n.isGroupHeader?n=n.getGridColumns():Ext.isArray(n)||(n=[n]);for(var r=this,u=n.length,t,i=0;i<u;i++)t=n[i],t.getEditor||(t.getEditor=function(n,t){return r.getColumnField(this,t)}),t.hasEditor||(t.hasEditor=function(){return r.hasColumnField(this)}),t.setEditor||(t.setEditor=function(n){r.setColumnField(this,n)})},removeFieldAccessors:function(n){n.isGroupHeader?n=n.getGridColumns():Ext.isArray(n)||(n=[n]);for(var r=n.length,i,t=0;t<r;t++)i=n[t],i.getEditor=i.hasEditor=i.setEditor=null},getColumnField:function(n,t){var i=n.field;return i&&i.isFormField||(i=n.field=this.createColumnField(n,t)),i},hasColumnField:function(n){return!!n.field},setColumnField:function(n,t){n.field=t;n.field=this.createColumnField(n)},createColumnField:function(n,t){var i=n.field;return!i&&n.editor&&(i=n.editor,n.editor=null),!i&&t&&(i=t),i&&(i.isFormField?i.column=n:(i=Ext.isString(i)?{name:n.dataIndex,xtype:i,column:n}:Ext.apply({name:n.dataIndex,column:n},i),i=Ext.ComponentManager.create(i,this.defaultFieldXType)),n.field=i),i},initEvents:function(){var n=this;n.initEditTriggers();n.initCancelTriggers()},initCancelTriggers:Ext.emptyFn,initEditTriggers:function(){var n=this,t=n.view;n.triggerEvent=="cellfocus"?n.mon(t,"cellfocus",n.onCellFocus,n):n.triggerEvent=="rowfocus"?n.mon(t,"rowfocus",n.onRowFocus,n):(t.getSelectionModel().isCellModel&&(t.onCellFocus=Ext.Function.bind(n.beforeViewCellFocus,n)),n.mon(t,n.triggerEvent||"cell"+(n.clicksToEdit===1?"click":"dblclick"),n.onCellClick,n));n.initAddRemoveHeaderEvents();t.on("render",n.initKeyNavHeaderEvents,n,{single:!0})},beforeViewCellFocus:function(n){!this.view.selModel.keyNavigation&&this.editing&&this.isCellEditable&&this.isCellEditable(n.row,n.columnHeader)||this.view.focusCell.apply(this.view,arguments)},onRowFocus:function(n,t){this.startEdit(t,0)},onCellFocus:function(n,t,i){this.startEdit(i.row,i.column)},onCellClick:function(n,t,i,r,u,f,e){n.expanderSelector&&e.getTarget(n.expanderSelector)||this.startEdit(r,n.ownerCt.columnManager.getHeaderAtIndex(i))},initAddRemoveHeaderEvents:function(){var n=this;n.mon(n.grid.headerCt,{scope:n,add:n.onColumnAdd,remove:n.onColumnRemove,columnmove:n.onColumnMove})},initKeyNavHeaderEvents:function(){var n=this;n.keyNav=Ext.create("Ext.util.KeyNav",n.view.el,{enter:n.onEnterKey,esc:n.onEscKey,scope:n})},onColumnAdd:function(n,t){this.initFieldAccessors(t)},onColumnRemove:function(n,t){this.removeFieldAccessors(t)},onColumnMove:function(n,t){this.initFieldAccessors(t)},onEnterKey:function(){var u=this,f=u.grid,i=f.getSelectionModel(),n,r,t;i.getCurrentPosition&&(r=i.getCurrentPosition())?(n=r.record,t=r.columnHeader):(n=i.getLastSelected(),t=f.columnManager.getHeaderAtIndex(0));n&&t&&u.startEdit(n,t)},onEscKey:function(){return this.cancelEdit()},beforeEdit:Ext.emptyFn,startEdit:function(n,t){var i=this,r,u=i.grid.lockable?i.grid:i.view;if(!u.componentLayoutCounter){u.on({boxready:Ext.Function.bind(i.startEdit,i,[n,t]),single:!0});return!1}return i.grid.collapsed||!i.grid.view.isVisible(!0)?!1:(r=i.getEditingContext(n,t),r==null)?!1:!i.preventBeforeCheck&&(i.beforeEdit(r)===!1||i.fireEvent("beforeedit",i,r)===!1||r.cancel)?!1:(i.editing=!0,r)},getEditingContext:function(n,t){var f=this,e=f.grid,i=f.view,r=i.getNode(n,!0),u,o;if(r)return(t=e.columnManager.getVisibleHeaderClosestToIndex(Ext.isNumber(t)?t:t.getVisibleIndex()),!t)?void 0:(o=t.getVisibleIndex(),Ext.isNumber(n)?(u=n,n=i.getRecord(r)):u=i.indexOf(r),!n)?void 0:{grid:e,view:i,store:i.dataSource,record:n,field:t.dataIndex,value:n.get(t.dataIndex),row:r,column:t,rowIdx:u,colIdx:o}},cancelEdit:function(){var n=this;n.editing=!1;n.fireEvent("canceledit",n,n.context)},completeEdit:function(){var n=this;n.editing&&n.validateEdit()&&n.fireEvent("edit",n,n.context);n.context=null;n.editing=!1},validateEdit:function(){var n=this,t=n.context;return n.fireEvent("validateedit",n,t)!==!1&&!t.cancel}})