Ext.define("Ext.grid.header.DropZone",{extend:"Ext.dd.DropZone",colHeaderCls:Ext.baseCSSPrefix+"column-header",proxyOffsets:[-4,-9],constructor:function(n){this.headerCt=n;this.ddGroup=this.getDDGroup();this.callParent([n.el])},getDDGroup:function(){return"header-dd-zone-"+this.headerCt.up("[scrollerOwner]").id},getTargetFromEvent:function(n){return n.getTarget("."+this.colHeaderCls)},getTopIndicator:function(){return this.topIndicator||(this.self.prototype.topIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-top",html:"&#160;"},!0),this.self.prototype.indicatorXOffset=Math.floor((this.topIndicator.dom.offsetWidth+1)/2)),this.topIndicator},getBottomIndicator:function(){return this.bottomIndicator||(this.self.prototype.bottomIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-bottom",html:"&#160;"},!0)),this.bottomIndicator},getLocation:function(n,t){var u=n.getXY()[0],i=Ext.fly(t).getRegion(),r;return r=i.right-u<=(i.right-i.left)/2?"after":"before",{pos:r,header:Ext.getCmp(t.id),node:t}},positionIndicator:function(n,t,i){var r=this,e=n.header,y=r.getLocation(i,t),u=y.header,f=y.pos,g,nt,o,s,p,w,h,c,l,b,k,d,tt,a,v;if(u!==r.lastTargetHeader||f!==r.lastDropPos){if(g=e.nextSibling("gridcolumn:not([hidden])"),nt=e.previousSibling("gridcolumn:not([hidden])"),r.lastTargetHeader=u,r.lastDropPos=f,!u.draggable&&f==="before"&&u.getIndex()===0)return!1;if(n.dropLocation=y,e===u||(f!=="before"||g===u)&&(f!=="after"||nt===u)||u.isDescendantOf(e))r.invalidateDrop();else{for(d=Ext.dd.DragDropManager.getRelated(r),tt=d.length,a=0;a<tt;a++)v=d[a],v!==r&&v.invalidateDrop&&v.invalidateDrop();r.valid=!0;o=r.getTopIndicator();s=r.getBottomIndicator();f==="before"?(p="bc-tl",w="tc-bl"):(p="bc-tr",w="tc-br");h=o.getAlignToXY(u.el,p);c=s.getAlignToXY(u.el,w);l=r.headerCt.el;b=l.getX()-r.indicatorXOffset;k=l.getX()+l.getWidth();h[0]=Ext.Number.constrain(h[0],b,k);c[0]=Ext.Number.constrain(c[0],b,k);o.setXY(h);s.setXY(c);o.show();s.show()}}},invalidateDrop:function(){this.valid=!1;this.hideIndicators()},onNodeOver:function(n,t,i,r){var u=this,e=r.header,f,o,s,h;return r.header.el.dom===n?f=!1:(r.isLock=r.isUnlock=!1,o=u.getLocation(i,n).header,f=e.ownerCt===o.ownerCt,f||e.ownerCt.sealed||o.ownerCt.sealed||(f=!0,s=e.up("tablepanel"),h=o.up("tablepanel"),r.isLock=h.isLocked&&!s.isLocked,r.isUnlock=!h.isLocked&&s.isLocked,(r.isUnlock&&e.lockable===!1||r.isLock&&!e.isLockable())&&(f=!1))),f?u.positionIndicator(r,n,i):u.valid=!1,u.valid?u.dropAllowed:u.dropNotAllowed},hideIndicators:function(){var n=this;n.getTopIndicator().hide();n.getBottomIndicator().hide();n.lastTargetHeader=n.lastDropPos=null},onNodeOut:function(){this.hideIndicators()},onNodeDrop:function(n,t,i,r){if(this.valid){var u=r.header,y=r.dropLocation,e=y.header,o=u.ownerCt,l=o.items.indexOf(u),s=e.ownerCt,f=s.items.indexOf(e),h=this.headerCt,p=h.columnManager,w=p.getHeaderIndex(u),a=p.getHeaderIndex(e),b=u.isGroupHeader?u.query(":not([isGroupHeader])").length:1,v=o===s,c,k;if(y.pos==="after"&&(f++,a+=e.isGroupHeader?e.query(":not([isGroupHeader])").length:1),r.isLock){c=o.up("[scrollerOwner]");c.lock(u,f);r.isLock=!1;this.onNodeDrop(n,t,i,r)}else if(r.isUnlock){c=o.up("[scrollerOwner]");c.unlock(u,f);r.isUnlock=!1;this.onNodeDrop(n,t,i,r)}else{if(this.invalidateDrop(),k=u.getWidth(),v){if(f===l){h.onHeaderMoved(u,b,w,a);return}f>l&&(f-=1)}Ext.suspendLayouts();v?s.move(l,f):(o.remove(u,!1),s.insert(f,u));s.isGroupHeader?v||(u.savedFlex=u.flex,delete u.flex,u.width=k):u.savedFlex&&(u.flex=u.savedFlex,delete u.width);h.purgeCache();Ext.resumeLayouts(!0);h.onHeaderMoved(u,b,w,a)}}}})